<% content_for :title, "Farms" %>

<div class="farms-dashboard">
  <section class="farms-hero">
    <div class="hero-copy">
      <div class="hero-kicker">Operations Hub</div>
      <h1 class="hero-title">Farm Control Center</h1>
      <p class="hero-subtitle">Track herd health, production, and performance across every location.</p>
      <div class="hero-meta">
        <span class="meta-pill"><i class="bi bi-shield-check"></i>Verified data</span>
        <span class="meta-pill"><i class="bi bi-speedometer2"></i>Live insights</span>
        <span class="meta-pill"><i class="bi bi-clipboard-data"></i>Unified records</span>
      </div>
    </div>
    <div class="hero-actions">
      <%= link_to new_farm_path, class: "btn btn-cta" do %>
        <i class="bi bi-plus-circle"></i>New Farm
      <% end %>
      <div class="btn-group">
        <button class="btn btn-ghost dropdown-toggle" data-bs-toggle="dropdown">
          <i class="bi bi-three-dots"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li>
            <a class="dropdown-item" href="#" id="exportFarms">
              <i class="bi bi-download me-2"></i>Export Data
            </a>
          </li>
          <li><hr class="dropdown-divider"></li>
          <li>
            <%= link_to root_path, class: "dropdown-item" do %>
              <i class="bi bi-house me-2"></i>Dashboard
            <% end %>
          </li>
        </ul>
      </div>
    </div>
  </section>

  <% if @farms.any? %>
    <section class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-icon"><i class="bi bi-house-door"></i></div>
        <div>
          <div class="kpi-value"><%= @farms.count %></div>
          <div class="kpi-label">Active farms</div>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon"><i class="bi bi-emoji-smile"></i></div>
        <div>
          <div class="kpi-value"><%= @total_cows %></div>
          <div class="kpi-label">Total cows</div>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon"><i class="bi bi-droplet"></i></div>
        <div>
          <div class="kpi-value"><%= number_with_precision(@farms.sum { |f| f.today_production }, precision: 1) %>L</div>
          <div class="kpi-label">Today production</div>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon"><i class="bi bi-graph-up"></i></div>
        <div>
          <div class="kpi-value"><%= number_with_precision(@farms.any? ? @farms.sum { |f| f.today_production } / @farms.count : 0, precision: 1) %>L</div>
          <div class="kpi-label">Average per farm</div>
        </div>
      </div>
    </section>

    <section class="filter-bar">
      <div class="filter-search">
        <i class="bi bi-search"></i>
        <input type="text" class="form-control" id="farmSearch" placeholder="Search by name, owner, or location">
      </div>
      <div class="filter-controls">
        <select class="form-select" id="farmSort">
          <option value="name">Sort by Name</option>
          <option value="cows">Sort by Cow Count</option>
          <option value="production">Sort by Production</option>
          <option value="location">Sort by Location</option>
        </select>
        <div class="view-toggle btn-group" role="group">
          <button type="button" class="btn btn-outline-secondary active" id="gridView">
            <i class="bi bi-grid"></i>
          </button>
          <button type="button" class="btn btn-outline-secondary" id="listView">
            <i class="bi bi-list"></i>
          </button>
        </div>
      </div>
    </section>

    <div class="farms-container grid-view" id="gridViewContainer">
      <div class="row g-4" id="farmsGrid">
        <% @farms.each do |farm| %>
          <div class="col-xl-4 col-lg-6 col-md-6 farm-item"
               data-name="<%= farm.name&.downcase %>"
               data-owner="<%= farm.owner&.downcase %>"
               data-location="<%= farm.location&.downcase %>"
               data-cows="<%= farm.total_cows %>"
               data-production="<%= farm.today_production %>">
            <div class="farm-card" data-farm-id="<%= farm.id %>">
              <div class="farm-card-top">
                <div class="farm-title">
                  <div class="farm-avatar">
                    <i class="bi bi-house-door-fill"></i>
                  </div>
                  <div>
                    <h5 class="farm-name"><%= farm.name %></h5>
                    <div class="farm-meta">
                      <span><i class="bi bi-person"></i><%= farm.owner %></span>
                      <span><i class="bi bi-geo-alt"></i><%= farm.location %></span>
                    </div>
                  </div>
                </div>
                <span class="chip chip-active"><i class="bi bi-circle-fill"></i>Active</span>
              </div>

              <div class="farm-card-body">
                <div class="farm-contact">
                  <i class="bi bi-telephone"></i>
                  <span><%= farm.contact_phone %></span>
                </div>
                <div class="farm-metrics">
                  <div class="metric">
                    <div class="metric-label">Total cows</div>
                    <div class="metric-value"><%= farm.total_cows %></div>
                  </div>
                  <div class="metric">
                    <div class="metric-label">Active</div>
                    <div class="metric-value"><%= farm.active_cows %></div>
                  </div>
                  <div class="metric">
                    <div class="metric-label">Today</div>
                    <div class="metric-value"><%= number_with_precision(farm.today_production, precision: 1) %>L</div>
                  </div>
                </div>
              </div>

              <div class="farm-card-footer">
                <%= link_to farm, class: "btn btn-primary" do %>
                  <i class="bi bi-eye"></i>View
                <% end %>
                <%= link_to farm_cows_path(farm), class: "btn btn-outline-primary" do %>
                  <i class="bi bi-emoji-smile"></i>Cows
                <% end %>
                <div class="btn-group">
                  <button class="btn btn-ghost dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="bi bi-three-dots"></i>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li>
                      <%= link_to edit_farm_path(farm), class: "dropdown-item" do %>
                        <i class="bi bi-pencil me-2"></i>Edit Farm
                      <% end %>
                    </li>
                    <li>
                      <%= link_to farm_production_records_path(farm), class: "dropdown-item" do %>
                        <i class="bi bi-clipboard-data me-2"></i>Production Records
                      <% end %>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                      <%= link_to farm_path(farm), method: :delete,
                                  confirm: "Are you sure you want to delete this farm?",
                                  class: "dropdown-item text-danger" do %>
                        <i class="bi bi-trash me-2"></i>Delete Farm
                      <% end %>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <div class="farms-container list-view" id="listViewContainer" style="display: none;">
      <div class="list-shell">
        <div class="list-header">
          <div>Farm</div>
          <div class="text-center">Location</div>
          <div class="text-center">Herd</div>
          <div class="text-center">Today</div>
          <div class="text-end">Actions</div>
        </div>
        <div class="list-body" id="farmsList">
          <% @farms.each do |farm| %>
            <div class="farm-list-item"
                 data-name="<%= farm.name&.downcase %>"
                 data-owner="<%= farm.owner&.downcase %>"
                 data-location="<%= farm.location&.downcase %>"
                 data-cows="<%= farm.total_cows %>"
                 data-production="<%= farm.today_production %>">
              <div class="list-row">
                <div class="list-farm">
                  <div class="farm-avatar sm"><i class="bi bi-house-door-fill"></i></div>
                  <div>
                    <div class="list-name"><%= farm.name %></div>
                    <div class="list-sub"><i class="bi bi-person"></i><%= farm.owner %></div>
                    <div class="list-sub"><i class="bi bi-telephone"></i><%= farm.contact_phone %></div>
                  </div>
                </div>
                <div class="text-center list-pill"><i class="bi bi-geo-alt"></i><%= farm.location %></div>
                <div class="text-center list-metric">
                  <div><strong><%= farm.total_cows %></strong> total</div>
                  <div class="muted"><%= farm.active_cows %> active</div>
                </div>
                <div class="text-center list-metric">
                  <div class="today-value"><%= number_with_precision(farm.today_production, precision: 1) %>L</div>
                  <div class="muted">Today</div>
                </div>
                <div class="text-end list-actions">
                  <%= link_to farm, class: "btn btn-sm btn-primary" do %>
                    <i class="bi bi-eye"></i>
                  <% end %>
                  <%= link_to farm_cows_path(farm), class: "btn btn-sm btn-outline-primary" do %>
                    <i class="bi bi-emoji-smile"></i>
                  <% end %>
                  <%= link_to edit_farm_path(farm), class: "btn btn-sm btn-ghost" do %>
                    <i class="bi bi-pencil"></i>
                  <% end %>
                  <%= link_to farm_path(farm), method: :delete,
                              confirm: "Are you sure?",
                              class: "btn btn-sm btn-outline-danger" do %>
                    <i class="bi bi-trash"></i>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% else %>
    <div class="empty-state">
      <div class="empty-icon"><i class="bi bi-house-door"></i></div>
      <h3>No farms yet</h3>
      <p>Start by creating your first farm profile and begin tracking production.</p>
      <%= link_to new_farm_path, class: "btn btn-cta" do %>
        <i class="bi bi-plus-circle"></i>Add Farm
      <% end %>
      <div class="empty-guides">
        <div><i class="bi bi-check-circle"></i>Add farm details and owner info</div>
        <div><i class="bi bi-check-circle"></i>Register cows with unique tags</div>
        <div><i class="bi bi-check-circle"></i>Start logging daily milk output</div>
      </div>
    </div>
  <% end %>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const farmSearch = document.getElementById('farmSearch');
  const farmSort = document.getElementById('farmSort');
  const gridViewBtn = document.getElementById('gridView');
  const listViewBtn = document.getElementById('listView');
  const gridContainer = document.getElementById('gridViewContainer');
  const listContainer = document.getElementById('listViewContainer');
  const farmsGrid = document.getElementById('farmsGrid');
  const farmsList = document.getElementById('farmsList');

  if (gridViewBtn && listViewBtn) {
    gridViewBtn.addEventListener('click', function() {
      gridViewBtn.classList.add('active');
      listViewBtn.classList.remove('active');
      gridContainer.style.display = 'block';
      listContainer.style.display = 'none';
      localStorage.setItem('farmsView', 'grid');
    });

    listViewBtn.addEventListener('click', function() {
      listViewBtn.classList.add('active');
      gridViewBtn.classList.remove('active');
      gridContainer.style.display = 'none';
      listContainer.style.display = 'block';
      localStorage.setItem('farmsView', 'list');
    });

    const savedView = localStorage.getItem('farmsView');
    if (savedView === 'list') {
      listViewBtn.click();
    }
  }

  if (farmSearch) {
    farmSearch.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      filterAndSortFarms(searchTerm);
    });
  }

  if (farmSort) {
    farmSort.addEventListener('change', function() {
      const searchTerm = farmSearch ? farmSearch.value.toLowerCase() : '';
      filterAndSortFarms(searchTerm);
    });
  }

  function filterAndSortFarms(searchTerm) {
    const farmItems = document.querySelectorAll('.farm-item, .farm-list-item');
    const visibleItems = [];

    farmItems.forEach(item => {
      const name = item.dataset.name || '';
      const owner = item.dataset.owner || '';
      const location = item.dataset.location || '';

      const matches = !searchTerm ||
        name.includes(searchTerm) ||
        owner.includes(searchTerm) ||
        location.includes(searchTerm);

      if (matches) {
        item.style.display = '';
        visibleItems.push(item);
      } else {
        item.style.display = 'none';
      }
    });

    const sortBy = farmSort ? farmSort.value : 'name';
    visibleItems.sort((a, b) => {
      let aValue, bValue;

      switch (sortBy) {
        case 'name':
          aValue = a.dataset.name;
          bValue = b.dataset.name;
          break;
        case 'cows':
          aValue = parseInt(a.dataset.cows, 10);
          bValue = parseInt(b.dataset.cows, 10);
          break;
        case 'production':
          aValue = parseFloat(a.dataset.production);
          bValue = parseFloat(b.dataset.production);
          break;
        case 'location':
          aValue = a.dataset.location;
          bValue = b.dataset.location;
          break;
      }

      if (sortBy === 'cows' || sortBy === 'production') {
        return bValue - aValue;
      }

      return aValue.localeCompare(bValue);
    });

    visibleItems.forEach(item => {
      if (item.classList.contains('farm-item')) {
        farmsGrid.appendChild(item);
      } else if (item.classList.contains('farm-list-item')) {
        farmsList.appendChild(item);
      }
    });
  }

  const exportBtn = document.getElementById('exportFarms');
  if (exportBtn) {
    exportBtn.addEventListener('click', function(e) {
      e.preventDefault();
      alert('Export functionality would be implemented here');
    });
  }
});
</script>

<style>
@import url("https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Grotesk:wght@400;500;600;700&display=swap");

.farms-dashboard {
  --ink: #0f172a;
  --muted: #64748b;
  --edge: #e2e8f0;
  --panel: #ffffff;
  --panel-2: #f8fafc;
  --accent: #0ea5a4;
  --accent-dark: #0f766e;
  --accent-soft: rgba(14, 165, 164, 0.15);
  --shadow: 0 20px 60px rgba(15, 23, 42, 0.12);
  font-family: "Space Grotesk", "DM Sans", sans-serif;
  color: var(--ink);
  padding: 2.5rem 0 3rem;
  background: radial-gradient(circle at top left, rgba(14, 165, 164, 0.08), transparent 55%),
    linear-gradient(120deg, #f8fafc 0%, #f1f5f9 50%, #ffffff 100%);
}

.farms-hero {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 2rem;
  padding: 2.5rem 2.75rem;
  border-radius: 24px;
  background: linear-gradient(135deg, #0f172a 0%, #0f766e 100%);
  color: #f8fafc;
  box-shadow: var(--shadow);
  position: relative;
  overflow: hidden;
}

.farms-hero::after {
  content: "";
  position: absolute;
  width: 380px;
  height: 380px;
  right: -120px;
  top: -180px;
  background: radial-gradient(circle, rgba(255, 255, 255, 0.18), transparent 70%);
}

.hero-copy {
  max-width: 640px;
}

.hero-kicker {
  text-transform: uppercase;
  letter-spacing: 0.24em;
  font-size: 0.75rem;
  color: rgba(248, 250, 252, 0.7);
  margin-bottom: 0.75rem;
}

.hero-title {
  font-size: clamp(2rem, 3vw, 3rem);
  font-weight: 700;
  margin-bottom: 0.75rem;
}

.hero-subtitle {
  font-size: 1.05rem;
  color: rgba(248, 250, 252, 0.8);
  margin-bottom: 1.5rem;
}

.hero-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
}

.meta-pill {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.4rem 0.75rem;
  border-radius: 999px;
  background: rgba(15, 23, 42, 0.3);
  border: 1px solid rgba(248, 250, 252, 0.2);
  font-size: 0.85rem;
}

.hero-actions {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  z-index: 1;
}

.farms-dashboard .btn-cta {
  background: #f8fafc;
  color: #0f172a;
  border: none;
  padding: 0.7rem 1.3rem;
  border-radius: 12px;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  box-shadow: 0 12px 30px rgba(15, 118, 110, 0.35);
}

.farms-dashboard .btn-cta:hover {
  background: #e2e8f0;
  color: #0f172a;
}

.farms-dashboard .btn-ghost {
  border: 1px solid rgba(15, 23, 42, 0.2);
  background: rgba(255, 255, 255, 0.65);
  color: var(--ink);
}

.kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
  gap: 1.25rem;
  margin: 2.5rem 0 2rem;
}

.kpi-card {
  background: var(--panel);
  border-radius: 18px;
  border: 1px solid var(--edge);
  padding: 1.5rem;
  display: flex;
  gap: 1rem;
  align-items: center;
  box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
}

.kpi-icon {
  width: 46px;
  height: 46px;
  border-radius: 14px;
  display: grid;
  place-items: center;
  background: var(--accent-soft);
  color: var(--accent-dark);
  font-size: 1.2rem;
}

.kpi-value {
  font-size: 1.6rem;
  font-weight: 700;
}

.kpi-label,
.muted {
  color: var(--muted);
  font-size: 0.9rem;
}

.filter-bar {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  align-items: center;
  justify-content: space-between;
  padding: 1rem 1.25rem;
  border-radius: 16px;
  background: var(--panel);
  border: 1px solid var(--edge);
  box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
  margin-bottom: 2rem;
}

.filter-search {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  flex: 1 1 320px;
  background: var(--panel-2);
  border-radius: 999px;
  padding: 0.5rem 1rem;
  border: 1px solid var(--edge);
}

.filter-search i {
  color: var(--muted);
}

.filter-search .form-control {
  border: none;
  background: transparent;
  box-shadow: none;
}

.filter-controls {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.view-toggle .btn {
  border-color: var(--edge);
}

.view-toggle .btn.active {
  background: var(--accent);
  border-color: var(--accent);
  color: #fff;
}

.farm-card {
  background: var(--panel);
  border-radius: 20px;
  border: 1px solid var(--edge);
  padding: 1.5rem;
  box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
  height: 100%;
  display: flex;
  flex-direction: column;
  gap: 1.2rem;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.farm-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 26px 50px rgba(15, 23, 42, 0.12);
}

.farm-card-top {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 1rem;
}

.farm-title {
  display: flex;
  gap: 1rem;
  align-items: center;
}

.farm-avatar {
  width: 48px;
  height: 48px;
  border-radius: 14px;
  display: grid;
  place-items: center;
  background: rgba(15, 118, 110, 0.12);
  color: var(--accent-dark);
  font-size: 1.2rem;
}

.farm-avatar.sm {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  font-size: 1rem;
}

.farm-name {
  margin-bottom: 0.25rem;
  font-weight: 600;
}

.farm-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
  color: var(--muted);
  font-size: 0.9rem;
}

.farm-meta i {
  margin-right: 0.35rem;
}

.chip {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.25rem 0.7rem;
  border-radius: 999px;
  font-size: 0.75rem;
  background: rgba(16, 185, 129, 0.12);
  color: #0f766e;
  border: 1px solid rgba(16, 185, 129, 0.25);
}

.farm-contact {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1rem;
  border-radius: 12px;
  background: var(--panel-2);
  border: 1px solid var(--edge);
  color: var(--muted);
}

.farm-metrics {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 0.75rem;
}

.metric {
  padding: 0.75rem;
  border-radius: 12px;
  background: var(--panel-2);
  border: 1px solid var(--edge);
  text-align: center;
}

.metric-value {
  font-weight: 700;
  font-size: 1.1rem;
}

.metric-label {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--muted);
}

.farm-card-footer {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-top: auto;
}

.farm-card-footer .btn {
  border-radius: 10px;
}

.list-shell {
  border-radius: 20px;
  background: var(--panel);
  border: 1px solid var(--edge);
  box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
  overflow: hidden;
}

.list-header {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
  gap: 1rem;
  padding: 1rem 1.5rem;
  background: #0f172a;
  color: #f8fafc;
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 0.12em;
}

.farm-list-item {
  border-bottom: 1px solid var(--edge);
  padding: 1rem 1.5rem;
}

.list-row {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
  gap: 1rem;
  align-items: center;
}

.list-farm {
  display: flex;
  gap: 0.75rem;
  align-items: center;
}

.list-name {
  font-weight: 600;
}

.list-sub {
  color: var(--muted);
  font-size: 0.85rem;
  display: flex;
  align-items: center;
  gap: 0.35rem;
}

.list-pill {
  display: inline-flex;
  gap: 0.35rem;
  align-items: center;
  justify-content: center;
  background: var(--panel-2);
  border: 1px solid var(--edge);
  border-radius: 999px;
  padding: 0.35rem 0.75rem;
}

.list-metric .muted {
  color: var(--muted);
  font-size: 0.85rem;
}

.today-value {
  font-weight: 700;
  color: var(--accent-dark);
}

.list-actions .btn {
  margin-left: 0.35rem;
}

.empty-state {
  text-align: center;
  padding: 3.5rem 2rem;
  border-radius: 24px;
  background: var(--panel);
  border: 1px dashed var(--edge);
  box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
}

.empty-icon {
  font-size: 3.5rem;
  color: var(--accent);
  margin-bottom: 1rem;
}

.empty-guides {
  margin-top: 1.5rem;
  display: grid;
  gap: 0.5rem;
  color: var(--muted);
}

.empty-guides i {
  margin-right: 0.4rem;
  color: var(--accent);
}

@media (max-width: 992px) {
  .farms-hero {
    flex-direction: column;
    align-items: flex-start;
  }

  .list-header,
  .list-row {
    grid-template-columns: 1.6fr 1fr 1fr 1fr;
  }

  .list-header div:last-child,
  .list-row div:last-child {
    display: none;
  }
}

@media (max-width: 768px) {
  .farm-metrics {
    grid-template-columns: 1fr;
  }

  .filter-bar {
    flex-direction: column;
    align-items: stretch;
  }

  .filter-controls {
    width: 100%;
    justify-content: space-between;
  }

  .list-header,
  .list-row {
    grid-template-columns: 1fr;
    text-align: left;
  }

  .list-header div:not(:first-child) {
    display: none;
  }

  .list-row > div:not(:first-child) {
    display: none;
  }
}
</style>
