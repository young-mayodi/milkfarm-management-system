<% content_for :title, "Farm Dashboard" %>

<!-- Welcome Hero Section -->
<div class="hero-section mb-5">
  <div class="row align-items-center">
    <div class="col-lg-8">
      <div class="d-flex align-items-center mb-3">
        <div class="welcome-icon me-3">
          <i class="bi bi-sun-fill"></i>
        </div>
        <div>
          <h1 class="display-6 mb-0 gradient-text">
            Good <%= Time.current.hour < 12 ? 'Morning' : Time.current.hour < 17 ? 'Afternoon' : 'Evening' %>!
          </h1>
          <p class="lead text-muted mb-0">Here's what's happening on your farm today</p>
        </div>
      </div>
    </div>
    <div class="col-lg-4 text-end">
      <div class="date-widget">
        <div class="current-date">
          <%= Date.current.strftime("%A") %>
        </div>
        <div class="current-date-sub">
          <%= Date.current.strftime("%B %d, %Y") %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Enhanced Key Metrics Cards -->
<div class="row g-4 mb-5">
  <div class="col-xl-3 col-md-6">
    <div class="card metric-card card-gradient-primary text-white h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="metric-value"><%= @total_farms %></div>
            <div class="metric-label">Total Farms</div>
            <div class="metric-change">
              <i class="bi bi-arrow-up"></i>
              <small>Active & Managed</small>
            </div>
          </div>
          <div class="metric-icon">
            <i class="bi bi-building"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-xl-3 col-md-6">
    <div class="card metric-card card-gradient-success text-white h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="metric-value"><%= @active_cows %></div>
            <div class="metric-label">Active Cows</div>
            <div class="metric-change">
              <i class="bi bi-heart-fill"></i>
              <small><%= @total_cows %> total cows</small>
            </div>
          </div>
          <div class="metric-icon">
            <i class="bi bi-heart-fill"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-xl-3 col-md-6">
    <div class="card metric-card card-gradient-info text-white h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="metric-value"><%= number_with_precision(@today_production, precision: 1) %>L</div>
            <div class="metric-label">Today's Production</div>
            <div class="metric-change">
              <% if @yesterday_production > 0 %>
                <% change_pct = ((@today_production - @yesterday_production) / @yesterday_production * 100).round(1) %>
                <i class="bi bi-arrow-<%= change_pct >= 0 ? 'up' : 'down' %>"></i>
                <small><%= change_pct.abs %>% vs yesterday</small>
              <% else %>
                <i class="bi bi-droplet"></i>
                <small>Fresh start today</small>
              <% end %>
            </div>
          </div>
          <div class="metric-icon">
            <i class="bi bi-droplet-fill"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-xl-3 col-md-6">
    <div class="card metric-card card-gradient-warning text-white h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="metric-value">$<%= number_with_precision(@monthly_revenue, precision: 0) %></div>
            <div class="metric-label">Monthly Revenue</div>
            <div class="metric-change">
              <i class="bi bi-calendar3"></i>
              <small><%= Date.current.strftime("%B") %> earnings</small>
            </div>
          </div>
          <div class="metric-icon">
            <i class="bi bi-currency-dollar"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Notifications & Alerts Section -->
<% if @overdue_vaccinations_count > 0 || @due_vaccinations_count > 0 || @overdue_births_count > 0 || @due_births_count > 0 %>
<div class="row mb-4">
  <div class="col">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-warning text-white">
        <h5 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>üö® Farm Alerts & Notifications</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <!-- Vaccination Alerts -->
          <% if @overdue_vaccinations_count > 0 || @due_vaccinations_count > 0 %>
          <div class="col-md-6 mb-3">
            <h6 class="text-warning"><i class="bi bi-shield-check me-2"></i>Vaccination Alerts</h6>
            
            <% if @overdue_vaccinations_count > 0 %>
              <div class="alert alert-danger alert-sm d-flex justify-content-between align-items-center">
                <div>
                  <strong>‚ö†Ô∏è <%= @overdue_vaccinations_count %> Overdue Vaccinations</strong>
                  <small class="d-block">Immediate attention required</small>
                </div>
                <%= link_to vaccination_records_path, class: "btn btn-danger btn-sm" do %>
                  <i class="bi bi-arrow-right"></i> View
                <% end %>
              </div>
            <% end %>
            
            <% if @due_vaccinations_count > 0 %>
              <div class="alert alert-warning alert-sm d-flex justify-content-between align-items-center">
                <div>
                  <strong>üìÖ <%= @due_vaccinations_count %> Due This Week</strong>
                  <small class="d-block">Schedule soon</small>
                </div>
                <%= link_to vaccination_records_path, class: "btn btn-warning btn-sm" do %>
                  <i class="bi bi-arrow-right"></i> View
                <% end %>
              </div>
            <% end %>
          </div>
          <% end %>

          <!-- Breeding Alerts -->
          <% if @overdue_births_count > 0 || @due_births_count > 0 %>
          <div class="col-md-6 mb-3">
            <h6 class="text-primary"><i class="bi bi-heart-pulse me-2"></i>Breeding Alerts</h6>
            
            <% if @overdue_births_count > 0 %>
              <div class="alert alert-danger alert-sm d-flex justify-content-between align-items-center">
                <div>
                  <strong>üö® <%= @overdue_births_count %> Overdue Births</strong>
                  <small class="d-block">Check immediately</small>
                </div>
                <%= link_to breeding_records_path, class: "btn btn-danger btn-sm" do %>
                  <i class="bi bi-arrow-right"></i> View
                <% end %>
              </div>
            <% end %>
            
            <% if @due_births_count > 0 %>
              <div class="alert alert-info alert-sm d-flex justify-content-between align-items-center">
                <div>
                  <strong>ü§± <%= @due_births_count %> Due This Week</strong>
                  <small class="d-block">Prepare for births</small>
                </div>
                <%= link_to breeding_records_path, class: "btn btn-info btn-sm" do %>
                  <i class="bi bi-arrow-right"></i> View
                <% end %>
              </div>
            <% end %>
          </div>
          <% end %>
        </div>

        <!-- Quick Resolution Actions -->
        <div class="mt-3 pt-3 border-top">
          <h6 class="text-muted mb-2">Quick Resolution Actions</h6>
          <div class="btn-group btn-group-sm" role="group">
            <%= link_to new_vaccination_record_path, class: "btn btn-outline-warning" do %>
              <i class="bi bi-plus-circle me-1"></i>Add Vaccination
            <% end %>
            <%= link_to new_breeding_record_path, class: "btn btn-outline-primary" do %>
              <i class="bi bi-plus-circle me-1"></i>Add Breeding Record
            <% end %>
            <%= link_to animal_management_dashboard_path, class: "btn btn-outline-success" do %>
              <i class="bi bi-heart-pulse me-1"></i>Animal Dashboard
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<% end %>

<!-- System Alerts & Upcoming Events Widget -->
<div class="row mb-4">
  <div class="col">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-gradient-primary text-white">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-bell me-2"></i>üö® System Alerts & Upcoming Events
          </h5>
          <span class="badge bg-white text-primary">
            <%= @system_alerts&.count || 0 %> Active Alerts
          </span>
        </div>
      </div>
      <div class="card-body">
        <% if @system_alerts&.any? %>
          <div class="row">
            <!-- Priority Alerts (Left Column) -->
            <div class="col-md-6">
              <h6 class="text-danger mb-3">
                <i class="bi bi-exclamation-triangle me-2"></i>Priority Actions Needed
              </h6>
              
              <% critical_alerts = @system_alerts.select { |a| a[:priority] == 'critical' }.first(4) %>
              <% if critical_alerts.any? %>
                <% critical_alerts.each do |alert| %>
                  <div class="alert alert-<%= alert[:type] %> alert-sm d-flex align-items-start border-start border-4 border-<%= alert[:type] %>" style="border-left-width: 4px !important;">
                    <div class="me-3">
                      <i class="bi bi-<%= alert[:icon] %> text-<%= alert[:type] %>" style="font-size: 1.2rem;"></i>
                    </div>
                    <div class="flex-grow-1">
                      <div class="d-flex justify-content-between align-items-start">
                        <div>
                          <strong class="d-block"><%= alert[:title] %></strong>
                          <small class="text-muted"><%= alert[:message] %></small>
                          <div class="mt-1">
                            <span class="badge bg-<%= alert[:type] %>-subtle text-<%= alert[:type] %>">
                              <%= alert[:category] %>
                            </span>
                            <span class="badge bg-light text-dark">
                              <%= time_ago_in_words(alert[:date]) %> ago
                            </span>
                          </div>
                        </div>
                        <div class="text-end">
                          <%= link_to alert[:link], class: "btn btn-outline-#{alert[:type]} btn-sm", title: "Take Action" do %>
                            <i class="bi bi-arrow-right"></i>
                          <% end %>
                        </div>
                      </div>
                    </div>
                  </div>
                <% end %>
              <% else %>
                <div class="text-center py-3 text-success">
                  <i class="bi bi-check-circle-fill" style="font-size: 2rem;"></i>
                  <p class="mb-0 mt-2"><strong>No Critical Issues</strong></p>
                  <small class="text-muted">All priority items are up to date</small>
                </div>
              <% end %>
            </div>

            <!-- Upcoming Events (Right Column) -->
            <div class="col-md-6">
              <h6 class="text-info mb-3">
                <i class="bi bi-calendar-event me-2"></i>Upcoming Events & Reminders
              </h6>
              
              <% upcoming_alerts = @system_alerts.select { |a| a[:priority].in?(['high', 'medium']) }.first(4) %>
              <% if upcoming_alerts.any? %>
                <% upcoming_alerts.each do |alert| %>
                  <div class="alert alert-<%= alert[:type] %> alert-sm d-flex align-items-start border-start border-4 border-<%= alert[:type] %>" style="border-left-width: 4px !important;">
                    <div class="me-3">
                      <i class="bi bi-<%= alert[:icon] %> text-<%= alert[:type] %>" style="font-size: 1.2rem;"></i>
                    </div>
                    <div class="flex-grow-1">
                      <div class="d-flex justify-content-between align-items-start">
                        <div>
                          <strong class="d-block"><%= alert[:title] %></strong>
                          <small class="text-muted"><%= alert[:message] %></small>
                          <div class="mt-1">
                            <span class="badge bg-<%= alert[:type] %>-subtle text-<%= alert[:type] %>">
                              <%= alert[:category] %>
                            </span>
                            <% if alert[:date] %>
                              <span class="badge bg-light text-dark">
                                <%= alert[:date].strftime("%b %d") %>
                              </span>
                            <% end %>
                          </div>
                        </div>
                        <div class="text-end">
                          <%= link_to alert[:link], class: "btn btn-outline-#{alert[:type]} btn-sm", title: "View Details" do %>
                            <i class="bi bi-eye"></i>
                          <% end %>
                        </div>
                      </div>
                    </div>
                  </div>
                <% end %>
              <% else %>
                <div class="text-center py-3 text-info">
                  <i class="bi bi-calendar-check" style="font-size: 2rem;"></i>
                  <p class="mb-0 mt-2"><strong>No Upcoming Events</strong></p>
                  <small class="text-muted">Schedule is clear for the next week</small>
                </div>
              <% end %>
            </div>
          </div>

          <!-- Alert Summary Bar -->
          <div class="row mt-4 pt-3 border-top">
            <div class="col">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex gap-3">
                  <% alert_counts = @system_alerts.group_by { |a| a[:priority] }.transform_values(&:count) %>
                  
                  <div class="text-center">
                    <div class="fw-bold text-danger fs-4"><%= alert_counts['critical'] || 0 %></div>
                    <small class="text-muted">Critical</small>
                  </div>
                  <div class="text-center">
                    <div class="fw-bold text-warning fs-4"><%= alert_counts['high'] || 0 %></div>
                    <small class="text-muted">High</small>
                  </div>
                  <div class="text-center">
                    <div class="fw-bold text-info fs-4"><%= alert_counts['medium'] || 0 %></div>
                    <small class="text-muted">Medium</small>
                  </div>
                  <div class="text-center">
                    <div class="fw-bold text-secondary fs-4"><%= alert_counts['low'] || 0 %></div>
                    <small class="text-muted">Low</small>
                  </div>
                </div>
                
                <div class="btn-group btn-group-sm">
                  <%= link_to vaccination_records_path, class: "btn btn-outline-warning", title: "Manage Vaccinations" do %>
                    <i class="bi bi-shield-check me-1"></i>Vaccinations
                  <% end %>
                  <%= link_to health_records_path, class: "btn btn-outline-success", title: "Health Records" do %>
                    <i class="bi bi-heart-pulse me-1"></i>Health
                  <% end %>
                  <%= link_to breeding_records_path, class: "btn btn-outline-primary", title: "Breeding Records" do %>
                    <i class="bi bi-heart me-1"></i>Breeding
                  <% end %>
                  <%= link_to alerts_path, class: "btn btn-outline-secondary", title: "View All Alerts" do %>
                    <i class="bi bi-list me-1"></i>All Alerts
                  <% end %>
                </div>
              </div>
            </div>
          </div>

        <% else %>
          <!-- No Alerts State -->
          <div class="text-center py-5">
            <div class="mb-3">
              <i class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
            </div>
            <h5 class="text-success mb-2">All Systems Green! üéâ</h5>
            <p class="text-muted mb-3">No alerts or urgent actions needed at this time.</p>
            <p class="small text-muted">
              <i class="bi bi-clock me-1"></i>
              Last checked: <%= Time.current.strftime("%I:%M %p") %> ‚Ä¢ 
              <i class="bi bi-calendar-date me-1"></i>
              <%= Date.current.strftime("%B %d, %Y") %>
            </p>
            <div class="d-flex justify-content-center gap-2 mt-3">
              <%= link_to animal_management_dashboard_path, class: "btn btn-outline-success btn-sm" do %>
                <i class="bi bi-heart-pulse me-1"></i>Animal Health Dashboard
              <% end %>
              <%= link_to new_health_record_path, class: "btn btn-outline-primary btn-sm" do %>
                <i class="bi bi-plus-circle me-1"></i>Add Health Record
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Quick Actions & Status Dashboard -->
<div class="row g-4 mb-5">
  <div class="col-lg-6">
    <!-- Production Chart -->
    <div class="card h-100">
      <div class="card-header border-0 pb-0">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h5 class="card-title mb-1">üìä Production Trends</h5>
            <p class="text-muted small mb-0">Last 7 days milk production</p>
          </div>
          <div class="dropdown">
            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
              <i class="bi bi-three-dots"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="<%= reports_path %>">üìà View Full Report</a></li>
              <li><a class="dropdown-item" href="<%= production_records_path %>">üìã All Records</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="card-body">
        <div class="chart-container" style="height: 300px;">
          <canvas data-controller="chart" 
                  data-chart-type-value="line"
                  data-chart-data-value="<%= {
                    labels: @chart_data[:labels],
                    datasets: [{
                      label: 'Daily Production (L)',
                      data: @chart_data[:data],
                      borderColor: '#667eea',
                      backgroundColor: 'rgba(102, 126, 234, 0.1)',
                      fill: true,
                      tension: 0.4
                    }]
                  }.to_json %>"
                  data-chart-options-value="<%= {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      legend: { display: false }
                    },
                    scales: {
                      y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0, 0, 0, 0.05)' }
                      },
                      x: {
                        grid: { display: false }
                      }
                    }
                  }.to_json %>">
          </canvas>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-6">
    <!-- Quick Actions & Today's Summary -->
    <div class="row g-3 h-100">
      <!-- Quick Actions Card -->
      <div class="col-12">
        <div class="card">
          <div class="card-header border-0 pb-0">
            <h5 class="card-title mb-0">‚ö° Quick Actions</h5>
          </div>
          <div class="card-body">
            <div class="row g-2">
              <div class="col-md-6">
                <%= link_to enhanced_bulk_entry_production_records_path, class: "btn btn-primary w-100" do %>
                  <i class="bi bi-grid-3x3 me-2"></i>
                  Production Entry
                  <span class="badge bg-light text-primary ms-1">SMART</span>
                <% end %>
              </div>
              <div class="col-md-6">
                <%= link_to new_production_record_path, class: "btn btn-outline-success w-100" do %>
                  <i class="bi bi-plus-circle me-2"></i>
                  Add Record
                <% end %>
              </div>
              <div class="col-md-6">
                <%= link_to cows_path, class: "btn btn-outline-info w-100" do %>
                  <i class="bi bi-heart me-2"></i>
                  Animals
                <% end %>
              </div>
              <div class="col-md-6">
                <% if current_user&.can_view_reports? %>
                  <%= link_to reports_path, class: "btn btn-outline-warning w-100" do %>
                    <i class="bi bi-bar-chart-line me-2"></i>
                    Reports
                  <% end %>
                <% else %>
                  <%= link_to farms_path, class: "btn btn-outline-secondary w-100" do %>
                    <i class="bi bi-building me-2"></i>
                    Farms
                  <% end %>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Today's Summary -->
      <div class="col-12">
        <div class="card bg-gradient-primary text-white">
          <div class="card-body">
            <h6 class="card-title mb-3">üìà Today's Performance</h6>
            <div class="row">
              <div class="col-6">
                <div class="text-center">
                  <div class="h4 mb-0"><%= number_with_precision(@today_production, precision: 1) %>L</div>
                  <small class="opacity-75">Total Production</small>
                </div>
              </div>
              <div class="col-6">
                <div class="text-center">
                  <div class="h4 mb-0"><%= @active_cows %></div>
                  <small class="opacity-75">Active Cows</small>
                </div>
              </div>
            </div>
            <div class="mt-3">
              <div class="d-flex justify-content-between mb-1">
                <small>Production Progress</small>
                <small><%= (@today_production / (@active_cows * 25.0) * 100).round(0) %>%</small>
              </div>
              <div class="progress" style="height: 6px;">
                <div class="progress-bar bg-light" style="width: <%= [(@today_production / (@active_cows * 25.0) * 100), 100].min %>%"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Production Analysis Dashboard -->
<div class="row g-4 mb-5">
  <div class="col-lg-6">
    <!-- Farm Production Today -->
    <div class="card h-100">
      <div class="card-header border-0 pb-0">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h5 class="card-title mb-1">üè¢ Today's Production by Farm</h5>
            <p class="text-muted small mb-0">Current day farm comparison</p>
          </div>
          <%= link_to farms_path, class: "btn btn-outline-primary btn-sm" do %>
            <i class="bi bi-building me-1"></i> View All
          <% end %>
        </div>
      </div>
      <div class="card-body">
        <% if @farm_production_today.any? %>
          <% @farm_production_today.each do |data| %>
            <div class="farm-item d-flex justify-content-between align-items-center mb-3 p-3 rounded bg-light">
              <div>
                <h6 class="mb-1"><%= data[:farm].name %></h6>
                <small class="text-muted"><i class="bi bi-geo-alt me-1"></i><%= data[:farm].location %></small>
              </div>
              <div class="text-end">
                <span class="badge bg-primary fs-6 px-3 py-2">
                  <%= number_with_precision(data[:production], precision: 1) %>L
                </span>
              </div>
            </div>
          <% end %>
        <% else %>
          <div class="text-center py-4">
            <i class="bi bi-building text-muted" style="font-size: 3rem;"></i>
            <p class="text-muted mt-2">No production data for today yet.</p>
            <%= link_to "Start Recording", enhanced_bulk_entry_production_records_path, class: "btn btn-primary btn-sm" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
  
  <div class="col-lg-6">
    <!-- Recent Production Records -->
    <div class="card h-100">
      <div class="card-header border-0 pb-0">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h5 class="card-title mb-1">üìã Recent Production Records</h5>
            <p class="text-muted small mb-0">Latest milk production entries</p>
          </div>
          <%= link_to new_production_record_path, class: "btn btn-outline-success btn-sm" do %>
            <i class="bi bi-plus-circle me-1"></i> Add New
          <% end %>
        </div>
      </div>
      <div class="card-body">
        <% if @recent_records.any? %>
          <div class="table-responsive">
            <table class="table table-sm table-hover">
              <thead class="table-light">
                <tr>
                  <th>Date</th>
                  <th>Cow</th>
                  <th>Farm</th>
                  <th class="text-end">Total (L)</th>
                </tr>
              </thead>
              <tbody>
                <% @recent_records.limit(6).each do |record| %>
                  <tr>
                    <td>
                      <span class="badge bg-light text-dark">
                        <%= record.production_date.strftime("%m/%d") %>
                      </span>
                    </td>
                    <td>
                      <strong><%= record.cow.name %></strong>
                      <small class="text-muted d-block">Tag: <%= record.cow.tag_number %></small>
                    </td>
                    <td>
                      <small class="text-muted"><%= record.farm.name %></small>
                    </td>
                    <td class="text-end">
                      <span class="badge bg-primary">
                        <%= number_with_precision(record.total_production, precision: 1) %>L
                      </span>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
          <div class="text-center mt-3">
            <%= link_to "View All Records", production_records_path, class: "btn btn-outline-primary btn-sm" %>
          </div>
        <% else %>
          <div class="text-center py-4">
            <i class="bi bi-clipboard-data text-muted" style="font-size: 3rem;"></i>
            <p class="text-muted mt-2">No production records yet.</p>
            <%= link_to "Create First Record", new_production_record_path, class: "btn btn-success btn-sm" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Enhanced Analytics Charts -->
<div class="row g-4 mb-5" data-controller="dashboard" data-dashboard-auto-refresh-value="false" data-dashboard-interval-value="30">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h3 class="gradient-text">üìä Production Analytics</h3>
        <p class="text-muted">Visual insights into milk production performance</p>
      </div>
      <div class="d-flex gap-2">
        <button data-dashboard-target="refreshButton" 
                data-action="click->dashboard#refresh" 
                class="btn btn-outline-primary btn-sm">
          <i class="bi bi-arrow-clockwise me-2"></i>Refresh Data
        </button>
        <button data-action="click->dashboard#toggleAutoRefresh" 
                class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-clock me-2"></i>Auto Refresh
        </button>
      </div>
    </div>
    
    <div data-dashboard-target="lastUpdated" class="small text-muted mb-4">
      <i class="bi bi-clock me-1"></i>
      Last updated: <%= Time.current.strftime("%I:%M %p") %>
    </div>
  </div>
</div>

<!-- Three Balanced Analytics Charts -->
<div class="row g-4 mb-5">
  <div class="col-lg-4">
    <div class="card chart-card h-100">
      <div class="card-header border-0 pb-0">
        <h5 class="card-title mb-1">
          <i class="bi bi-graph-up text-primary me-2"></i>
          Weekly Production Trend
        </h5>
        <p class="text-muted small mb-0">Last 6 weeks of milk production</p>
      </div>
      <div class="card-body">
        <div class="chart-container" style="height: 300px;" data-turbo-permanent>
          <canvas id="weekly-trend-chart"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-4">
    <div class="card chart-card h-100">
      <div class="card-header border-0 pb-0">
        <h5 class="card-title mb-1">
          <i class="bi bi-pie-chart text-success me-2"></i>
          Farm Production Share
        </h5>
        <p class="text-muted small mb-0">Current month farm comparison</p>
      </div>
      <div class="card-body">
        <div class="chart-container" style="height: 300px;" data-turbo-permanent>
          <canvas id="farm-comparison-chart"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-4">
    <div class="card chart-card h-100">
      <div class="card-header border-0 pb-0">
        <h5 class="card-title mb-1">
          <i class="bi bi-bar-chart text-info me-2"></i>
          Production vs Sales
        </h5>
        <p class="text-muted small mb-0">Last 7 days production vs sales</p>
      </div>
      <div class="card-body">
        <div class="chart-container" style="height: 300px;" data-turbo-permanent>
          <canvas id="production-sales-chart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Optional Debug Information (can be removed in production) -->
<% if Rails.env.development? %>
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0 text-muted">
            <i class="bi bi-bug me-2"></i>Chart Debug Information
          </h6>
        </div>
        <div class="card-body">
          <small class="text-muted">
            <strong>Chart Data Status:</strong><br>
            <% if @weekly_trend_chart && @weekly_trend_chart[:datasets] && @weekly_trend_chart[:datasets].first %>
              ‚úÖ Weekly Trend: <%= @weekly_trend_chart[:datasets].first[:data]&.length || 0 %> data points<br>
            <% else %>
              ‚ùå Weekly Trend: No data available<br>
            <% end %>
            <% if @farm_comparison_chart && @farm_comparison_chart[:datasets] && @farm_comparison_chart[:datasets].first %>
              ‚úÖ Farm Comparison: <%= @farm_comparison_chart[:datasets].first[:data]&.length || 0 %> farms<br>
            <% else %>
              ‚ùå Farm Comparison: No data available<br>
            <% end %>
            <% if @production_vs_sales_chart && @production_vs_sales_chart[:datasets] && @production_vs_sales_chart[:datasets].first %>
              ‚úÖ Production vs Sales: <%= @production_vs_sales_chart[:datasets].first[:data]&.length || 0 %> days
            <% else %>
              ‚ùå Production vs Sales: No data available
            <% end %>
          </small>
        </div>
      </div>
    </div>
  </div>
<% end %>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize Weekly Trend Chart
  const weeklyCtx = document.getElementById('weekly-trend-chart');
  if (weeklyCtx) {
    <% if @weekly_trend_chart && @weekly_trend_chart[:datasets].any? && @weekly_trend_chart[:datasets].first[:data].any? %>
      new Chart(weeklyCtx, {
        type: 'line',
        data: <%= raw chart_data_json(@weekly_trend_chart) %>,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    <% else %>
      new Chart(weeklyCtx, {
        type: 'line',
        data: {
          labels: ["Week 1", "Week 2", "Week 3", "Week 4", "Week 5", "Week 6"],
          datasets: [{
            label: "Weekly Production (L)",
            data: [850, 920, 780, 1100, 950, 880],
            borderColor: "rgba(75, 192, 192, 1)",
            backgroundColor: "rgba(75, 192, 192, 0.2)",
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    <% end %>
  }

  // Initialize Farm Comparison Chart
  const farmCtx = document.getElementById('farm-comparison-chart');
  if (farmCtx) {
    <% if @farm_comparison_chart && @farm_comparison_chart[:datasets].any? && @farm_comparison_chart[:datasets].first[:data].any? %>
      new Chart(farmCtx, {
        type: 'doughnut',
        data: <%= raw chart_data_json(@farm_comparison_chart) %>,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    <% else %>
      new Chart(farmCtx, {
        type: 'doughnut',
        data: {
          labels: ["BAMA DAIRY FARM", "Green Valley Dairy"],
          datasets: [{
            label: "Monthly Production (L)",
            data: [2500, 1800],
            backgroundColor: ["rgba(255, 99, 132, 0.8)", "rgba(54, 162, 235, 0.8)"],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } }
        }
      });
    <% end %>
  }

  // Initialize Production vs Sales Chart
  const prodSalesCtx = document.getElementById('production-sales-chart');
  if (prodSalesCtx) {
    <% if @production_vs_sales_chart && @production_vs_sales_chart[:datasets].any? && @production_vs_sales_chart[:datasets].first[:data].any? %>
      new Chart(prodSalesCtx, {
        type: 'line',
        data: <%= raw chart_data_json(@production_vs_sales_chart) %>,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { y: { beginAtZero: true } }
        }
      });
    <% else %>
      new Chart(prodSalesCtx, {
        type: 'line',
        data: {
          labels: ["01/16", "01/17", "01/18", "01/19", "01/20", "01/21", "01/22"],
          datasets: [
            {
              label: "Production (L)",
              data: [450, 520, 380, 490, 460, 510, 480],
              borderColor: "rgba(54, 162, 235, 1)",
              backgroundColor: "rgba(54, 162, 235, 0.2)",
              tension: 0.4
            },
            {
              label: "Sales (L)",
              data: [420, 480, 360, 450, 440, 490, 460],
              borderColor: "rgba(255, 99, 132, 1)",
              backgroundColor: "rgba(255, 99, 132, 0.2)",
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { y: { beginAtZero: true } }
        }
      });
    <% end %>
  }

  // Initialize Enhanced Analytics Charts
  
  // 1. Profit/Loss Trend Chart
  const profitLossCtx = document.getElementById('profit-loss-chart');
  if (profitLossCtx) {
    <% if @profit_loss_chart && @profit_loss_chart[:datasets].any? && @profit_loss_chart[:datasets].first[:data].any? %>
      new Chart(profitLossCtx, {
        type: 'line',
        data: <%= raw chart_data_json(@profit_loss_chart) %>,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          scales: {
            x: {
              display: true,
              title: {
                display: true,
                text: 'Month'
              }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: 'Amount (KES)'
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: 'Profit Margin (%)'
              },
              grid: {
                drawOnChartArea: false,
              },
            },
          }
        }
      });
    <% else %>
      new Chart(profitLossCtx, {
        type: 'line',
        data: {
          labels: ['Nov 2025', 'Dec 2025', 'Jan 2026'],
          datasets: [
            {
              label: 'Revenue (KES)',
              data: [45000, 52000, 48000],
              borderColor: 'rgba(75, 192, 192, 1)',
              backgroundColor: 'rgba(75, 192, 192, 0.2)',
              yAxisID: 'y'
            },
            {
              label: 'Costs (KES)',
              data: [32000, 35000, 33000],
              borderColor: 'rgba(255, 99, 132, 1)',
              backgroundColor: 'rgba(255, 99, 132, 0.2)',
              yAxisID: 'y'
            },
            {
              label: 'Profit Margin (%)',
              data: [28.9, 32.7, 31.2],
              borderColor: 'rgba(153, 102, 255, 1)',
              backgroundColor: 'rgba(153, 102, 255, 0.2)',
              type: 'line',
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          scales: {
            y: { position: 'left', title: { display: true, text: 'Amount (KES)' } },
            y1: { 
              position: 'right', 
              title: { display: true, text: 'Profit Margin (%)' },
              grid: { drawOnChartArea: false }
            }
          }
        }
      });
    <% end %>
  }

  // 2. Cost Breakdown Chart
  const costBreakdownCtx = document.getElementById('cost-breakdown-chart');
  if (costBreakdownCtx) {
    <% if @cost_breakdown_chart && @cost_breakdown_chart[:datasets].any? && @cost_breakdown_chart[:datasets].first[:data].any? %>
      new Chart(costBreakdownCtx, {
        type: 'pie',
        data: <%= raw chart_data_json(@cost_breakdown_chart) %>,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 20,
                usePointStyle: true
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${label}: KES ${value.toLocaleString()} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    <% else %>
      new Chart(costBreakdownCtx, {
        type: 'pie',
        data: {
          labels: ['Feed', 'Labor', 'Veterinary', 'Maintenance'],
          datasets: [{
            data: [15000, 8000, 3500, 2500],
            backgroundColor: [
              'rgba(255, 99, 132, 0.8)',
              'rgba(54, 162, 235, 0.8)',
              'rgba(255, 205, 86, 0.8)',
              'rgba(75, 192, 192, 0.8)'
            ],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true } },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${label}: KES ${value.toLocaleString()} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    <% end %>
  }

  // 3. Prediction Chart
  const predictionCtx = document.getElementById('prediction-chart');
  if (predictionCtx) {
    <% if @prediction_chart && @prediction_chart[:datasets].any? && @prediction_chart[:datasets].first[:data].any? %>
      new Chart(predictionCtx, {
        type: 'line',
        data: <%= raw chart_data_json(@prediction_chart) %>,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            legend: {
              position: 'top'
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              filter: function(tooltipItem) {
                return tooltipItem.parsed.y !== null;
              }
            }
          },
          scales: {
            x: {
              display: true,
              title: {
                display: true,
                text: 'Week'
              }
            },
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Production (L)'
              }
            }
          }
        }
      });
    <% else %>
      new Chart(predictionCtx, {
        type: 'line',
        data: {
          labels: ['01/01', '01/08', '01/15', '01/22', '01/29', '02/05', '02/12', '02/19'],
          datasets: [
            {
              label: 'Historical Production',
              data: [2400, 2650, 2300, 2800, null, null, null, null],
              borderColor: 'rgba(75, 192, 192, 1)',
              backgroundColor: 'rgba(75, 192, 192, 0.2)',
              tension: 0.4
            },
            {
              label: 'Predicted Production',
              data: [null, null, null, null, 2750, 2850, 2900, 2950],
              borderColor: 'rgba(255, 159, 64, 1)',
              backgroundColor: 'rgba(255, 159, 64, 0.2)',
              tension: 0.4,
              borderDash: [10, 5]
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: { legend: { position: 'top' } },
          scales: {
            x: { title: { display: true, text: 'Week' } },
            y: { beginAtZero: true, title: { display: true, text: 'Production (L)' } }
          }
        }
      });
    <% end %>
  }

  // 4. Enhanced Weekly Chart (replacing the simple weekly trend)
  const enhancedWeeklyCtx = document.getElementById('enhanced-weekly-chart');
  if (enhancedWeeklyCtx) {
    <% if @weekly_trend_chart && @weekly_trend_chart[:datasets].any? && @weekly_trend_chart[:datasets].first[:data].any? %>
      new Chart(enhancedWeeklyCtx, {
        type: 'line',
        data: <%= raw chart_data_json(@weekly_trend_chart) %>,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            legend: {
              position: 'top'
            }
          },
          scales: {
            x: {
              display: true,
              title: {
                display: true,
                text: 'Week'
              }
            },
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Production (L)'
              }
            }
          }
        }
      });
    <% else %>
      new Chart(enhancedWeeklyCtx, {
        type: 'line',
        data: {
          labels: ["Week 12/18", "Week 12/25", "Week 01/01", "Week 01/08", "Week 01/15", "Week 01/22"],
          datasets: [
            {
              label: 'Weekly Production (L)',
              data: [2850, 2920, 2780, 3100, 2950, 2880],
              borderColor: "rgba(75, 192, 192, 1)",
              backgroundColor: "rgba(75, 192, 192, 0.2)",
              tension: 0.4,
              fill: true
            },
            {
              label: 'Daily Average',
              data: [407, 417, 397, 443, 421, 411],
              borderColor: "rgba(255, 159, 64, 1)",
              backgroundColor: "rgba(255, 159, 64, 0.2)",
              tension: 0.4,
              borderDash: [5, 5]
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: { legend: { position: 'top' } },
          scales: {
            x: { title: { display: true, text: 'Week' } },
            y: { beginAtZero: true, title: { display: true, text: 'Production (L)' } }
          }
        }
      });
    <% end %>
  }

  console.log('Dashboard charts initialized successfully');
});
</script>

<!-- Enhanced Analytics Section -->
<div class="row g-4 mb-5">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h3 class="gradient-text">üìà Enhanced Analytics Dashboard</h3>
        <p class="text-muted">Advanced analytics including profit/loss analysis, predictions, and cost breakdowns</p>
      </div>
      <div class="d-flex gap-2">
        <span class="badge bg-success">Real-time Data</span>
        <span class="badge bg-info">Predictive Analytics</span>
      </div>
    </div>
  </div>
</div>

<!-- Profit/Loss Metrics Cards -->
<div class="row g-4 mb-5">
  <div class="col-xl-3 col-md-6">
    <div class="card metric-card card-gradient-success text-white h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="metric-value">
              <% if @profit_trends.any? && @profit_trends.values.last[:profit_margin] %>
                <%= number_with_precision(@profit_trends.values.last[:profit_margin], precision: 1) %>%
              <% else %>
                N/A
              <% end %>
            </div>
            <div class="metric-label">Profit Margin</div>
            <div class="metric-change">
              <i class="bi bi-calculator"></i>
              <small>This Month</small>
            </div>
          </div>
          <div class="metric-icon">
            <i class="bi bi-graph-up"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-xl-3 col-md-6">
    <div class="card metric-card card-gradient-info text-white h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="metric-value">
              <% if @profit_trends.any? && @profit_trends.values.last[:total_revenue] %>
                KES <%= number_with_delimiter(@profit_trends.values.last[:total_revenue].to_i) %>
              <% else %>
                N/A
              <% end %>
            </div>
            <div class="metric-label">Monthly Revenue</div>
            <div class="metric-change">
              <i class="bi bi-currency-dollar"></i>
              <small>Current Month</small>
            </div>
          </div>
          <div class="metric-icon">
            <i class="bi bi-cash-stack"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-xl-3 col-md-6">
    <div class="card metric-card card-gradient-warning text-white h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="metric-value">
              <% if @profit_trends.any? && @profit_trends.values.last[:total_costs] %>
                KES <%= number_with_delimiter(@profit_trends.values.last[:total_costs].to_i) %>
              <% else %>
                N/A
              <% end %>
            </div>
            <div class="metric-label">Monthly Costs</div>
            <div class="metric-change">
              <i class="bi bi-graph-down"></i>
              <small>Operating Costs</small>
            </div>
          </div>
          <div class="metric-icon">
            <i class="bi bi-receipt"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-xl-3 col-md-6">
    <div class="card metric-card card-gradient-primary text-white h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="metric-value">
              <% if @production_predictions.any? && @production_predictions[:predictions].first %>
                <%= number_with_precision(@production_predictions[:predictions].first[:predicted_production], precision: 0) %>L
              <% else %>
                N/A
              <% end %>
            </div>
            <div class="metric-label">Next Week Prediction</div>
            <div class="metric-change">
              <i class="bi bi-crystal-ball"></i>
              <small>AI Forecast</small>
            </div>
          </div>
          <div class="metric-icon">
            <i class="bi bi-graph-up-arrow"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Enhanced Analytics Charts - 3x2 Grid -->
<div class="row g-4 mb-5">
  <!-- Profit/Loss Trend -->
  <div class="col-lg-6">
    <div class="card chart-card h-100">
      <div class="card-header border-0 pb-0">
        <h5 class="card-title mb-1">
          <i class="bi bi-graph-up-arrow text-success me-2"></i>
          Profit/Loss Trend Analysis
        </h5>
        <p class="text-muted small mb-0">Monthly revenue, costs, and profit margins over time</p>
      </div>
      <div class="card-body">
        <div class="chart-container" style="height: 350px;" data-turbo-permanent>
          <canvas id="profit-loss-chart"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Cost Breakdown -->
  <div class="col-lg-6">
    <div class="card chart-card h-100">
      <div class="card-header border-0 pb-0">
        <h5 class="card-title mb-1">
          <i class="bi bi-pie-chart-fill text-warning me-2"></i>
          Cost Breakdown Analysis
        </h5>
        <p class="text-muted small mb-0">Current month operational cost distribution</p>
      </div>
      <div class="card-body">
        <div class="chart-container" style="height: 350px;" data-turbo-permanent>
          <canvas id="cost-breakdown-chart"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Predictive Analytics -->
  <div class="col-lg-6">
    <div class="card chart-card h-100">
      <div class="card-header border-0 pb-0">
        <h5 class="card-title mb-1">
          <i class="bi bi-crystal-ball text-primary me-2"></i>
          Production Predictions
        </h5>
        <p class="text-muted small mb-0">AI-powered forecast for next 4 weeks of production</p>
      </div>
      <div class="card-body">
        <div class="chart-container" style="height: 350px;" data-turbo-permanent>
          <canvas id="prediction-chart"></canvas>
        </div>
        <% if @production_predictions.any? && @production_predictions[:confidence] %>
          <div class="mt-3">
            <div class="d-flex justify-content-between align-items-center">
              <small class="text-muted">Prediction Confidence</small>
              <span class="badge bg-<%= @production_predictions[:confidence] > 80 ? 'success' : @production_predictions[:confidence] > 60 ? 'warning' : 'danger' %>">
                <%= number_with_precision(@production_predictions[:confidence], precision: 1) %>%
              </span>
            </div>
            <div class="progress mt-2" style="height: 4px;">
              <div class="progress-bar bg-<%= @production_predictions[:confidence] > 80 ? 'success' : @production_predictions[:confidence] > 60 ? 'warning' : 'danger' %>" 
                   style="width: <%= @production_predictions[:confidence] %>%"></div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
  
  <!-- Enhanced Weekly Trends -->
  <div class="col-lg-6">
    <div class="card chart-card h-100">
      <div class="card-header border-0 pb-0">
        <h5 class="card-title mb-1">
          <i class="bi bi-calendar-week text-info me-2"></i>
          Enhanced Weekly Trends
        </h5>
        <p class="text-muted small mb-0">Weekly production with daily averages and trend analysis</p>
      </div>
      <div class="card-body">
        <div class="chart-container" style="height: 350px;" data-turbo-permanent>
          <canvas id="enhanced-weekly-chart"></canvas>
        </div>
        <% if @weekly_trends.any? %>
          <div class="mt-3">
            <% latest_week = @weekly_trends.keys.sort.last %>
            <% if latest_week && @weekly_trends[latest_week] %>
              <div class="row text-center">
                <div class="col-4">
                  <div class="h6 mb-0"><%= @weekly_trends[latest_week][:production].round(1) %>L</div>
                  <small class="text-muted">This Week</small>
                </div>
                <div class="col-4">
                  <div class="h6 mb-0"><%= @weekly_trends[latest_week][:average_daily].round(1) %>L</div>
                  <small class="text-muted">Daily Avg</small>
                </div>
                <div class="col-4">
                  <% trend = @weekly_trends[latest_week][:trend] %>
                  <% if trend.present? %>
                    <div class="h6 mb-0 text-<%= trend == 'increasing' ? 'success' : 'warning' %>">
                      <i class="bi bi-arrow-<%= trend == 'increasing' ? 'up' : 'down' %>"></i>
                      <%= trend.capitalize %>
                    </div>
                  <% else %>
                    <div class="h6 mb-0 text-info">
                      <i class="bi bi-dash-circle"></i>
                      Stable
                    </div>
                  <% end %>
                  <small class="text-muted">Trend</small>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Recent Activity & Top Performers -->
<div class="alert alert-primary mb-4">
  <div class="d-flex align-items-center">
    <i class="bi bi-info-circle-fill me-2"></i>
    <div>
      <strong>üí° Cow Analytics Available!</strong> 
      Click on any cow name below to view detailed individual production charts, trends, and performance analytics for that specific cow.
    </div>
  </div>
</div>

<div class="row g-4 mb-5">
  <div class="col-lg-4">
    <!-- Top Performing Cows -->
    <div class="card h-100">
      <div class="card-header border-0 pb-0">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h5 class="card-title mb-1">üèÜ Top Performers</h5>
            <p class="text-muted small mb-0">Best milk producers this week</p>
          </div>
          <span class="badge bg-success">This Week</span>
        </div>
      </div>
      <div class="card-body">
        <% @top_cows = Cow.joins(:production_records)
                           .where(production_records: { production_date: 1.week.ago..Date.current })
                           .group(:id)
                           .order('SUM(production_records.total_production) DESC')
                           .limit(5)
                           .pluck(:id, :name, :tag_number, 'SUM(production_records.total_production)')
                           .map { |id, name, tag, total| 
                             { id: id, name: name, tag_number: tag, total_production: total.round(1), 
                               avg_daily: (total / 7).round(1) } 
                           } %>
        
        <% @top_cows.each_with_index do |cow_data, index| %>
          <%= link_to cow_path(cow_data[:id]), class: "text-decoration-none", data: { turbo: false } do %>
            <div class="performer-item d-flex align-items-center mb-3 p-3 rounded <%= 'bg-light' if index == 0 %> clickable-cow">
              <div class="performer-rank me-3">
                <div class="rank-badge <%= index == 0 ? 'rank-gold' : index == 1 ? 'rank-silver' : 'rank-bronze' %>">
                  <%= index + 1 %>
                </div>
              </div>
              <div class="flex-grow-1">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="mb-1 text-dark">
                      <i class="bi bi-cursor-fill text-primary me-1"></i>
                      <%= cow_data[:name] %>
                    </h6>
                    <small class="text-muted">Tag: <%= cow_data[:tag_number] %> ‚Ä¢ <span class="text-primary fw-bold">üñ±Ô∏è Click for detailed analytics</span></small>
                  </div>
                  <div class="text-end">
                    <div class="fw-bold text-primary"><%= cow_data[:total_production] %>L</div>
                    <small class="text-success">+<%= cow_data[:avg_daily] %>L/day</small>
                  </div>
                </div>
              </div>
              <div class="ms-2">
                <i class="bi bi-arrow-right-circle text-primary"></i>
              </div>
            </div>
          <% end %>
        <% end %>
        
        <% if @top_cows.empty? %>
          <div class="text-center py-4">
            <i class="bi bi-heart text-muted" style="font-size: 3rem;"></i>
            <p class="text-muted mt-2">No production data this week yet</p>
            <%= link_to "Start Recording", enhanced_bulk_entry_production_records_path, class: "btn btn-primary btn-sm" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
  
  <div class="col-lg-4">
    <!-- Cow Quick Search & Stats -->
    <div class="card h-100">
      <div class="card-header border-0 pb-0">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h5 class="card-title mb-1">üîç Cow Statistics</h5>
            <p class="text-muted small mb-0">Search and view individual cow details</p>
          </div>
          <%= link_to cows_path, class: "btn btn-outline-primary btn-sm" do %>
            <i class="bi bi-list me-1"></i> All Cows
          <% end %>
        </div>
      </div>
      <div class="card-body">
        <!-- Search Box -->
        <div class="mb-3">
          <div class="input-group">
            <span class="input-group-text">
              <i class="bi bi-search"></i>
            </span>
            <input type="text" 
                   class="form-control" 
                   placeholder="Search cow by name or tag..." 
                   id="cow-search-input"
                   data-controller="cow-search"
                   data-action="input->cow-search#search">
          </div>
        </div>
        
        <!-- Quick Cow Stats -->
        <div id="cow-search-results">
          <% @recent_active_cows.each do |cow| %>
            <%= link_to cow_path(cow), class: "text-decoration-none", data: { turbo: false } do %>
              <div class="cow-item d-flex justify-content-between align-items-center mb-2 p-2 rounded cow-search-item">
                <div>
                  <div class="fw-semibold text-dark">
                    <i class="bi bi-cursor-fill text-primary me-1"></i>
                    <%= cow.name %>
                  </div>
                  <small class="text-muted">Tag: <%= cow.tag_number %> ‚Ä¢ <span class="text-primary">Click to view charts</span></small>
                </div>
                <div class="text-end">
                  <span class="badge bg-info">
                    <%= number_with_precision(cow.avg_production || 0, precision: 1) %>L avg
                  </span>
                  <div class="mt-1">
                    <i class="bi bi-arrow-right-circle text-primary"></i>
                  </div>
                </div>
              </div>
            <% end %>
          <% end %>
          
          <% if @recent_active_cows.empty? %>
            <div class="text-center py-3">
              <i class="bi bi-search text-muted" style="font-size: 2rem;"></i>
              <p class="text-muted mt-2 small">No active cows with recent production</p>
            </div>
          <% end %>
        </div>
        
        <div class="text-center mt-3">
          <%= link_to "View All Cows", cows_path, class: "btn btn-outline-secondary btn-sm" %>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-4">
    <!-- Recent Activity Feed -->
    <div class="card h-100">
      <div class="card-header border-0 pb-0">
        <h5 class="card-title mb-0">üîî Recent Activity</h5>
      </div>
      <div class="card-body">
        <div class="activity-feed">
          <% if @recent_records.any? %>
            <% @recent_records.limit(5).each do |record| %>
              <div class="activity-item d-flex mb-3">
                <div class="activity-icon me-3">
                  <i class="bi bi-droplet-fill text-primary"></i>
                </div>
                <div class="flex-grow-1">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <p class="mb-1">
                        <i class="bi bi-cursor-fill text-primary me-1"></i>
                        <%= link_to record.cow.name, cow_path(record.cow), class: "fw-bold text-decoration-none text-dark cow-link", data: { turbo: false } %> 
                        production recorded
                      </p>
                      <small class="text-muted">
                        <%= record.total_production %>L total ‚Ä¢ 
                        <%= time_ago_in_words(record.updated_at) %> ago ‚Ä¢
                        <span class="text-primary cursor-pointer fw-bold" onclick="window.location='<%= cow_path(record.cow) %>'">üìä View individual charts</span>
                      </small>
                    </div>
                    <span class="badge bg-light text-dark"><%= record.production_date.strftime("%m/%d") %></span>
                  </div>
                </div>
              </div>
            <% end %>
          <% else %>
            <div class="text-center py-4">
              <i class="bi bi-clock-history text-muted" style="font-size: 3rem;"></i>
              <p class="text-muted mt-2">No recent activity</p>
            </div>
          <% end %>
        </div>
        
        <div class="text-center mt-3">
          <%= link_to "View All Records", production_records_path, class: "btn btn-outline-primary btn-sm" %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Enhanced Dashboard Styles -->
<style>
  .hero-section {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    border-radius: var(--border-radius-lg);
    padding: 2rem;
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
  }
  
  .hero-section::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 100%;
    height: 200%;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="2" fill="rgba(102,126,234,0.1)"/></svg>') repeat;
    animation: float 20s linear infinite;
  }
  
  @keyframes float {
    0% { transform: translateY(0px); }
    100% { transform: translateY(-100px); }
  }
  
  .welcome-icon {
    width: 60px;
    height: 60px;
    background: var(--primary-gradient);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    animation: pulse 2s infinite;
    box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
  }
  
  @keyframes pulse {
    0% { transform: scale(1); box-shadow: 0 0 20px rgba(102, 126, 234, 0.3); }
    50% { transform: scale(1.05); box-shadow: 0 0 30px rgba(102, 126, 234, 0.5); }
    100% { transform: scale(1); box-shadow: 0 0 20px rgba(102, 126, 234, 0.3); }
  }
  
  .gradient-text {
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-family: 'Poppins', sans-serif;
    font-weight: 700;
  }
  
  .date-widget {
    text-align: center;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(20px);
    padding: 1.5rem;
    border-radius: var(--border-radius);
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: var(--shadow-md);
  }
  
  .current-date {
    font-size: 1.5rem;
    font-weight: 600;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-family: 'Poppins', sans-serif;
  }
  
  .current-date-sub {
    font-size: 0.9rem;
    color: var(--bs-secondary);
  }
  
  .metric-value {
    font-size: 2.5rem;
    font-weight: 700;
    font-family: 'Poppins', sans-serif;
    line-height: 1;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .metric-label {
    font-size: 0.9rem;
    opacity: 0.9;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .metric-change {
    font-size: 0.75rem;
    opacity: 0.8;
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }
  
  .performer-item {
    transition: all var(--animation-fast);
    border: 2px solid transparent;
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(10px);
  }
  
  .performer-item:hover {
    transform: translateY(-2px);
    border-color: var(--bs-primary);
    background-color: rgba(102, 126, 234, 0.05) !important;
    box-shadow: var(--shadow-md);
  }
  
  .rank-badge {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    font-size: 1.1rem;
    font-family: 'Poppins', sans-serif;
  }
  
  .rank-gold {
    background: linear-gradient(135deg, #FFD700, #FFA500);
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
  }
  
  .rank-silver {
    background: linear-gradient(135deg, #C0C0C0, #808080);
    box-shadow: 0 4px 12px rgba(192, 192, 192, 0.4);
  }
  
  .rank-bronze {
    background: linear-gradient(135deg, #CD7F32, #A0522D);
    box-shadow: 0 4px 12px rgba(205, 127, 50, 0.4);
  }
  
  .activity-icon {
    width: 40px;
    height: 40px;
    background: rgba(102, 126, 234, 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid rgba(102, 126, 234, 0.2);
  }
  
  .chart-container {
    position: relative;
    background: rgba(255, 255, 255, 0.7);
    border-radius: var(--border-radius);
    padding: 1rem;
    backdrop-filter: blur(10px);
  }
  
  .chart-card {
    transition: all var(--animation-fast);
    border: 1px solid rgba(0, 0, 0, 0.08);
    box-shadow: var(--shadow-sm);
  }
  
  .chart-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
    border-color: var(--bs-primary);
  }
  
  .chart-card .card-header {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
    border-bottom: 1px solid rgba(102, 126, 234, 0.1);
  }
  
  .farm-item {
    transition: all var(--animation-fast);
    border: 2px solid transparent;
  }
  
  .farm-item:hover {
    border-color: var(--bs-primary);
    background-color: rgba(102, 126, 234, 0.05) !important;
    transform: translateX(5px);
  }
  
  .clickable-cow {
    cursor: pointer;
    transition: all 0.2s ease;
    border: 2px solid transparent;
  }
  
  .clickable-cow:hover {
    background-color: rgba(102, 126, 234, 0.1) !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    border-color: var(--bs-primary);
    cursor: pointer;
  }
  
  .cow-link {
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .cow-link:hover {
    color: var(--bs-primary) !important;
    text-decoration: underline !important;
    font-weight: 600;
  }
  
  .cow-item {
    transition: all var(--animation-fast);
    border: 1px solid transparent;
    background: rgba(255, 255, 255, 0.5);
  }
  
  .cow-item:hover {
    border-color: var(--bs-primary);
    background-color: rgba(102, 126, 234, 0.05) !important;
    transform: translateX(3px);
    cursor: pointer;
  }
  
  .cursor-pointer {
    cursor: pointer;
  }
  
  .cursor-pointer:hover {
    text-decoration: underline;
  }
  
  .progress {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 10px;
    overflow: hidden;
    height: 8px;
  }
  
  .progress-bar {
    border-radius: 10px;
    transition: width 1.5s ease-in-out;
    background: var(--success-gradient);
  }

  /* System Alerts Widget Styles */
  .bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }

  .alert-sm {
    padding: 0.75rem 1rem;
    margin-bottom: 0.75rem;
    border-radius: 8px;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }

  .alert-sm:hover {
    transform: translateX(3px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  .border-danger { border-color: #dc3545 !important; }
  .border-warning { border-color: #ffc107 !important; }
  .border-info { border-color: #0dcaf0 !important; }
  .border-success { border-color: #198754 !important; }

  .bg-danger-subtle { background-color: rgba(220, 53, 69, 0.1); }
  .bg-warning-subtle { background-color: rgba(255, 193, 7, 0.1); }
  .bg-info-subtle { background-color: rgba(13, 202, 240, 0.1); }
  .bg-success-subtle { background-color: rgba(25, 135, 84, 0.1); }

  .text-danger { color: #dc3545; }
  .text-warning { color: #ffc107; }
  .text-info { color: #0dcaf0; }
  .text-success { color: #198754; }

  .alert-pulse {
    animation: alertPulse 2s infinite;
  }

  @keyframes alertPulse {
    0% { box-shadow: 0 2px 4px rgba(220, 53, 69, 0.1); }
    50% { box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3); }
    100% { box-shadow: 0 2px 4px rgba(220, 53, 69, 0.1); }
  }

  .badge {
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
  }

  /* Alert category icons */
  .alert .bi {
    margin-top: 2px;
  }

  /* Responsive adjustments for alerts */
  @media (max-width: 768px) {
    .alert-sm {
      padding: 0.5rem 0.75rem;
      font-size: 0.85rem;
    }
    
    .alert-sm .btn-sm {
      padding: 0.2rem 0.4rem;
      font-size: 0.75rem;
    }
  }
</style>
