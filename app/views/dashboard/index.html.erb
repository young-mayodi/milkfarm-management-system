<% content_for :title, "Farm Dashboard" %>

<!-- Welcome Hero Section -->
<div class="hero-section mb-5">
  <div class="row align-items-center">
    <div class="col-lg-8">
      <div class="d-flex align-items-center mb-3">
        <div class="welcome-icon me-3">
          <i class="bi bi-sun-fill"></i>
        </div>
        <div>
          <h1 class="display-6 mb-0 gradient-text">
            Good <%= Time.current.hour < 12 ? 'Morning' : Time.current.hour < 17 ? 'Afternoon' : 'Evening' %>!
          </h1>
          <p class="lead text-muted mb-0">Here's what's happening on your farm today</p>
        </div>
      </div>
    </div>
    <div class="col-lg-4 text-end">
      <div class="date-widget">
        <div class="current-date">
          <%= Date.current.strftime("%A") %>
        </div>
        <div class="current-date-sub">
          <%= Date.current.strftime("%B %d, %Y") %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Enhanced Key Metrics Cards -->
<div class="row g-4 mb-5">
  <div class="col-xl-3 col-md-6">
    <div class="card metric-card card-gradient-primary text-white h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="metric-value"><%= @total_farms %></div>
            <div class="metric-label">Total Farms</div>
            <div class="metric-change">
              <i class="bi bi-arrow-up"></i>
              <small>Active & Managed</small>
            </div>
          </div>
          <div class="metric-icon">
            <i class="bi bi-building"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-xl-3 col-md-6">
    <div class="card metric-card card-gradient-success text-white h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="metric-value"><%= @active_cows %></div>
            <div class="metric-label">Active Cows</div>
            <div class="metric-change">
              <i class="bi bi-heart-fill"></i>
              <small><%= @total_cows %> total cows</small>
            </div>
          </div>
          <div class="metric-icon">
            <i class="bi bi-heart-fill"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-xl-3 col-md-6">
    <div class="card metric-card card-gradient-info text-white h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="metric-value"><%= number_with_precision(@today_production, precision: 1) %>L</div>
            <div class="metric-label">Today's Production</div>
            <div class="metric-change">
              <% if @yesterday_production > 0 %>
                <% change_pct = ((@today_production - @yesterday_production) / @yesterday_production * 100).round(1) %>
                <i class="bi bi-arrow-<%= change_pct >= 0 ? 'up' : 'down' %>"></i>
                <small><%= change_pct.abs %>% vs yesterday</small>
              <% else %>
                <i class="bi bi-droplet"></i>
                <small>Fresh start today</small>
              <% end %>
            </div>
          </div>
          <div class="metric-icon">
            <i class="bi bi-droplet-fill"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-xl-3 col-md-6">
    <div class="card metric-card card-gradient-warning text-white h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="metric-value">$<%= number_with_precision(@monthly_revenue, precision: 0) %></div>
            <div class="metric-label">Monthly Revenue</div>
            <div class="metric-change">
              <i class="bi bi-calendar3"></i>
              <small><%= Date.current.strftime("%B") %> earnings</small>
            </div>
          </div>
          <div class="metric-icon">
            <i class="bi bi-currency-dollar"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quick Actions & Status Dashboard -->
<div class="row g-4 mb-5">
  <div class="col-lg-6">
    <!-- Production Chart -->
    <div class="card h-100">
      <div class="card-header border-0 pb-0">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h5 class="card-title mb-1">üìä Production Trends</h5>
            <p class="text-muted small mb-0">Last 7 days milk production</p>
          </div>
          <div class="dropdown">
            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
              <i class="bi bi-three-dots"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="<%= reports_path %>">üìà View Full Report</a></li>
              <li><a class="dropdown-item" href="<%= production_records_path %>">üìã All Records</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="card-body">
        <div class="chart-container" style="height: 300px;">
          <canvas data-controller="chart" 
                  data-chart-type-value="line"
                  data-chart-data-value="<%= {
                    labels: @chart_data[:labels],
                    datasets: [{
                      label: 'Daily Production (L)',
                      data: @chart_data[:data],
                      borderColor: '#667eea',
                      backgroundColor: 'rgba(102, 126, 234, 0.1)',
                      fill: true,
                      tension: 0.4
                    }]
                  }.to_json %>"
                  data-chart-options-value="<%= {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      legend: { display: false }
                    },
                    scales: {
                      y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0, 0, 0, 0.05)' }
                      },
                      x: {
                        grid: { display: false }
                      }
                    }
                  }.to_json %>">
          </canvas>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-6">
    <!-- Quick Actions & Today's Summary -->
    <div class="row g-3 h-100">
      <!-- Quick Actions Card -->
      <div class="col-12">
        <div class="card">
          <div class="card-header border-0 pb-0">
            <h5 class="card-title mb-0">‚ö° Quick Actions</h5>
          </div>
          <div class="card-body">
            <div class="row g-2">
              <div class="col-md-6">
                <%= link_to enhanced_bulk_entry_production_records_path, class: "btn btn-primary w-100" do %>
                  <i class="bi bi-grid-3x3 me-2"></i>
                  Enhanced Entry
                  <span class="badge bg-light text-primary ms-1">NEW</span>
                <% end %>
              </div>
              <div class="col-md-6">
                <%= link_to bulk_entry_production_records_path, class: "btn btn-success w-100" do %>
                  <i class="bi bi-table me-2"></i>
                  Bulk Entry
                <% end %>
              </div>
              <div class="col-md-6">
                <%= link_to new_production_record_path, class: "btn btn-outline-success w-100" do %>
                  <i class="bi bi-plus-circle me-2"></i>
                  Add Record
                <% end %>
              </div>
              <div class="col-md-6">
                <%= link_to cows_path, class: "btn btn-outline-info w-100" do %>
                  <i class="bi bi-heart me-2"></i>
                  Animals
                <% end %>
              </div>
              <div class="col-md-6">
                <% if current_user&.can_view_reports? %>
                  <%= link_to reports_path, class: "btn btn-outline-warning w-100" do %>
                    <i class="bi bi-bar-chart-line me-2"></i>
                    Reports
                  <% end %>
                <% else %>
                  <%= link_to farms_path, class: "btn btn-outline-secondary w-100" do %>
                    <i class="bi bi-building me-2"></i>
                    Farms
                  <% end %>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Today's Summary -->
      <div class="col-12">
        <div class="card bg-gradient-primary text-white">
          <div class="card-body">
            <h6 class="card-title mb-3">üìà Today's Performance</h6>
            <div class="row">
              <div class="col-6">
                <div class="text-center">
                  <div class="h4 mb-0"><%= number_with_precision(@today_production, precision: 1) %>L</div>
                  <small class="opacity-75">Total Production</small>
                </div>
              </div>
              <div class="col-6">
                <div class="text-center">
                  <div class="h4 mb-0"><%= @active_cows %></div>
                  <small class="opacity-75">Active Cows</small>
                </div>
              </div>
            </div>
            <div class="mt-3">
              <div class="d-flex justify-content-between mb-1">
                <small>Production Progress</small>
                <small><%= (@today_production / (@active_cows * 25.0) * 100).round(0) %>%</small>
              </div>
              <div class="progress" style="height: 6px;">
                <div class="progress-bar bg-light" style="width: <%= [(@today_production / (@active_cows * 25.0) * 100), 100].min %>%"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Production Analysis Dashboard -->
<div class="row g-4 mb-5">
  <div class="col-lg-6">
    <!-- Farm Production Today -->
    <div class="card h-100">
      <div class="card-header border-0 pb-0">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h5 class="card-title mb-1">üè¢ Today's Production by Farm</h5>
            <p class="text-muted small mb-0">Current day farm comparison</p>
          </div>
          <%= link_to farms_path, class: "btn btn-outline-primary btn-sm" do %>
            <i class="bi bi-building me-1"></i> View All
          <% end %>
        </div>
      </div>
      <div class="card-body">
        <% if @farm_production_today.any? %>
          <% @farm_production_today.each do |data| %>
            <div class="farm-item d-flex justify-content-between align-items-center mb-3 p-3 rounded bg-light">
              <div>
                <h6 class="mb-1"><%= data[:farm].name %></h6>
                <small class="text-muted"><i class="bi bi-geo-alt me-1"></i><%= data[:farm].location %></small>
              </div>
              <div class="text-end">
                <span class="badge bg-primary fs-6 px-3 py-2">
                  <%= number_with_precision(data[:production], precision: 1) %>L
                </span>
              </div>
            </div>
          <% end %>
        <% else %>
          <div class="text-center py-4">
            <i class="bi bi-building text-muted" style="font-size: 3rem;"></i>
            <p class="text-muted mt-2">No production data for today yet.</p>
            <%= link_to "Start Recording", bulk_entry_production_records_path, class: "btn btn-primary btn-sm" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
  
  <div class="col-lg-6">
    <!-- Recent Production Records -->
    <div class="card h-100">
      <div class="card-header border-0 pb-0">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h5 class="card-title mb-1">üìã Recent Production Records</h5>
            <p class="text-muted small mb-0">Latest milk production entries</p>
          </div>
          <%= link_to new_production_record_path, class: "btn btn-outline-success btn-sm" do %>
            <i class="bi bi-plus-circle me-1"></i> Add New
          <% end %>
        </div>
      </div>
      <div class="card-body">
        <% if @recent_records.any? %>
          <div class="table-responsive">
            <table class="table table-sm table-hover">
              <thead class="table-light">
                <tr>
                  <th>Date</th>
                  <th>Cow</th>
                  <th>Farm</th>
                  <th class="text-end">Total (L)</th>
                </tr>
              </thead>
              <tbody>
                <% @recent_records.limit(6).each do |record| %>
                  <tr>
                    <td>
                      <span class="badge bg-light text-dark">
                        <%= record.production_date.strftime("%m/%d") %>
                      </span>
                    </td>
                    <td>
                      <strong><%= record.cow.name %></strong>
                      <small class="text-muted d-block">Tag: <%= record.cow.tag_number %></small>
                    </td>
                    <td>
                      <small class="text-muted"><%= record.farm.name %></small>
                    </td>
                    <td class="text-end">
                      <span class="badge bg-primary">
                        <%= number_with_precision(record.total_production, precision: 1) %>L
                      </span>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
          <div class="text-center mt-3">
            <%= link_to "View All Records", production_records_path, class: "btn btn-outline-primary btn-sm" %>
          </div>
        <% else %>
          <div class="text-center py-4">
            <i class="bi bi-clipboard-data text-muted" style="font-size: 3rem;"></i>
            <p class="text-muted mt-2">No production records yet.</p>
            <%= link_to "Create First Record", new_production_record_path, class: "btn btn-success btn-sm" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Enhanced Analytics Charts -->
<div class="row g-4 mb-5" data-controller="dashboard" data-dashboard-auto-refresh-value="false" data-dashboard-interval-value="30">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h3 class="gradient-text">üìä Production Analytics</h3>
        <p class="text-muted">Visual insights into milk production performance</p>
      </div>
      <div class="d-flex gap-2">
        <button data-dashboard-target="refreshButton" 
                data-action="click->dashboard#refresh" 
                class="btn btn-outline-primary btn-sm">
          <i class="bi bi-arrow-clockwise me-2"></i>Refresh Data
        </button>
        <button data-action="click->dashboard#toggleAutoRefresh" 
                class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-clock me-2"></i>Auto Refresh
        </button>
      </div>
    </div>
    
    <div data-dashboard-target="lastUpdated" class="small text-muted mb-4">
      <i class="bi bi-clock me-1"></i>
      Last updated: <%= Time.current.strftime("%I:%M %p") %>
    </div>
  </div>
</div>

<!-- Three Balanced Analytics Charts -->
<div class="row g-4 mb-5">
  <div class="col-lg-4">
    <div class="card chart-card h-100">
      <div class="card-header border-0 pb-0">
        <h5 class="card-title mb-1">
          <i class="bi bi-graph-up text-primary me-2"></i>
          Weekly Production Trend
        </h5>
        <p class="text-muted small mb-0">Last 6 weeks of milk production</p>
      </div>
      <div class="card-body">
        <div class="chart-container" style="height: 300px;" data-turbo-permanent>
          <canvas id="weekly-trend-chart"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-4">
    <div class="card chart-card h-100">
      <div class="card-header border-0 pb-0">
        <h5 class="card-title mb-1">
          <i class="bi bi-pie-chart text-success me-2"></i>
          Farm Production Share
        </h5>
        <p class="text-muted small mb-0">Current month farm comparison</p>
      </div>
      <div class="card-body">
        <div class="chart-container" style="height: 300px;" data-turbo-permanent>
          <canvas id="farm-comparison-chart"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-4">
    <div class="card chart-card h-100">
      <div class="card-header border-0 pb-0">
        <h5 class="card-title mb-1">
          <i class="bi bi-bar-chart text-info me-2"></i>
          Production vs Sales
        </h5>
        <p class="text-muted small mb-0">Last 7 days production vs sales</p>
      </div>
      <div class="card-body">
        <div class="chart-container" style="height: 300px;" data-turbo-permanent>
          <canvas id="production-sales-chart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Optional Debug Information (can be removed in production) -->
<% if Rails.env.development? %>
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0 text-muted">
            <i class="bi bi-bug me-2"></i>Chart Debug Information
          </h6>
        </div>
        <div class="card-body">
          <small class="text-muted">
            <strong>Chart Data Status:</strong><br>
            <% if @weekly_trend_chart && @weekly_trend_chart[:datasets] && @weekly_trend_chart[:datasets].first %>
              ‚úÖ Weekly Trend: <%= @weekly_trend_chart[:datasets].first[:data]&.length || 0 %> data points<br>
            <% else %>
              ‚ùå Weekly Trend: No data available<br>
            <% end %>
            <% if @farm_comparison_chart && @farm_comparison_chart[:datasets] && @farm_comparison_chart[:datasets].first %>
              ‚úÖ Farm Comparison: <%= @farm_comparison_chart[:datasets].first[:data]&.length || 0 %> farms<br>
            <% else %>
              ‚ùå Farm Comparison: No data available<br>
            <% end %>
            <% if @production_vs_sales_chart && @production_vs_sales_chart[:datasets] && @production_vs_sales_chart[:datasets].first %>
              ‚úÖ Production vs Sales: <%= @production_vs_sales_chart[:datasets].first[:data]&.length || 0 %> days
            <% else %>
              ‚ùå Production vs Sales: No data available
            <% end %>
          </small>
        </div>
      </div>
    </div>
  </div>
<% end %>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize Weekly Trend Chart
  const weeklyCtx = document.getElementById('weekly-trend-chart');
  if (weeklyCtx) {
    <% if @weekly_trend_chart && @weekly_trend_chart[:datasets].any? && @weekly_trend_chart[:datasets].first[:data].any? %>
      new Chart(weeklyCtx, {
        type: 'line',
        data: <%= raw chart_data_json(@weekly_trend_chart) %>,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    <% else %>
      new Chart(weeklyCtx, {
        type: 'line',
        data: {
          labels: ["Week 1", "Week 2", "Week 3", "Week 4", "Week 5", "Week 6"],
          datasets: [{
            label: "Weekly Production (L)",
            data: [850, 920, 780, 1100, 950, 880],
            borderColor: "rgba(75, 192, 192, 1)",
            backgroundColor: "rgba(75, 192, 192, 0.2)",
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    <% end %>
  }

  // Initialize Farm Comparison Chart
  const farmCtx = document.getElementById('farm-comparison-chart');
  if (farmCtx) {
    <% if @farm_comparison_chart && @farm_comparison_chart[:datasets].any? && @farm_comparison_chart[:datasets].first[:data].any? %>
      new Chart(farmCtx, {
        type: 'doughnut',
        data: <%= raw chart_data_json(@farm_comparison_chart) %>,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    <% else %>
      new Chart(farmCtx, {
        type: 'doughnut',
        data: {
          labels: ["BAMA DAIRY FARM", "Green Valley Dairy"],
          datasets: [{
            label: "Monthly Production (L)",
            data: [2500, 1800],
            backgroundColor: ["rgba(255, 99, 132, 0.8)", "rgba(54, 162, 235, 0.8)"],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } }
        }
      });
    <% end %>
  }

  // Initialize Production vs Sales Chart
  const prodSalesCtx = document.getElementById('production-sales-chart');
  if (prodSalesCtx) {
    <% if @production_vs_sales_chart && @production_vs_sales_chart[:datasets].any? && @production_vs_sales_chart[:datasets].first[:data].any? %>
      new Chart(prodSalesCtx, {
        type: 'line',
        data: <%= raw chart_data_json(@production_vs_sales_chart) %>,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { y: { beginAtZero: true } }
        }
      });
    <% else %>
      new Chart(prodSalesCtx, {
        type: 'line',
        data: {
          labels: ["01/16", "01/17", "01/18", "01/19", "01/20", "01/21", "01/22"],
          datasets: [
            {
              label: "Production (L)",
              data: [450, 520, 380, 490, 460, 510, 480],
              borderColor: "rgba(54, 162, 235, 1)",
              backgroundColor: "rgba(54, 162, 235, 0.2)",
              tension: 0.4
            },
            {
              label: "Sales (L)",
              data: [420, 480, 360, 450, 440, 490, 460],
              borderColor: "rgba(255, 99, 132, 1)",
              backgroundColor: "rgba(255, 99, 132, 0.2)",
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { y: { beginAtZero: true } }
        }
      });
    <% end %>
  }

  console.log('Dashboard charts initialized successfully');
});
</script>

<!-- Recent Activity & Top Performers -->
<div class="alert alert-primary mb-4">
  <div class="d-flex align-items-center">
    <i class="bi bi-info-circle-fill me-2"></i>
    <div>
      <strong>üí° Cow Analytics Available!</strong> 
      Click on any cow name below to view detailed individual production charts, trends, and performance analytics for that specific cow.
    </div>
  </div>
</div>

<div class="row g-4 mb-5">
  <div class="col-lg-4">
    <!-- Top Performing Cows -->
    <div class="card h-100">
      <div class="card-header border-0 pb-0">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h5 class="card-title mb-1">üèÜ Top Performers</h5>
            <p class="text-muted small mb-0">Best milk producers this week</p>
          </div>
          <span class="badge bg-success">This Week</span>
        </div>
      </div>
      <div class="card-body">
        <% @top_cows = Cow.joins(:production_records)
                           .where(production_records: { production_date: 1.week.ago..Date.current })
                           .group(:id)
                           .order('SUM(production_records.total_production) DESC')
                           .limit(5)
                           .pluck(:id, :name, :tag_number, 'SUM(production_records.total_production)')
                           .map { |id, name, tag, total| 
                             { id: id, name: name, tag_number: tag, total_production: total.round(1), 
                               avg_daily: (total / 7).round(1) } 
                           } %>
        
        <% @top_cows.each_with_index do |cow_data, index| %>
          <%= link_to cow_path(cow_data[:id]), class: "text-decoration-none", data: { turbo: false } do %>
            <div class="performer-item d-flex align-items-center mb-3 p-3 rounded <%= 'bg-light' if index == 0 %> clickable-cow">
              <div class="performer-rank me-3">
                <div class="rank-badge <%= index == 0 ? 'rank-gold' : index == 1 ? 'rank-silver' : 'rank-bronze' %>">
                  <%= index + 1 %>
                </div>
              </div>
              <div class="flex-grow-1">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="mb-1 text-dark">
                      <i class="bi bi-cursor-fill text-primary me-1"></i>
                      <%= cow_data[:name] %>
                    </h6>
                    <small class="text-muted">Tag: <%= cow_data[:tag_number] %> ‚Ä¢ <span class="text-primary fw-bold">üñ±Ô∏è Click for detailed analytics</span></small>
                  </div>
                  <div class="text-end">
                    <div class="fw-bold text-primary"><%= cow_data[:total_production] %>L</div>
                    <small class="text-success">+<%= cow_data[:avg_daily] %>L/day</small>
                  </div>
                </div>
              </div>
              <div class="ms-2">
                <i class="bi bi-arrow-right-circle text-primary"></i>
              </div>
            </div>
          <% end %>
        <% end %>
        
        <% if @top_cows.empty? %>
          <div class="text-center py-4">
            <i class="bi bi-heart text-muted" style="font-size: 3rem;"></i>
            <p class="text-muted mt-2">No production data this week yet</p>
            <%= link_to "Start Recording", bulk_entry_production_records_path, class: "btn btn-primary btn-sm" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
  
  <div class="col-lg-4">
    <!-- Cow Quick Search & Stats -->
    <div class="card h-100">
      <div class="card-header border-0 pb-0">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h5 class="card-title mb-1">üîç Cow Statistics</h5>
            <p class="text-muted small mb-0">Search and view individual cow details</p>
          </div>
          <%= link_to cows_path, class: "btn btn-outline-primary btn-sm" do %>
            <i class="bi bi-list me-1"></i> All Cows
          <% end %>
        </div>
      </div>
      <div class="card-body">
        <!-- Search Box -->
        <div class="mb-3">
          <div class="input-group">
            <span class="input-group-text">
              <i class="bi bi-search"></i>
            </span>
            <input type="text" 
                   class="form-control" 
                   placeholder="Search cow by name or tag..." 
                   id="cow-search-input"
                   data-controller="cow-search"
                   data-action="input->cow-search#search">
          </div>
        </div>
        
        <!-- Quick Cow Stats -->
        <div id="cow-search-results">
          <% recent_active_cows = Cow.where(status: 'active')
                                     .joins(:production_records)
                                     .where(production_records: { production_date: 1.week.ago..Date.current })
                                     .group('cows.id')
                                     .select('cows.*, AVG(production_records.total_production) as avg_production')
                                     .limit(5)
                                     .order('avg_production DESC') %>
          
          <% recent_active_cows.each do |cow| %>
            <%= link_to cow_path(cow), class: "text-decoration-none", data: { turbo: false } do %>
              <div class="cow-item d-flex justify-content-between align-items-center mb-2 p-2 rounded cow-search-item">
                <div>
                  <div class="fw-semibold text-dark">
                    <i class="bi bi-cursor-fill text-primary me-1"></i>
                    <%= cow.name %>
                  </div>
                  <small class="text-muted">Tag: <%= cow.tag_number %> ‚Ä¢ <span class="text-primary">Click to view charts</span></small>
                </div>
                <div class="text-end">
                  <span class="badge bg-info">
                    <%= number_with_precision(cow.avg_production || 0, precision: 1) %>L avg
                  </span>
                  <div class="mt-1">
                    <i class="bi bi-arrow-right-circle text-primary"></i>
                  </div>
                </div>
              </div>
            <% end %>
          <% end %>
          
          <% if recent_active_cows.empty? %>
            <div class="text-center py-3">
              <i class="bi bi-search text-muted" style="font-size: 2rem;"></i>
              <p class="text-muted mt-2 small">No active cows with recent production</p>
            </div>
          <% end %>
        </div>
        
        <div class="text-center mt-3">
          <%= link_to "View All Cows", cows_path, class: "btn btn-outline-secondary btn-sm" %>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-4">
    <!-- Recent Activity Feed -->
    <div class="card h-100">
      <div class="card-header border-0 pb-0">
        <h5 class="card-title mb-0">üîî Recent Activity</h5>
      </div>
      <div class="card-body">
        <div class="activity-feed">
          <% if @recent_records.any? %>
            <% @recent_records.limit(5).each do |record| %>
              <div class="activity-item d-flex mb-3">
                <div class="activity-icon me-3">
                  <i class="bi bi-droplet-fill text-primary"></i>
                </div>
                <div class="flex-grow-1">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <p class="mb-1">
                        <i class="bi bi-cursor-fill text-primary me-1"></i>
                        <%= link_to record.cow.name, cow_path(record.cow), class: "fw-bold text-decoration-none text-dark cow-link", data: { turbo: false } %> 
                        production recorded
                      </p>
                      <small class="text-muted">
                        <%= record.total_production %>L total ‚Ä¢ 
                        <%= time_ago_in_words(record.updated_at) %> ago ‚Ä¢
                        <span class="text-primary cursor-pointer fw-bold" onclick="window.location='<%= cow_path(record.cow) %>'">üìä View individual charts</span>
                      </small>
                    </div>
                    <span class="badge bg-light text-dark"><%= record.production_date.strftime("%m/%d") %></span>
                  </div>
                </div>
              </div>
            <% end %>
          <% else %>
            <div class="text-center py-4">
              <i class="bi bi-clock-history text-muted" style="font-size: 3rem;"></i>
              <p class="text-muted mt-2">No recent activity</p>
            </div>
          <% end %>
        </div>
        
        <div class="text-center mt-3">
          <%= link_to "View All Records", production_records_path, class: "btn btn-outline-primary btn-sm" %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Enhanced Dashboard Styles -->
<style>
  .hero-section {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    border-radius: var(--border-radius-lg);
    padding: 2rem;
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
  }
  
  .hero-section::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 100%;
    height: 200%;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="2" fill="rgba(102,126,234,0.1)"/></svg>') repeat;
    animation: float 20s linear infinite;
  }
  
  @keyframes float {
    0% { transform: translateY(0px); }
    100% { transform: translateY(-100px); }
  }
  
  .welcome-icon {
    width: 60px;
    height: 60px;
    background: var(--primary-gradient);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    animation: pulse 2s infinite;
    box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
  }
  
  @keyframes pulse {
    0% { transform: scale(1); box-shadow: 0 0 20px rgba(102, 126, 234, 0.3); }
    50% { transform: scale(1.05); box-shadow: 0 0 30px rgba(102, 126, 234, 0.5); }
    100% { transform: scale(1); box-shadow: 0 0 20px rgba(102, 126, 234, 0.3); }
  }
  
  .gradient-text {
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-family: 'Poppins', sans-serif;
    font-weight: 700;
  }
  
  .date-widget {
    text-align: center;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(20px);
    padding: 1.5rem;
    border-radius: var(--border-radius);
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: var(--shadow-md);
  }
  
  .current-date {
    font-size: 1.5rem;
    font-weight: 600;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-family: 'Poppins', sans-serif;
  }
  
  .current-date-sub {
    font-size: 0.9rem;
    color: var(--bs-secondary);
  }
  
  .metric-value {
    font-size: 2.5rem;
    font-weight: 700;
    font-family: 'Poppins', sans-serif;
    line-height: 1;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .metric-label {
    font-size: 0.9rem;
    opacity: 0.9;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .metric-change {
    font-size: 0.75rem;
    opacity: 0.8;
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }
  
  .performer-item {
    transition: all var(--animation-fast);
    border: 2px solid transparent;
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(10px);
  }
  
  .performer-item:hover {
    transform: translateY(-2px);
    border-color: var(--bs-primary);
    background-color: rgba(102, 126, 234, 0.05) !important;
    box-shadow: var(--shadow-md);
  }
  
  .rank-badge {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    font-size: 1.1rem;
    font-family: 'Poppins', sans-serif;
  }
  
  .rank-gold {
    background: linear-gradient(135deg, #FFD700, #FFA500);
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
  }
  
  .rank-silver {
    background: linear-gradient(135deg, #C0C0C0, #808080);
    box-shadow: 0 4px 12px rgba(192, 192, 192, 0.4);
  }
  
  .rank-bronze {
    background: linear-gradient(135deg, #CD7F32, #A0522D);
    box-shadow: 0 4px 12px rgba(205, 127, 50, 0.4);
  }
  
  .activity-icon {
    width: 40px;
    height: 40px;
    background: rgba(102, 126, 234, 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid rgba(102, 126, 234, 0.2);
  }
  
  .chart-container {
    position: relative;
    background: rgba(255, 255, 255, 0.7);
    border-radius: var(--border-radius);
    padding: 1rem;
    backdrop-filter: blur(10px);
  }
  
  .chart-card {
    transition: all var(--animation-fast);
    border: 1px solid rgba(0, 0, 0, 0.08);
    box-shadow: var(--shadow-sm);
  }
  
  .chart-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
    border-color: var(--bs-primary);
  }
  
  .chart-card .card-header {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
    border-bottom: 1px solid rgba(102, 126, 234, 0.1);
  }
  
  .farm-item {
    transition: all var(--animation-fast);
    border: 2px solid transparent;
  }
  
  .farm-item:hover {
    border-color: var(--bs-primary);
    background-color: rgba(102, 126, 234, 0.05) !important;
    transform: translateX(5px);
  }
  
  .clickable-cow {
    cursor: pointer;
    transition: all 0.2s ease;
    border: 2px solid transparent;
  }
  
  .clickable-cow:hover {
    background-color: rgba(102, 126, 234, 0.1) !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    border-color: var(--bs-primary);
    cursor: pointer;
  }
  
  .cow-link {
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .cow-link:hover {
    color: var(--bs-primary) !important;
    text-decoration: underline !important;
    font-weight: 600;
  }
  
  .cow-item {
    transition: all var(--animation-fast);
    border: 1px solid transparent;
    background: rgba(255, 255, 255, 0.5);
  }
  
  .cow-item:hover {
    border-color: var(--bs-primary);
    background-color: rgba(102, 126, 234, 0.05) !important;
    transform: translateX(3px);
    cursor: pointer;
  }
  
  .cursor-pointer {
    cursor: pointer;
  }
  
  .cursor-pointer:hover {
    text-decoration: underline;
  }
  
  .progress {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 10px;
    overflow: hidden;
    height: 8px;
  }
  
  .progress-bar {
    border-radius: 10px;
    transition: width 1.5s ease-in-out;
    background: var(--success-gradient);
  }
</style>
