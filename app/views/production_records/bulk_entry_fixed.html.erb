<!-- Fixed Bulk Entry Page -->
<% content_for :title, "Bulk Milk Production Entry - FIXED" %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1><i class="bi bi-table me-2"></i>Bulk Production Entry - FIXED</h1>
    <p class="text-muted">Excel-like interface for quick data entry</p>
  </div>
  <div>
    <%= link_to "Regular Entry", new_production_record_path, class: "btn btn-outline-primary me-2" %>
    <%= link_to "Enhanced Entry", enhanced_bulk_entry_production_records_path, class: "btn btn-success me-2" %>
    <%= link_to "View Records", production_records_path, class: "btn btn-outline-secondary" %>
  </div>
</div>

<!-- Date and Farm Selection -->
<div class="card mb-4">
  <div class="card-body">
    <%= form_with url: bulk_entry_production_records_path, method: :get, local: true, class: "row g-3 align-items-end" do |form| %>
      <div class="col-md-4">
        <%= form.label :date, "Production Date", class: "form-label" %>
        <%= form.date_field :date, value: @date, max: Date.current, class: "form-control", id: "production_date" %>
        <div class="form-text">Cannot enter future dates</div>
      </div>
      <div class="col-md-4">
        <%= form.label :farm_id, "Select Farm", class: "form-label" %>
        <%= form.collection_select :farm_id, 
                current_user.accessible_farms, :id, :name, 
                { selected: @farm&.id }, 
                { class: "form-select" } %>
      </div>
      <div class="col-md-4">
        <%= form.submit "Load Data", class: "btn btn-primary w-100" %>
      </div>
    <% end %>
  </div>
</div>

<% if @cows.any? %>
  <!-- Fixed Data Entry Table -->
  <%= form_with url: bulk_update_production_records_path, method: :post, local: true, id: "bulk_entry_form" do |form| %>
    <%= form.hidden_field :date, value: @date %>
    <%= form.hidden_field :farm_id, value: @farm&.id %>
    
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="bi bi-calendar3 me-2"></i>
          <%= @date.strftime("%A, %B %d, %Y") %> - FIXED VERSION
          <span class="badge bg-primary ms-2"><%= @farm.name if @farm %></span>
        </h5>
        <div>
          <button type="button" class="btn btn-secondary btn-sm me-1" id="recalculate_totals" title="Recalculate all totals">
            <i class="bi bi-calculator me-1"></i>Recalc
          </button>
          <button type="submit" class="btn btn-primary btn-sm">
            <i class="bi bi-save me-1"></i>Save All
          </button>
        </div>
      </div>
      
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0" id="production_table">
            <thead class="table-light">
              <tr>
                <th style="width: 200px;">
                  <i class="bi bi-heart me-1"></i>COW NAME
                </th>
                <th style="width: 120px;" class="text-center">
                  <i class="bi bi-sunrise me-1"></i>MORNING
                </th>
                <th style="width: 120px;" class="text-center">
                  <i class="bi bi-sun me-1"></i>NOON  
                </th>
                <th style="width: 120px;" class="text-center">
                  <i class="bi bi-sunset me-1"></i>EVENING
                </th>
                <th style="width: 120px;" class="text-center">
                  <i class="bi bi-calculator me-1"></i>TOTAL
                </th>
              </tr>
            </thead>
            <tbody>
              <% @records.each_with_index do |record, index| %>
                <tr data-cow-id="<%= record.cow.id %>" class="production-row">
                  <td class="cow-name">
                    <div class="d-flex align-items-center">
                      <span class="badge bg-secondary me-2"><%= record.cow.tag_number %></span>
                      <div>
                        <strong><%= record.cow.name %></strong>
                        <br><small class="text-muted"><%= record.cow.breed %></small>
                      </div>
                    </div>
                  </td>
                  <td>
                    <%= form.fields_for "records[#{record.cow.id}]", record do |record_fields| %>
                      <%= record_fields.number_field :morning_production, 
                            value: record.morning_production > 0 ? number_with_precision(record.morning_production, precision: 1) : '',
                            step: 0.1, min: 0, max: 100,
                            class: "form-control text-center production-input morning-input",
                            placeholder: "0.0",
                            data: { 
                              cow_id: record.cow.id,
                              session: 'morning'
                            } %>
                    <% end %>
                  </td>
                  <td>
                    <%= form.fields_for "records[#{record.cow.id}]", record do |record_fields| %>
                      <%= record_fields.number_field :noon_production, 
                            value: record.noon_production > 0 ? number_with_precision(record.noon_production, precision: 1) : '',
                            step: 0.1, min: 0, max: 100,
                            class: "form-control text-center production-input noon-input",
                            placeholder: "0.0",
                            data: { 
                              cow_id: record.cow.id,
                              session: 'noon'
                            } %>
                    <% end %>
                  </td>
                  <td>
                    <%= form.fields_for "records[#{record.cow.id}]", record do |record_fields| %>
                      <%= record_fields.number_field :evening_production, 
                            value: record.evening_production > 0 ? number_with_precision(record.evening_production, precision: 1) : '',
                            step: 0.1, min: 0, max: 100,
                            class: "form-control text-center production-input evening-input",
                            placeholder: "0.0",
                            data: { 
                              cow_id: record.cow.id,
                              session: 'evening'
                            } %>
                    <% end %>
                  </td>
                  <td>
                    <div class="text-center">
                      <span class="badge bg-primary total-display" data-cow-id="<%= record.cow.id %>">
                        <%= number_with_precision(record.total_production, precision: 1) %>L
                      </span>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
            <tfoot class="table-light">
              <tr>
                <th><strong>TOTALS</strong></th>
                <th class="text-center">
                  <span id="morning_total" class="badge bg-warning">0.0L</span>
                </th>
                <th class="text-center">
                  <span id="noon_total" class="badge bg-info">0.0L</span>
                </th>
                <th class="text-center">
                  <span id="evening_total" class="badge bg-success">0.0L</span>
                </th>
                <th class="text-center">
                  <span id="grand_total" class="badge bg-primary fs-6">0.0L</span>
                </th>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  <% end %>

<% else %>
  <div class="text-center py-5">
    <i class="bi bi-exclamation-circle display-1 text-muted"></i>
    <h3 class="mt-3">No cows available</h3>
    <p class="text-muted">Please select a farm and date to view cows</p>
  </div>
<% end %>

<!-- Clean CSS -->
<style>
/* Force morning inputs to be white and editable */
.morning-input {
  background-color: white !important;
  color: #000 !important;
  opacity: 1 !important;
  cursor: text !important;
  border: 2px solid #28a745 !important; /* Green border to show it's working */
}

.morning-input:focus {
  background-color: white !important;
  border-color: #007bff !important;
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
}

.production-input {
  background-color: white !important;
  color: #000 !important;
  opacity: 1 !important;
  border: 1px solid #dee2e6;
  transition: all 0.2s ease;
}

.production-input:focus {
  box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
  border-color: #86b7fe;
}

.production-input:hover {
  border-color: #adb5bd;
}

.total-display {
  font-weight: 600;
  font-size: 0.9rem;
  min-width: 60px;
}

.table th {
  border-bottom: 2px solid #dee2e6;
  font-weight: 600;
}

.cow-name {
  font-weight: 500;
}
</style>

<!-- Clean, Simple JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('ðŸš€ FIXED Bulk Entry System Loading...');
  
  // Force fix morning inputs immediately
  setTimeout(function() {
    console.log('ðŸ”§ Fixing ALL morning input fields...');
    
    const morningInputs = document.querySelectorAll('.morning-input');
    console.log('Found morning inputs:', morningInputs.length);
    
    morningInputs.forEach(function(input, index) {
      // Force enable
      input.disabled = false;
      input.readOnly = false;
      
      // Force styling
      input.style.backgroundColor = 'white';
      input.style.color = '#000';
      input.style.opacity = '1';
      input.style.cursor = 'text';
      input.style.border = '2px solid #28a745';
      
      // Add test event listeners
      input.addEventListener('input', function(e) {
        console.log('âœ… Morning input #' + index + ' working! Value:', e.target.value);
        calculateTotals();
      });
      
      input.addEventListener('focus', function(e) {
        console.log('ðŸŽ¯ Morning input #' + index + ' focused!');
        e.target.style.backgroundColor = 'white';
        e.target.style.borderColor = '#007bff';
      });
      
      console.log('âœ… Fixed morning input #' + index + ':', input.id || input.name);
    });
    
    // Also fix all other production inputs
    document.querySelectorAll('.production-input').forEach(function(input, index) {
      input.disabled = false;
      input.readOnly = false;
      input.style.backgroundColor = 'white';
      input.style.color = '#000';
      input.style.opacity = '1';
      
      input.addEventListener('input', calculateTotals);
      input.addEventListener('change', calculateTotals);
      
      console.log('âœ… Fixed production input #' + index);
    });
    
    // Initial calculation
    calculateTotals();
    
  }, 100);
  
  // Simple total calculation function
  function calculateTotals() {
    console.log('ðŸ§® Calculating totals...');
    
    let morningTotal = 0;
    let noonTotal = 0;
    let eveningTotal = 0;
    let grandTotal = 0;
    
    document.querySelectorAll('.production-row').forEach(function(row) {
      const cowId = row.dataset.cowId;
      
      const morningInput = row.querySelector('.morning-input');
      const noonInput = row.querySelector('.noon-input');
      const eveningInput = row.querySelector('.evening-input');
      const totalDisplay = row.querySelector('.total-display');
      
      const morning = parseFloat(morningInput.value) || 0;
      const noon = parseFloat(noonInput.value) || 0;
      const evening = parseFloat(eveningInput.value) || 0;
      const total = morning + noon + evening;
      
      // Update individual total
      if (totalDisplay) {
        totalDisplay.textContent = total.toFixed(1) + 'L';
        
        // Color coding
        if (total >= 20) {
          totalDisplay.className = 'badge bg-success total-display';
        } else if (total >= 10) {
          totalDisplay.className = 'badge bg-primary total-display';
        } else if (total > 0) {
          totalDisplay.className = 'badge bg-warning total-display';
        } else {
          totalDisplay.className = 'badge bg-secondary total-display';
        }
      }
      
      // Add to session totals
      morningTotal += morning;
      noonTotal += noon;
      eveningTotal += evening;
      grandTotal += total;
    });
    
    // Update footer totals
    const morningTotalEl = document.getElementById('morning_total');
    const noonTotalEl = document.getElementById('noon_total');
    const eveningTotalEl = document.getElementById('evening_total');
    const grandTotalEl = document.getElementById('grand_total');
    
    if (morningTotalEl) morningTotalEl.textContent = morningTotal.toFixed(1) + 'L';
    if (noonTotalEl) noonTotalEl.textContent = noonTotal.toFixed(1) + 'L';
    if (eveningTotalEl) eveningTotalEl.textContent = eveningTotal.toFixed(1) + 'L';
    if (grandTotalEl) grandTotalEl.textContent = grandTotal.toFixed(1) + 'L';
    
    console.log('ðŸ“Š Totals updated - Grand Total:', grandTotal.toFixed(1) + 'L');
  }
  
  // Recalculate button
  const recalcButton = document.getElementById('recalculate_totals');
  if (recalcButton) {
    recalcButton.addEventListener('click', function() {
      calculateTotals();
      this.innerHTML = '<i class="bi bi-check2 me-1"></i>Updated!';
      setTimeout(() => {
        this.innerHTML = '<i class="bi bi-calculator me-1"></i>Recalc';
      }, 1000);
    });
  }
  
  // Global function for testing
  window.testMorningInputs = function() {
    const inputs = document.querySelectorAll('.morning-input');
    console.log('Testing', inputs.length, 'morning inputs...');
    inputs.forEach((input, i) => {
      input.value = (i + 1) * 5; // Test values: 5, 10, 15, etc.
      input.dispatchEvent(new Event('input', { bubbles: true }));
    });
    console.log('âœ… Test values applied!');
  };
  
  console.log('âœ… FIXED Bulk Entry System Ready!');
  console.log('ðŸ’¡ Try typing in the morning column - it should work now!');
  console.log('ðŸ§ª You can also test with: testMorningInputs()');
});
</script>
