<% content_for :title, "Production Entry" %>

<% content_for :header_content do %>
  <div class="container-fluid">
    <!-- ...existing header code... -->
  </div>
<% end %>

<% if @days_back > 3 && @readonly_mode %>
  <!-- Access Control Warning -->
  <div class="alert alert-warning mb-4" role="alert">
    <div class="d-flex align-items-center">
      <i class="bi bi-lock-fill me-3 fs-4"></i>
      <div>
        <h6 class="mb-1">üîí Historical Data Protection Active</h6>
        <p class="mb-0">Records older than 3 days are read-only for regular users. Contact your farm manager or owner to modify historical data.</p>
      </div>
    </div>
  </div>
<% end %>

<!-- Enhanced Header with Status Indicators -->
<div class="bulk-entry-header">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1><i class="bi bi-grid-3x3 me-2 text-primary"></i>Production Entry</h1>
      <p class="text-muted mb-2">Smart data capture for cows and graduated calves</p>
      <% if @readonly_mode %>
        <div class="alert alert-warning d-inline-flex align-items-center py-2 px-3">
          <i class="bi bi-lock-fill me-2"></i>
          <strong>Read-Only Mode:</strong> Records older than 3 days require manager permissions
        </div>
      <% end %>
    </div>
    <div class="header-actions">
      <%= link_to "üìä Analytics", production_records_path, class: "btn btn-outline-success me-2" %>
      <%= link_to "‚ûï Single Entry", new_production_record_path, class: "btn btn-outline-primary me-2" %>
      <%= link_to "üìã All Records", production_records_path, class: "btn btn-outline-secondary" %>
    </div>
  </div>
</div>

<!-- Smart Date and Farm Selection with Validation -->
<div class="selection-card">
  <div class="card mb-4 border-0 shadow-sm">
    <div class="card-body bg-gradient-light">
      <%= form_with url: bulk_entry_production_records_path, method: :get, local: true, class: "smart-selection-form" do |form| %>
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label class="form-label fw-semibold">
              <i class="bi bi-calendar3 me-1 text-primary"></i>Production Date
            </label>
            <%= form.date_field :date, 
                               value: @date, 
                               max: Date.current, 
                               min: Date.current - 30.days,
                               class: "form-control form-control-lg", 
                               id: "production_date" %>
            <div class="form-text">
              <% if @days_back && @days_back > 3 %>
                <span class="text-warning">
                  <i class="bi bi-exclamation-triangle-fill me-1"></i>
                  <%= @days_back %> days old - Manager permission required
                </span>
              <% else %>
                <span class="text-success">
                  <i class="bi bi-check-circle-fill me-1"></i>
                  Editable period (last 30 days)
                </span>
              <% end %>
            </div>
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold">
              <i class="bi bi-building me-1 text-primary"></i>Select Farm
            </label>
            <%= form.collection_select :farm_id, 
                    current_user.accessible_farms, :id, :name, 
                    { selected: @farm&.id }, 
                    { class: "form-select form-select-lg" } %>
            <div class="form-text">
              <% if @farm %>
                <span class="text-info">
                  <i class="bi bi-geo-alt-fill me-1"></i>
                  <%= @cows.count %> active cows available
                </span>
              <% else %>
                Select farm to load cow data
              <% end %>
            </div>
          </div>
          <div class="col-md-4">
            <%= form.submit "üîÑ Load Cow Data", class: "btn btn-primary btn-lg w-100 load-data-btn" %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<% if @cows.any? %>
  <!-- Enhanced Data Entry Form -->
  <%= form_with url: bulk_update_production_records_path, method: :post, local: true, id: "enhanced_bulk_entry_form" do |form| %>
    <%= form.hidden_field :date, value: @date %>
    <%= form.hidden_field :farm_id, value: @farm&.id %>
    
    <!-- Smart Summary Dashboard -->
    <div class="smart-dashboard mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-calendar-check me-2"></i>
            <%= @date.strftime("%A, %B %d, %Y") %>
            <span class="badge bg-light text-primary ms-2"><%= @farm.name if @farm %></span>
          </h5>
          <div class="header-tools">
            <button type="button" class="btn btn-outline-light btn-sm me-1" id="keyboard_shortcuts" title="Keyboard shortcuts">
              <i class="bi bi-keyboard"></i> Help (F1)
            </button>
            <button type="button" class="btn btn-outline-light btn-sm me-1" id="auto_calculate" title="Auto-calculate totals">
              <i class="bi bi-calculator"></i> Auto-Calc
            </button>
            <button type="button" class="btn btn-outline-light btn-sm me-1" id="smart_save_toggle">
              <i class="bi bi-cloud-arrow-up"></i> Smart Save: <span id="smart_save_status">ON</span>
            </button>
            <% unless @readonly_mode %>
              <button type="submit" class="btn btn-success btn-sm" id="save_all_btn">
                <i class="bi bi-save"></i> Save All (<%= @records.count %>)
              </button>
            <% end %>
          </div>
        </div>
        
        <!-- Enhanced Summary Statistics -->
        <div class="smart-summary-stats">
          <div class="row g-0 text-center">
            <div class="col-md-2">
              <div class="stat-item">
                <div class="stat-value text-primary" id="completion_percentage">
                  <%= @summary_stats[:completion_percentage] %>%
                </div>
                <div class="stat-label">Completion</div>
                <div class="progress mt-2" style="height: 4px;">
                  <div class="progress-bar bg-primary" id="completion_bar" 
                       style="width: <%= @summary_stats[:completion_percentage] %>%"></div>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="stat-item">
                <div class="stat-value text-info" id="total_cows"><%= @summary_stats[:total_cows] %></div>
                <div class="stat-label">Total Cows</div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="stat-item">
                <div class="stat-value text-success" id="completed_records">
                  <%= @summary_stats[:completed_records] %>
                </div>
                <div class="stat-label">Completed</div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="stat-item">
                <div class="stat-value text-warning" id="remaining_cows">
                  <%= @summary_stats[:remaining_cows] %>
                </div>
                <div class="stat-label">Remaining</div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="stat-item">
                <div class="stat-value text-primary" id="avg_production">
                  <%= @summary_stats[:average_production] %>L
                </div>
                <div class="stat-label">Avg per Cow</div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="stat-item">
                <div class="stat-value text-success" id="daily_total">
                  <%= @summary_stats[:total_production] %>L
                </div>
                <div class="stat-label">Daily Total</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Smart Quick Fill Tools -->
    <div class="smart-quick-fill mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h6 class="card-title mb-3">
            <i class="bi bi-magic me-2 text-primary"></i>Smart Fill Tools
          </h6>
          <div class="row g-3">
            <!-- Quick Fill Section -->
            <div class="col-md-8">
              <div class="quick-fill-row">
                <div class="row g-2 align-items-center">
                  <div class="col-auto">
                    <label class="form-label fw-semibold mb-0">Fill Empty Cells:</label>
                  </div>
                  <div class="col-2">
                    <input type="number" class="form-control" id="bulk_morning" 
                           placeholder="Morning" step="0.1" min="0" max="50"
                           title="Fill all empty morning cells">
                  </div>
                  <div class="col-2">
                    <input type="number" class="form-control" id="bulk_noon" 
                           placeholder="Noon" step="0.1" min="0" max="50"
                           title="Fill all empty noon cells">
                  </div>
                  <div class="col-2">
                    <input type="number" class="form-control" id="bulk_evening" 
                           placeholder="Evening" step="0.1" min="0" max="50"
                           title="Fill all empty evening cells">
                  </div>
                  <div class="col-auto">
                    <button type="button" class="btn btn-primary" id="apply_smart_fill"
                            <%= 'disabled' if @readonly_mode %>>
                      <i class="bi bi-arrow-down-circle me-1"></i>Apply to Empty
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Quick Actions Section -->
            <div class="col-md-4">
              <div class="quick-actions d-flex gap-2">
                <button type="button" class="btn btn-outline-info" id="copy_previous_day"
                        <%= 'disabled' if @readonly_mode %>
                        title="Copy production from previous day">
                  <i class="bi bi-files me-1"></i>Copy Previous
                </button>
                <button type="button" class="btn btn-outline-warning" id="clear_all_data"
                        <%= 'disabled' if @readonly_mode %>
                        title="Clear all entered data">
                  <i class="bi bi-eraser me-1"></i>Clear All
                </button>
                <button type="button" class="btn btn-outline-secondary" id="reset_form"
                        title="Reset form to original values">
                  <i class="bi bi-arrow-clockwise me-1"></i>Reset
                </button>
              </div>
            </div>
          </div>
          
          <!-- Smart Suggestions -->
          <div class="smart-suggestions mt-3">
            <div class="row g-2">
              <div class="col-auto">
                <span class="badge bg-light text-dark">üí° Smart Suggestions:</span>
              </div>
              <div class="col-auto">
                <button type="button" class="btn btn-outline-success btn-sm" id="suggest_avg_production">
                  Use Farm Average
                </button>
              </div>
              <div class="col-auto">
                <button type="button" class="btn btn-outline-info btn-sm" id="suggest_seasonal">
                  Seasonal Pattern
                </button>
              </div>
              <div class="col-auto">
                <button type="button" class="btn btn-outline-primary btn-sm" id="suggest_cow_history">
                  Use Cow History
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Enhanced Data Entry Table -->
    <div class="enhanced-data-table">
      <div class="card border-0 shadow">
        <div class="card-body p-0">
          <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
            <table class="table table-hover mb-0" id="enhanced_production_table">
              <thead class="table-header sticky-top">
                <tr>
                  <th style="width: 50px;" class="text-center">#</th>
                  <th style="width: 250px; position: sticky; left: 0; background-color: inherit; z-index: 10;">
                    <i class="bi bi-heart-fill me-1 text-danger"></i>ANIMAL DETAILS
                    <div class="session-subtitle">Cows & Graduated Calves</div>
                  </th>
                  <th style="width: 140px;" class="text-center session-header morning-header">
                    <i class="bi bi-sunrise me-1 text-warning"></i>MORNING
                    <div class="session-subtitle">6:00 - 10:00</div>
                  </th>
                  <th style="width: 140px;" class="text-center session-header noon-header">
                    <i class="bi bi-sun me-1 text-info"></i>NOON  
                    <div class="session-subtitle">11:00 - 15:00</div>
                  </th>
                  <th style="width: 140px;" class="text-center session-header evening-header">
                    <i class="bi bi-sunset me-1 text-purple"></i>EVENING
                    <div class="session-subtitle">16:00 - 20:00</div>
                  </th>
                  <th style="width: 120px;" class="text-center total-header">
                    <i class="bi bi-calculator me-1 text-success"></i>TOTAL
                    <div class="session-subtitle">Auto-calculated</div>
                  </th>
                  <th style="width: 100px;" class="text-center">STATUS & ACTIONS</th>
                </tr>
              </thead>
              <tbody>
                <% @records.each_with_index do |record, index| %>
                  <tr data-cow-id="<%= record.cow.id %>" 
                      data-row-index="<%= index %>"
                      class="production-row <%= 'table-success' if @existing_records[record.cow.id]&.total_production&.positive? %>">
                    
                    <!-- Row Number -->
                    <td class="text-center row-number">
                      <span class="badge bg-secondary"><%= index + 1 %></span>
                    </td>
                    
                    <!-- Animal Details -->
                    <td style="position: sticky; left: 0; background-color: white; z-index: 5;" class="cow-details">
                      <div class="d-flex align-items-center">
                        <div class="cow-avatar me-2">
                          <% if record.cow.status == 'graduated_to_dairy' %>
                            <span class="badge bg-success rounded-pill" title="Graduated Calf"><%= record.cow.tag_number %></span>
                          <% else %>
                            <span class="badge bg-primary rounded-pill" title="Adult Cow"><%= record.cow.tag_number %></span>
                          <% end %>
                        </div>
                        <div class="cow-info">
                          <div class="cow-name fw-bold">
                            <%= record.cow.name %>
                            <% if record.cow.status == 'graduated_to_dairy' %>
                              <span class="badge bg-success ms-1" style="font-size: 0.6rem;">ü•õ GRAD</span>
                            <% end %>
                          </div>
                          <div class="cow-meta">
                            <small class="text-muted">
                              <%= record.cow.breed %> ‚Ä¢ 
                              <span class="cow-age">Age: <%= record.cow.age %></span>
                              <% if record.cow.status == 'graduated_to_dairy' %>
                                ‚Ä¢ <span class="text-success fw-bold">Graduated Calf</span>
                              <% end %>
                            </small>
                          </div>
                        </div>
                      </div>
                    </td>
                    
                    <!-- Morning Production -->
                    <td class="text-center production-cell morning-cell">
                      <%= form.fields_for "records[#{record.cow.id}]", record do |record_form| %>
                        <%= record_form.number_field :morning_production, 
                                                   value: (@existing_records[record.cow.id]&.morning_production || ''),
                                                   class: "form-control production-input morning-input #{'is-valid' if @existing_records[record.cow.id]&.morning_production&.positive?}",
                                                   step: 0.1, min: 0, max: 50,
                                                   placeholder: "0.0",
                                                   readonly: @readonly_mode,
                                                   data: { 
                                                     session: 'morning',
                                                     cow_id: record.cow.id,
                                                     row_index: index
                                                   } %>
                      <% end %>
                    </td>
                    
                    <!-- Noon Production -->
                    <td class="text-center production-cell noon-cell">
                      <%= form.fields_for "records[#{record.cow.id}]", record do |record_form| %>
                        <%= record_form.number_field :noon_production, 
                                                   value: (@existing_records[record.cow.id]&.noon_production || ''),
                                                   class: "form-control production-input noon-input #{'is-valid' if @existing_records[record.cow.id]&.noon_production&.positive?}",
                                                   step: 0.1, min: 0, max: 50,
                                                   placeholder: "0.0",
                                                   readonly: @readonly_mode,
                                                   data: { 
                                                     session: 'noon',
                                                     cow_id: record.cow.id,
                                                     row_index: index
                                                   } %>
                      <% end %>
                    </td>
                    
                    <!-- Evening Production -->
                    <td class="text-center production-cell evening-cell">
                      <%= form.fields_for "records[#{record.cow.id}]", record do |record_form| %>
                        <%= record_form.number_field :evening_production, 
                                                   value: (@existing_records[record.cow.id]&.evening_production || ''),
                                                   class: "form-control production-input evening-input #{'is-valid' if @existing_records[record.cow.id]&.evening_production&.positive?}",
                                                   step: 0.1, min: 0, max: 50,
                                                   placeholder: "0.0",
                                                   readonly: @readonly_mode,
                                                   data: { 
                                                     session: 'evening',
                                                     cow_id: record.cow.id,
                                                     row_index: index
                                                   } %>
                      <% end %>
                    </td>
                    
                    <!-- Total Production (Auto-calculated) -->
                    <td class="text-center total-cell">
                      <div class="total-display">
                        <span class="total-value fw-bold text-success" id="total_<%= record.cow.id %>">
                          <%= (@existing_records[record.cow.id]&.total_production || 0.0).round(1) %>L
                        </span>
                      </div>
                    </td>
                    
                    <!-- Status and Actions -->
                    <td class="text-center status-actions">
                      <div class="status-indicators">
                        <% if @existing_records[record.cow.id]&.total_production&.positive? %>
                          <span class="badge bg-success" title="Record completed">
                            <i class="bi bi-check-circle-fill"></i>
                          </span>
                        <% else %>
                          <span class="badge bg-warning" title="Pending entry">
                            <i class="bi bi-clock-fill"></i>
                          </span>
                        <% end %>
                      </div>
                      <div class="row-actions mt-1">
                        <button type="button" class="btn btn-outline-primary btn-xs copy-previous" 
                                data-cow-id="<%= record.cow.id %>"
                                <%= 'disabled' if @readonly_mode %>
                                title="Copy from previous day">
                          <i class="bi bi-files"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-xs clear-row" 
                                data-cow-id="<%= record.cow.id %>"
                                <%= 'disabled' if @readonly_mode %>
                                title="Clear this row">
                          <i class="bi bi-x"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Enhanced Footer with Save Actions -->
        <div class="card-footer bg-light">
          <div class="d-flex justify-content-between align-items-center">
            <div class="save-info">
              <span class="text-muted me-3">
                <i class="bi bi-info-circle me-1"></i>
                <span id="unsaved_changes">No unsaved changes</span>
              </span>
              <span class="save-status-indicator">
                <i class="bi bi-cloud-check text-muted"></i> Auto-saved
              </span>
            </div>
            <div class="save-actions">
              <% unless @readonly_mode %>
                <button type="button" class="btn btn-outline-secondary me-2" id="save_draft">
                  <i class="bi bi-file-earmark me-1"></i>Save Draft
                </button>
                <button type="submit" class="btn btn-success btn-lg" id="final_save">
                  <i class="bi bi-check-circle me-1"></i>
                  Save All Production Records
                  <span class="badge bg-white text-success ms-1" id="save_count"><%= @records.count %></span>
                </button>
              <% else %>
                <div class="text-muted">
                  <i class="bi bi-lock-fill me-1"></i>
                  Contact your administrator to edit historical records
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
    
  <% end %>

<% else %>
  <!-- Empty State with Guidance -->
  <div class="empty-state text-center py-5">
    <div class="card border-0 shadow-sm">
      <div class="card-body py-5">
        <i class="bi bi-inbox display-1 text-muted mb-3"></i>
        <h3>No Cows Available</h3>
        <p class="text-muted mb-4">
          Please select a farm and date to load cow data for bulk entry.
        </p>
        <div class="empty-actions">
          <%= link_to "Manage Cows", cows_path, class: "btn btn-primary me-2" %>
          <%= link_to "View Farms", farms_path, class: "btn btn-outline-secondary" %>
        </div>
      </div>
    </div>
  </div>
<% end %>

<!-- Enhanced Keyboard Shortcuts Modal -->
<div class="modal fade" id="shortcutsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-keyboard me-2"></i>Keyboard Shortcuts & Tips
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row g-4">
          <div class="col-md-6">
            <h6 class="fw-bold text-primary">Navigation</h6>
            <ul class="list-unstyled">
              <li><kbd>Tab</kbd> / <kbd>Enter</kbd> - Next field</li>
              <li><kbd>Shift</kbd> + <kbd>Tab</kbd> - Previous field</li>
              <li><kbd>‚Üë</kbd> <kbd>‚Üì</kbd> - Move up/down rows</li>
              <li><kbd>F1</kbd> - Show this help</li>
            </ul>
          </div>
          <div class="col-md-6">
            <h6 class="fw-bold text-success">Actions</h6>
            <ul class="list-unstyled">
              <li><kbd>Ctrl</kbd> + <kbd>S</kbd> - Save all</li>
              <li><kbd>Ctrl</kbd> + <kbd>Z</kbd> - Undo last change</li>
              <li><kbd>Del</kbd> - Clear current field</li>
              <li><kbd>Esc</kbd> - Cancel current action</li>
            </ul>
          </div>
        </div>
        <hr>
        <h6 class="fw-bold text-info">Pro Tips</h6>
        <ul class="list-unstyled">
          <li>‚Ä¢ Type values quickly - totals calculate automatically</li>
          <li>‚Ä¢ Use decimal point (.) for precise measurements</li>
          <li>‚Ä¢ Empty fields are treated as 0.0L</li>
          <li>‚Ä¢ Changes are highlighted in real-time</li>
          <li>‚Ä¢ Auto-save keeps your progress safe</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Enhanced CSS Styling -->
<style>
  /* Enhanced Bulk Entry Styling */
  .bulk-entry-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    color: white;
  }
  
  .selection-card .card {
    border-radius: 12px;
    overflow: hidden;
  }
  
  .bg-gradient-light {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  }
  
  .smart-dashboard .card {
    border-radius: 12px;
    overflow: hidden;
  }
  
  .smart-summary-stats {
    background: #f8f9fa;
    padding: 20px;
  }
  
  .stat-item {
    padding: 10px;
  }
  
  .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 5px;
  }
  
  .stat-label {
    font-size: 0.85rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .smart-quick-fill .card {
    border-radius: 8px;
  }
  
  .enhanced-data-table .card {
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  }
  
  .table-header {
    background: linear-gradient(135deg, #495057 0%, #343a40 100%);
    color: white;
  }
  
  .table-header th {
    border: none;
    padding: 15px 8px;
    font-weight: 600;
    font-size: 0.85rem;
  }
  
  .session-header {
    position: relative;
  }
  
  .session-subtitle {
    font-size: 0.7rem;
    font-weight: 400;
    opacity: 0.8;
    margin-top: 2px;
  }
  
  .morning-header {
    background: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%);
  }
  
  .noon-header {
    background: linear-gradient(135deg, #17a2b8 0%, #007bff 100%);
  }
  
  .evening-header {
    background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
  }
  
  .total-header {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
  }
  
  .production-row {
    transition: all 0.2s ease;
  }
  
  .production-row:hover {
    background-color: #f8f9fa;
    transform: scale(1.01);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  
  .cow-details {
    border-right: 3px solid #e9ecef;
  }
  
  .cow-avatar .badge {
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
  }
  
  .cow-name {
    font-size: 0.95rem;
    color: #2d3748;
  }
  
  .cow-meta {
    font-size: 0.75rem;
  }
  
  .production-input {
    border: 2px solid transparent;
    transition: all 0.2s ease;
    text-align: center;
    font-weight: 500;
    font-size: 0.9rem;
  }
  
  .production-input:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    transform: scale(1.05);
  }
  
  .production-input.is-valid {
    border-color: #28a745;
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
  }
  
  .production-input.is-invalid {
    border-color: #dc3545;
    background: linear-gradient(135deg, #f8d7da 0%, #f1b0b7 100%);
  }
  
  .total-value {
    font-size: 1.1rem;
    padding: 8px 12px;
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    border-radius: 6px;
    border: 2px solid #28a745;
    display: inline-block;
    min-width: 60px;
  }
  
  .status-indicators .badge {
    font-size: 0.8rem;
    padding: 6px 8px;
  }
  
  .row-actions .btn-xs {
    font-size: 0.7rem;
    padding: 2px 6px;
    margin: 1px;
  }
  
  .empty-state .card {
    border-radius: 12px;
  }
  
  .form-control-lg, .form-select-lg {
    border-radius: 8px;
    border-width: 2px;
  }
  
  .load-data-btn {
    border-radius: 8px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .quick-fill-row {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #e9ecef;
  }
  
  .smart-suggestions .badge {
    font-size: 0.8rem;
    padding: 6px 8px;
  }
  
  /* Responsive improvements */
  @media (max-width: 768px) {
    .bulk-entry-header h1 {
      font-size: 1.5rem;
    }
    
    .header-actions {
      margin-top: 15px;
    }
    
    .stat-value {
      font-size: 1.2rem;
    }
    
    .production-input {
      font-size: 0.8rem;
      padding: 6px 8px;
    }
    
    .cow-name {
      font-size: 0.85rem;
    }
  }
  
  /* Animation for unsaved changes */
  @keyframes pulse-warning {
    0% { background-color: #fff3cd; }
    50% { background-color: #ffeaa7; }
    100% { background-color: #fff3cd; }
  }
  
  .has-unsaved-changes {
    animation: pulse-warning 2s infinite;
  }
  
  /* Spinning animation for auto-save indicator */
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .spin {
    animation: spin 1s linear infinite;
  }
  
  /* Focus improvements */
  .production-input:focus + .total-value {
    box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.25);
  }

  /* Debug CSS Override - Remove any background issues on morning inputs */
  .morning-input {
    background-color: white !important;
    color: #000 !important;
    opacity: 1 !important;
    pointer-events: auto !important;
  }
  
  .morning-input:focus {
    background-color: #fff !important;
    border-color: #007bff !important;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
  }
  
  .morning-input:disabled,
  .morning-input[readonly] {
    background-color: #e9ecef !important;
    opacity: 0.6 !important;
  }
  
  /* Ensure all production inputs are properly styled */
  .production-input {
    background-color: white !important;
    color: #000 !important;
    opacity: 1 !important;
    cursor: text !important;
  }
  
  /* Animation for unsaved changes */
</style>

<!-- Enhanced JavaScript for Improved UX -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Enhanced Bulk Entry System Loaded');
    
    // Enhanced bulk entry functionality
    const BulkEntryEnhanced = {
        init() {
            this.setupEventListeners();
            this.setupKeyboardShortcuts();
            this.setupSmartCalculations();
            this.setupAutoSave();
            this.setupSmartFill();
            this.loadInitialData();
        },
        
        setupEventListeners() {
            // Production input listeners with smart validation
            document.querySelectorAll('.production-input').forEach(input => {
                input.addEventListener('input', this.handleProductionInput.bind(this));
                input.addEventListener('focus', this.handleInputFocus.bind(this));
                input.addEventListener('blur', this.handleInputBlur.bind(this));
            });
            
            // Smart fill button
            document.getElementById('apply_smart_fill')?.addEventListener('click', this.applySmartFill.bind(this));
            
            // Clear actions
            document.getElementById('clear_all_data')?.addEventListener('click', this.clearAllData.bind(this));
            document.querySelectorAll('.clear-row').forEach(btn => {
                btn.addEventListener('click', this.clearRow.bind(this));
            });
            
            // Copy previous day
            document.querySelectorAll('.copy-previous').forEach(btn => {
                btn.addEventListener('click', this.copyPreviousDay.bind(this));
            });
            
            // Help modal
            document.getElementById('keyboard_shortcuts')?.addEventListener('click', this.showShortcuts.bind(this));
        },
        
        setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // F1 for help
                if (e.key === 'F1') {
                    e.preventDefault();
                    this.showShortcuts();
                }
                
                // Ctrl+S for save
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    this.saveAllData();
                }
                
                // Enhanced navigation
                if (e.target.classList.contains('production-input')) {
                    if (e.key === 'Enter' || e.key === 'Tab') {
                        this.navigateToNextInput(e.target, e.shiftKey);
                    } else if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                        e.preventDefault();
                        this.navigateVertically(e.target, e.key === 'ArrowUp' ? -1 : 1);
                    }
                }
            });
        },
        
        setupSmartCalculations() {
            // Auto-calculate totals when any production input changes
            this.calculateAllTotals();
        },
        
        handleProductionInput(e) {
            const input = e.target;
            const value = parseFloat(input.value) || 0;
            
            // Validate input range
            if (value > 50) {
                input.classList.add('is-invalid');
                this.showTooltip(input, 'Maximum 50L per session');
            } else {
                input.classList.remove('is-invalid');
                if (value > 0) {
                    input.classList.add('is-valid');
                }
            }
            
            // Update total for this cow
            this.updateCowTotal(input.dataset.cowId);
            
            // Update summary statistics
            this.updateSummaryStats();
            
            // Mark as having unsaved changes
            this.markUnsavedChanges();
        },
        
        updateCowTotal(cowId) {
            const morningInput = document.querySelector(`[data-cow-id="${cowId}"][data-session="morning"]`);
            const noonInput = document.querySelector(`[data-cow-id="${cowId}"][data-session="noon"]`);
            const eveningInput = document.querySelector(`[data-cow-id="${cowId}"][data-session="evening"]`);
            const totalDisplay = document.getElementById(`total_${cowId}`);
            
            if (morningInput && noonInput && eveningInput && totalDisplay) {
                const morning = parseFloat(morningInput.value) || 0;
                const noon = parseFloat(noonInput.value) || 0;
                const evening = parseFloat(eveningInput.value) || 0;
                const total = (morning + noon + evening).toFixed(1);
                
                totalDisplay.textContent = `${total}L`;
                
                // Update row status
                const row = morningInput.closest('.production-row');
                if (total > 0) {
                    row.classList.add('table-success');
                } else {
                    row.classList.remove('table-success');
                }
            }
        },
        
        updateSummaryStats() {
            let completedRecords = 0;
            let totalProduction = 0;
            const totalCows = document.querySelectorAll('.production-row').length;
            
            document.querySelectorAll('.total-value').forEach(display => {
                const value = parseFloat(display.textContent.replace('L', '')) || 0;
                if (value > 0) {
                    completedRecords++;
                    totalProduction += value;
                }
            });
            
            const completionPercentage = totalCows > 0 ? (completedRecords / totalCows * 100).toFixed(1) : 0;
            const averageProduction = completedRecords > 0 ? (totalProduction / completedRecords).toFixed(1) : 0;
            
            // Update UI elements
            document.getElementById('completion_percentage').textContent = `${completionPercentage}%`;
            document.getElementById('completion_bar').style.width = `${completionPercentage}%`;
            document.getElementById('completed_records').textContent = completedRecords;
            document.getElementById('remaining_cows').textContent = totalCows - completedRecords;
            document.getElementById('avg_production').textContent = `${averageProduction}L`;
            document.getElementById('daily_total').textContent = `${totalProduction.toFixed(1)}L`;
        },
        
        applySmartFill() {
            const morningValue = document.getElementById('bulk_morning').value;
            const noonValue = document.getElementById('bulk_noon').value;
            const eveningValue = document.getElementById('bulk_evening').value;
            
            let fillCount = 0;
            
            document.querySelectorAll('.production-input').forEach(input => {
                const session = input.dataset.session;
                let valueToFill = null;
                
                if (session === 'morning' && morningValue) valueToFill = morningValue;
                else if (session === 'noon' && noonValue) valueToFill = noonValue;
                else if (session === 'evening' && eveningValue) valueToFill = eveningValue;
                
                if (valueToFill && (!input.value || input.value === '0')) {
                    input.value = valueToFill;
                    input.classList.add('is-valid');
                    this.updateCowTotal(input.dataset.cowId);
                    fillCount++;
                }
            });
            
            this.updateSummaryStats();
            this.showNotification(`‚úÖ Filled ${fillCount} empty cells`, 'success');
            
            // Clear bulk fill inputs
            ['bulk_morning', 'bulk_noon', 'bulk_evening'].forEach(id => {
                document.getElementById(id).value = '';
            });
        },
        
        clearAllData() {
            if (confirm('Are you sure you want to clear all entered data? This cannot be undone.')) {
                document.querySelectorAll('.production-input').forEach(input => {
                    input.value = '';
                    input.classList.remove('is-valid', 'is-invalid');
                });
                
                document.querySelectorAll('.total-value').forEach(display => {
                    display.textContent = '0.0L';
                });
                
                document.querySelectorAll('.production-row').forEach(row => {
                    row.classList.remove('table-success');
                });
                
                this.updateSummaryStats();
                this.showNotification('üßπ All data cleared', 'warning');
            }
        },
        
        clearRow(e) {
            const cowId = e.target.closest('button').dataset.cowId;
            const inputs = document.querySelectorAll(`[data-cow-id="${cowId}"].production-input`);
            
            inputs.forEach(input => {
                input.value = '';
                input.classList.remove('is-valid', 'is-invalid');
            });
            
            this.updateCowTotal(cowId);
            this.updateSummaryStats();
            this.showNotification(`üóëÔ∏è Cleared data for cow #${cowId}`, 'info');
        },
        
        navigateToNextInput(currentInput, reverse = false) {
            const inputs = Array.from(document.querySelectorAll('.production-input'));
            const currentIndex = inputs.indexOf(currentInput);
            
            if (reverse) {
                const prevInput = inputs[currentIndex - 1];
                if (prevInput) {
                    prevInput.focus();
                    prevInput.select();
                }
            } else {
                const nextInput = inputs[currentIndex + 1];
                if (nextInput) {
                    nextInput.focus();
                    nextInput.select();
                }
            }
        },
        
        navigateVertically(currentInput, direction) {
            const currentRow = parseInt(currentInput.dataset.rowIndex);
            const session = currentInput.dataset.session;
            const targetRow = currentRow + direction;
            
            const targetInput = document.querySelector(
                `[data-session="${session}"][data-row-index="${targetRow}"]`
            );
            
            if (targetInput) {
                targetInput.focus();
                targetInput.select();
            }
        },
        
        handleInputFocus(e) {
            e.target.select();
        },
        
        handleInputBlur(e) {
            const input = e.target;
            if (input.value && !input.classList.contains('is-valid') && !input.classList.contains('is-invalid')) {
                input.classList.add('is-valid');
            }
        },
        
        setupAutoSave() {
            // Auto-save functionality every 30 seconds if there are unsaved changes
            setInterval(() => {
                if (this.hasUnsavedChanges) {
                    this.saveDraft();
                }
            }, 30000);
            
            // Add click listener for manual save draft button
            document.getElementById('save_draft')?.addEventListener('click', () => {
                this.saveDraft();
            });
        },
        
        async saveDraft() {
            // Show saving indicator
            const saveIndicator = document.getElementById('unsaved_changes');
            const originalContent = saveIndicator.innerHTML;
            saveIndicator.innerHTML = '<i class="bi bi-arrow-clockwise spin me-1"></i>Saving draft...';
            
            try {
                const formData = new FormData(document.getElementById('enhanced_bulk_entry_form'));
                
                const response = await fetch('/production_records/save_draft', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content')
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    this.hasUnsavedChanges = false;
                    saveIndicator.innerHTML = 
                        `<i class="bi bi-check-circle-fill text-success me-1"></i>Auto-saved at ${result.timestamp}`;
                    
                    // Show subtle success notification
                    this.showNotification(`üíæ ${result.message}`, 'success');
                    
                    console.log('‚úÖ Draft auto-saved successfully:', result);
                } else {
                    console.error('‚ùå Auto-save failed:', result.message);
                    saveIndicator.innerHTML = originalContent;
                    this.showNotification(`‚ùå Auto-save failed: ${result.message}`, 'danger');
                }
                
            } catch (error) {
                console.error('‚ùå Auto-save error:', error);
                saveIndicator.innerHTML = originalContent;
                this.showNotification('‚ùå Auto-save failed due to connection error', 'danger');
            }
        },
        
        markUnsavedChanges() {
            this.hasUnsavedChanges = true;
            document.getElementById('unsaved_changes').innerHTML = 
                '<i class="bi bi-exclamation-triangle-fill text-warning me-1"></i>You have unsaved changes';
        },
        
        showShortcuts() {
            const modal = new bootstrap.Modal(document.getElementById('shortcutsModal'));
            modal.show();
        },
        
        saveAllData() {
            const form = document.getElementById('enhanced_bulk_entry_form');
            if (form) {
                form.submit();
            }
        },
        
        showNotification(message, type = 'info') {
            // Create toast notification
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" 
                            data-bs-dismiss="toast"></button>
                </div>
            `;
            
            // Add to toast container or create one
            let container = document.querySelector('.toast-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'toast-container position-fixed top-0 end-0 p-3';
                document.body.appendChild(container);
            }
            
            container.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            // Remove after showing
            toast.addEventListener('hidden.bs.toast', () => toast.remove());
        },
        
        loadInitialData() {
            // Calculate initial totals and stats
            this.calculateAllTotals();
            this.updateSummaryStats();
        },
        
        calculateAllTotals() {
            document.querySelectorAll('[data-cow-id]').forEach(element => {
                const cowId = element.dataset.cowId;
                if (cowId) {
                    this.updateCowTotal(cowId);
                }
            });
        }
    };
    
    // Initialize the enhanced bulk entry system
    BulkEntryEnhanced.init();
    
    // DEBUG: Force enable all morning inputs
    console.log('üîß DEBUG: Forcing morning inputs to be enabled...');
    document.querySelectorAll('.morning-input').forEach(input => {
        input.disabled = false;
        input.readOnly = false;
        input.style.backgroundColor = 'white';
        input.style.color = '#000';
        input.style.opacity = '1';
        input.style.cursor = 'text';
        console.log('Fixed input:', input.id);
    });
    
    // Add event listener to test if inputs are working
    document.querySelectorAll('.morning-input').forEach(input => {
        input.addEventListener('input', (e) => {
            console.log('‚úÖ Morning input working:', e.target.id, 'value:', e.target.value);
        });
        
        input.addEventListener('focus', (e) => {
            console.log('üéØ Morning input focused:', e.target.id);
            e.target.style.backgroundColor = 'white';
            e.target.style.borderColor = '#007bff';
        });
    });
});
</script>
