<% content_for :title, "Production Trends Report" %>

<div class="container-fluid">
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-md-8">
      <h2 class="display-4">
        <i class="fas fa-chart-line text-primary"></i>
        Production Trends Report
      </h2>
      <p class="lead text-muted">
        Detailed analysis of cow production by milking periods
        <% if @farm %>
          for <strong><%= @farm.name %></strong>
        <% end %>
        (<%= @start_date.strftime("%B %d, %Y") %> - <%= @end_date.strftime("%B %d, %Y") %>)
      </p>
    </div>
    <div class="col-md-4 text-end">
      <%= link_to "Export to CSV", production_trends_production_records_path(format: 'csv', farm_id: params[:farm_id], start_date: @start_date, end_date: @end_date), 
          class: "btn btn-success" %>
    </div>
  </div>

  <!-- Filter Section -->
  <div class="card mb-4">
    <div class="card-body">
      <%= form_with url: production_trends_production_records_path, method: :get, local: true, class: "row g-3" do |form| %>
        <div class="col-md-3">
          <%= form.label :farm_id, "Farm", class: "form-label" %>
          <%= form.select :farm_id, options_from_collection_for_select(@farms, :id, :name, params[:farm_id]), 
              { prompt: "All Farms" }, { class: "form-select" } %>
        </div>
        <div class="col-md-3">
          <%= form.label :start_date, "Start Date", class: "form-label" %>
          <%= form.date_field :start_date, value: @start_date, class: "form-control" %>
        </div>
        <div class="col-md-3">
          <%= form.label :end_date, "End Date", class: "form-label" %>
          <%= form.date_field :end_date, value: @end_date, class: "form-control" %>
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <%= form.submit "Generate Report", class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>

  <% if @trends_data&.key?(:summary) %>
    <!-- Summary Statistics -->
    <div class="row mb-4">
      <div class="col-lg-8">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">üìä Summary Statistics</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <h6 class="text-muted">Period Overview</h6>
                <% if @trends_data[:summary][:totals] %>
                  <ul class="list-unstyled">
                    <li><strong>Total Records:</strong> <%= @trends_data[:summary][:total_records] %></li>
                    <li><strong>Period Days:</strong> <%= @trends_data[:summary][:period_days] %></li>
                    <li><strong>Unique Cows:</strong> <%= @trends_data[:summary][:unique_cows] %></li>
                    <li><strong>Grand Total:</strong> <%= @trends_data[:summary][:totals][:grand_total] %>L</li>
                  </ul>
                <% else %>
                  <div class="alert alert-info">
                    <%= @trends_data[:summary][:message] || "No production data available for the selected period." %>
                  </div>
                <% end %>
              </div>
              <div class="col-md-6">
                <h6 class="text-muted">Milking Period Breakdown</h6>
                <% if @trends_data[:summary][:totals] %>
                  <div class="row">
                    <% %w[morning noon evening night].each do |period| %>
                      <div class="col-6 mb-2">
                        <div class="border rounded p-2 text-center">
                          <div class="h6 mb-1 text-<%= case period
                            when 'morning' then 'warning'
                            when 'noon' then 'danger'
                            when 'evening' then 'info'
                            when 'night' then 'dark'
                            end %>">
                            <%= period.titleize %>
                          </div>
                          <div class="small">
                            <%= @trends_data[:summary][:totals][period.to_sym] %>L 
                            (<%= @trends_data[:summary][:percentages][period.to_sym] %>%)
                          </div>
                        </div>
                      </div>
                    <% end %>
                  </div>
                <% else %>
                  <div class="alert alert-info">
                    <small>No production data available for period breakdown.</small>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">üèÜ Top Performers</h5>
          </div>
          <div class="card-body">
            <% if @trends_data[:summary][:peak_performers] && @trends_data[:summary][:peak_performers][:total] %>
              <div class="text-center">
                <h6 class="text-success">Best Overall Production</h6>
                <p class="mb-1"><strong><%= @trends_data[:summary][:peak_performers][:total][:cow_name] %></strong></p>
                <p class="text-muted small">
                  <%= @trends_data[:summary][:peak_performers][:total][:value] %>L on 
                  <%= @trends_data[:summary][:peak_performers][:total][:date] %>
                </p>
              </div>
            <% else %>
              <p class="text-muted text-center">No production data available</p>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="row mb-4">
      <div class="col-lg-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Production Distribution by Period</h5>
          </div>
          <div class="card-body">
            <canvas id="distributionChart"></canvas>
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Daily Production Trends</h5>
          </div>
          <div class="card-body">
            <canvas id="trendsChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Analytics: Daily Totals Summary -->
    <div class="row mb-4">
      <div class="col-lg-8">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">üìä Daily Totals & Milking Time Breakdown</h5>
            <small class="text-muted">Total production by day and milking period</small>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-bordered table-sm" id="dailyTotalsTable">
                <thead class="table-light">
                  <tr>
                    <th>Date</th>
                    <th class="text-warning">üåÖ Morning</th>
                    <th class="text-danger">‚òÄÔ∏è Noon</th>
                    <th class="text-info">üåÜ Evening</th>
                    <th class="text-dark">üåô Night</th>
                    <th class="text-success">Daily Total</th>
                    <th>Cow Count</th>
                    <th>Best Period</th>
                  </tr>
                </thead>
                <tbody>
                  <% if @trends_data[:daily_totals_summary] %>
                    <% @trends_data[:daily_totals_summary][:daily_rows].each do |row| %>
                      <tr>
                        <td><strong><%= row[:date].strftime("%m/%d/%Y") %></strong></td>
                        <td class="text-warning"><%= row[:morning_total] %>L</td>
                        <td class="text-danger"><%= row[:noon_total] %>L</td>
                        <td class="text-info"><%= row[:evening_total] %>L</td>
                        <td class="text-dark"><%= row[:night_total] %>L</td>
                        <td class="text-success fw-bold"><%= row[:daily_total] %>L</td>
                        <td class="text-muted"><%= row[:cow_count] %> cows</td>
                        <td>
                          <% best_period = %w[morning noon evening night].max_by { |p| row[:"#{p}_total"] } %>
                          <span class="badge bg-<%= case best_period
                            when 'morning' then 'warning'
                            when 'noon' then 'danger'
                            when 'evening' then 'info'
                            when 'night' then 'dark'
                            end %>">
                            <%= best_period.titleize %>
                          </span>
                        </td>
                      </tr>
                    <% end %>
                    <!-- Summary Row -->
                    <% if @trends_data[:daily_totals_summary][:period_totals] %>
                      <tr class="table-warning fw-bold">
                        <td><strong>TOTALS</strong></td>
                        <td class="text-warning"><%= @trends_data[:daily_totals_summary][:period_totals][:morning] %>L</td>
                        <td class="text-danger"><%= @trends_data[:daily_totals_summary][:period_totals][:noon] %>L</td>
                        <td class="text-info"><%= @trends_data[:daily_totals_summary][:period_totals][:evening] %>L</td>
                        <td class="text-dark"><%= @trends_data[:daily_totals_summary][:period_totals][:night] %>L</td>
                        <td class="text-success"><%= @trends_data[:daily_totals_summary][:period_totals][:daily] %>L</td>
                        <td colspan="2" class="text-muted">Overall Period Performance</td>
                      </tr>
                    <% end %>
                    <!-- Averages Row -->
                    <% if @trends_data[:daily_totals_summary][:averages] %>
                      <tr class="table-info">
                        <td><strong>AVERAGES</strong></td>
                        <td class="text-warning"><%= @trends_data[:daily_totals_summary][:averages][:morning] %>L</td>
                        <td class="text-danger"><%= @trends_data[:daily_totals_summary][:averages][:noon] %>L</td>
                        <td class="text-info"><%= @trends_data[:daily_totals_summary][:averages][:evening] %>L</td>
                        <td class="text-dark"><%= @trends_data[:daily_totals_summary][:averages][:night] %>L</td>
                        <td class="text-success"><%= @trends_data[:daily_totals_summary][:averages][:daily] %>L</td>
                        <td colspan="2" class="text-muted">Daily Averages</td>
                      </tr>
                    <% end %>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Milking Time Performance Analysis -->
      <div class="col-lg-4">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">‚è∞ Milking Time Performance</h5>
          </div>
          <div class="card-body">
            <% if @trends_data[:milking_time_performance] %>
              <% %w[morning noon evening night].each do |period| %>
                <% performance = @trends_data[:milking_time_performance][period.to_sym] %>
                <% if performance %>
                  <div class="mb-3 p-3 border rounded">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <h6 class="mb-0 text-<%= case period
                        when 'morning' then 'warning'
                        when 'noon' then 'danger'
                        when 'evening' then 'info'
                        when 'night' then 'dark'
                        end %>">
                        <%= case period
                          when 'morning' then 'üåÖ'
                          when 'noon' then '‚òÄÔ∏è'
                          when 'evening' then 'üåÜ'
                          when 'night' then 'üåô'
                          end %> <%= period.titleize %>
                      </h6>
                      <span class="badge bg-<%= case period
                        when 'morning' then 'warning'
                        when 'noon' then 'danger'
                        when 'evening' then 'info'
                        when 'night' then 'dark'
                        end %>">
                        <%= performance[:consistency_score] %>% consistent
                      </span>
                    </div>
                    <small class="text-muted d-block mb-1">
                      <strong>Total:</strong> <%= performance[:total_production] %>L
                    </small>
                    <small class="text-muted d-block mb-1">
                      <strong>Daily Avg:</strong> <%= performance[:average_per_day] %>L
                    </small>
                    <small class="text-muted d-block">
                      <strong>Trend:</strong> 
                      <span class="badge bg-<%= case performance[:trend]
                        when 'improving' then 'success'
                        when 'declining' then 'danger'
                        else 'secondary'
                        end %>">
                        <%= performance[:trend].titleize %>
                      </span>
                    </small>
                  </div>
                <% end %>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Daily Top Performers Table -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">üèÜ Daily Top Performers by Milking Period</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-sm" id="dailyPerformersTable">
            <thead class="table-light">
              <tr>
                <th>Date</th>
                <th class="text-warning">üåÖ Morning Leader</th>
                <th class="text-danger">‚òÄÔ∏è Noon Leader</th>
                <th class="text-info">üåÜ Evening Leader</th>
                <th class="text-dark">üåô Night Leader</th>
                <th class="text-success">Daily Champion</th>
              </tr>
            </thead>
            <tbody>
              <% if @trends_data[:daily_performers] %>
                <% @trends_data[:daily_performers].each do |date, performers| %>
                  <tr>
                    <td><strong><%= date.strftime("%m/%d/%Y") %></strong></td>
                    <% %w[morning noon evening night].each do |period| %>
                      <% performer = performers[period.to_sym] %>
                      <td class="text-<%= case period
                        when 'morning' then 'warning'
                        when 'noon' then 'danger'
                        when 'evening' then 'info'
                        when 'night' then 'dark'
                        end %>">
                        <% if performer && !performer.empty? %>
                          <strong><%= performer[:cow_name] %></strong><br>
                          <small><%= performer[:value] %>L</small>
                        <% else %>
                          <small class="text-muted">No data</small>
                        <% end %>
                      </td>
                    <% end %>
                    <td class="text-success">
                      <% daily_best = @trends_data[:daily_data][date]&.max_by { |_, data| data[:total] } %>
                      <% if daily_best %>
                        <strong><%= daily_best[1][:cow_name] %></strong><br>
                        <small><%= daily_best[1][:total] %>L total</small>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Cow Performance Summary -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">üêÑ Cow Performance Summary</h5>
        <small class="text-muted">Period averages and totals</small>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-sm" id="cowSummaryTable">
            <thead>
              <tr>
                <th>Cow</th>
                <th>Tag #</th>
                <th>Farm</th>
                <th>Days</th>
                <th>Morning Avg</th>
                <th>Noon Avg</th>
                <th>Evening Avg</th>
                <th>Night Avg</th>
                <th>Daily Avg</th>
                <th>Period Total</th>
              </tr>
            </thead>
            <tbody>
              <% @trends_data[:cow_totals].each do |cow_id, data| %>
                <tr>
                  <td><strong><%= data[:cow_name] %></strong></td>
                  <td><span class="badge bg-secondary"><%= data[:cow_tag] %></span></td>
                  <td><%= data[:farm_name] %></td>
                  <td><%= data[:days] %></td>
                  <td class="text-warning"><%= data[:avg_morning] %>L</td>
                  <td class="text-danger"><%= data[:avg_noon] %>L</td>
                  <td class="text-info"><%= data[:avg_evening] %>L</td>
                  <td class="text-dark"><%= data[:avg_night] %>L</td>
                  <td class="fw-bold text-success"><%= data[:avg_total] %>L</td>
                  <td class="fw-bold text-primary"><%= data[:total].round(1) %>L</td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Daily Detailed Breakdown -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">üìÖ Daily Production Details</h5>
        <small class="text-muted">Individual cow production by milking period</small>
      </div>
      <div class="card-body">
        <div class="accordion" id="dailyAccordion">
          <% @trends_data[:daily_data].each_with_index do |(date, cows_data), index| %>
            <div class="accordion-item">
              <h6 class="accordion-header" id="heading<%= index %>">
                <button class="accordion-button <%= 'collapsed' unless index == 0 %>" type="button" 
                        data-bs-toggle="collapse" data-bs-target="#collapse<%= index %>" 
                        aria-expanded="<%= index == 0 %>" aria-controls="collapse<%= index %>">
                  <div class="d-flex justify-content-between w-100 me-3">
                    <span><strong><%= date.strftime("%A, %B %d, %Y") %></strong></span>
                    <span class="text-muted">
                      <%= cows_data.count %> cows ‚Ä¢ 
                      <%= @trends_data[:date_totals][date][:total].round(1) %>L total
                    </span>
                  </div>
                </button>
              </h6>
              <div id="collapse<%= index %>" class="accordion-collapse collapse <%= 'show' if index == 0 %>" 
                   aria-labelledby="heading<%= index %>" data-bs-parent="#dailyAccordion">
                <div class="accordion-body">
                  <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                      <thead class="table-light">
                        <tr>
                          <th>Cow</th>
                          <th>Tag</th>
                          <th class="text-warning">üåÖ Morning</th>
                          <th class="text-danger">‚òÄÔ∏è Noon</th>
                          <th class="text-info">üåÜ Evening</th>
                          <th class="text-dark">üåô Night</th>
                          <th class="text-success">Total</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% cows_data.sort_by { |_, data| -data[:total] }.each do |cow_id, cow_data| %>
                          <tr>
                            <td><strong><%= cow_data[:cow_name] %></strong></td>
                            <td><span class="badge bg-secondary"><%= cow_data[:cow_tag] %></span></td>
                            <td class="text-warning"><%= cow_data[:morning] %>L</td>
                            <td class="text-danger"><%= cow_data[:noon] %>L</td>
                            <td class="text-info"><%= cow_data[:evening] %>L</td>
                            <td class="text-dark"><%= cow_data[:night] %>L</td>
                            <td class="fw-bold text-success"><%= cow_data[:total] %>L</td>
                          </tr>
                        <% end %>
                        <!-- Daily totals row -->
                        <tr class="table-warning">
                          <td colspan="2"><strong>Daily Totals</strong></td>
                          <td class="text-warning fw-bold"><%= @trends_data[:date_totals][date][:morning].round(1) %>L</td>
                          <td class="text-danger fw-bold"><%= @trends_data[:date_totals][date][:noon].round(1) %>L</td>
                          <td class="text-info fw-bold"><%= @trends_data[:date_totals][date][:evening].round(1) %>L</td>
                          <td class="text-dark fw-bold"><%= @trends_data[:date_totals][date][:night].round(1) %>L</td>
                          <td class="fw-bold text-success"><%= @trends_data[:date_totals][date][:total].round(1) %>L</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% else %>
    <div class="alert alert-info text-center">
      <h4>No Production Data Found</h4>
      <p>Please select a different date range or farm to view production trends.</p>
    </div>
  <% end %>
</div>

<!-- Charts JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  <% if @trends_data&.key?(:summary) %>
    // Distribution Chart
    const distributionCtx = document.getElementById('distributionChart').getContext('2d');
    new Chart(distributionCtx, {
      type: 'doughnut',
      data: {
        labels: ['Morning', 'Noon', 'Evening', 'Night'],
        datasets: [{
          data: [
            <%= @trends_data[:summary][:totals][:morning] %>,
            <%= @trends_data[:summary][:totals][:noon] %>,
            <%= @trends_data[:summary][:totals][:evening] %>,
            <%= @trends_data[:summary][:totals][:night] %>
          ],
          backgroundColor: ['#FFC107', '#DC3545', '#17A2B8', '#6C757D'],
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });

    // Daily Trends Chart
    const trendsCtx = document.getElementById('trendsChart').getContext('2d');
    const dailyLabels = [<%= @trends_data[:date_totals].keys.reverse.map { |d| "\"#{d.strftime('%m/%d')}\"" }.join(', ').html_safe %>];
    const dailyData = {
      morning: [<%= @trends_data[:date_totals].values.reverse.map { |d| d[:morning] }.join(', ') %>],
      noon: [<%= @trends_data[:date_totals].values.reverse.map { |d| d[:noon] }.join(', ') %>],
      evening: [<%= @trends_data[:date_totals].values.reverse.map { |d| d[:evening] }.join(', ') %>],
      night: [<%= @trends_data[:date_totals].values.reverse.map { |d| d[:night] }.join(', ') %>]
    };

    new Chart(trendsCtx, {
      type: 'line',
      data: {
        labels: dailyLabels,
        datasets: [
          {
            label: 'Morning',
            data: dailyData.morning,
            borderColor: '#FFC107',
            backgroundColor: 'rgba(255, 193, 7, 0.1)',
            tension: 0.4
          },
          {
            label: 'Noon',
            data: dailyData.noon,
            borderColor: '#DC3545',
            backgroundColor: 'rgba(220, 53, 69, 0.1)',
            tension: 0.4
          },
          {
            label: 'Evening',
            data: dailyData.evening,
            borderColor: '#17A2B8',
            backgroundColor: 'rgba(23, 162, 184, 0.1)',
            tension: 0.4
          },
          {
            label: 'Night',
            data: dailyData.night,
            borderColor: '#6C757D',
            backgroundColor: 'rgba(108, 117, 125, 0.1)',
            tension: 0.4
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          y: { 
            beginAtZero: true,
            title: { display: true, text: 'Production (Liters)' }
          }
        },
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });
  <% end %>

  // Initialize DataTables for all tables
  if (document.getElementById('cowSummaryTable')) {
    $('#cowSummaryTable').DataTable({
      pageLength: 25,
      order: [[9, 'desc']], // Sort by total production
      columnDefs: [
        { orderable: false, targets: [2] } // Farm name not orderable
      ]
    });
  }
  
  // Initialize Daily Totals Table
  if (document.getElementById('dailyTotalsTable')) {
    $('#dailyTotalsTable').DataTable({
      pageLength: 15,
      order: [[0, 'desc']], // Sort by date (newest first)
      columnDefs: [
        { orderable: false, targets: [6, 7] } // Best period and cow count not orderable
      ]
    });
  }
  
  // Initialize Daily Performers Table  
  if (document.getElementById('dailyPerformersTable')) {
    $('#dailyPerformersTable').DataTable({
      pageLength: 15,
      order: [[0, 'desc']], // Sort by date (newest first)
      columnDefs: [
        { orderable: false, targets: [1, 2, 3, 4, 5] } // Performer columns not orderable
      ]
    });
  }
});
</script>

<!-- DataTables CSS & JS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
