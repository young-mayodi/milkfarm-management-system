<% content_for :title, "Calves Management" %>

<div class="calves-dashboard">
  <section class="hero">
    <div class="hero-copy">
      <div class="hero-kicker">Youngstock Insights</div>
      <h1 class="hero-title">Calves Management</h1>
      <p class="hero-subtitle">Monitor growth, health, and development across every calf group.</p>
      <div class="hero-meta">
        <span class="meta-pill"><i class="bi bi-heart-pulse"></i>Health status</span>
        <span class="meta-pill"><i class="bi bi-graph-up"></i>Growth trends</span>
        <span class="meta-pill"><i class="bi bi-shield-check"></i>Care compliance</span>
      </div>
    </div>
    <div class="hero-actions">
      <%= link_to new_calf_path, class: "btn btn-cta" do %>
        <i class="bi bi-plus-circle"></i>Add Calf
      <% end %>
      <div class="dropdown">
        <button class="btn btn-ghost dropdown-toggle" data-bs-toggle="dropdown">
          <i class="bi bi-download"></i>Export
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li>
            <%= link_to calves_path(format: :csv), class: "dropdown-item" do %>
              <i class="bi bi-file-earmark-text me-2"></i>CSV Report
            <% end %>
          </li>
          <li><hr class="dropdown-divider"></li>
          <li>
            <span class="dropdown-item text-muted">
              <i class="bi bi-info-circle me-2"></i>Excel & PDF coming soon
            </span>
          </li>
        </ul>
      </div>
    </div>
  </section>

  <section class="kpi-grid">
    <div class="kpi-card">
      <div class="kpi-icon"><i class="bi bi-heart-fill"></i></div>
      <div>
        <div class="kpi-value"><%= @calf_stats[:total_calves] %></div>
        <div class="kpi-label">Total calves</div>
        <div class="kpi-sub"><%= @calf_stats[:with_mothers] %> with mothers</div>
      </div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon"><i class="bi bi-shield-check"></i></div>
      <div>
        <div class="kpi-value"><%= @calf_stats[:healthy_calves] %></div>
        <div class="kpi-label">Healthy calves</div>
        <div class="kpi-sub"><%= number_with_precision((@calf_stats[:healthy_calves] / @calf_stats[:total_calves].to_f * 100), precision: 1) %>% healthy</div>
      </div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon"><i class="bi bi-calendar3"></i></div>
      <div>
        <div class="kpi-value"><%= number_with_precision(@calf_stats[:average_age], precision: 1) %></div>
        <div class="kpi-label">Avg age (months)</div>
        <div class="kpi-sub">Average age across all calves</div>
      </div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon"><i class="bi bi-speedometer2"></i></div>
      <div>
        <div class="kpi-value"><%= number_with_precision(@growth_stats[:average_daily_gain], precision: 2) %>kg</div>
        <div class="kpi-label">Avg daily gain</div>
        <div class="kpi-sub">Per day weight gain</div>
      </div>
    </div>
  </section>

  <% if @calves.any? %>
    <section class="split-grid">
      <div class="panel">
        <div class="panel-header">
          <h3><i class="bi bi-pie-chart-fill"></i>Age Distribution</h3>
          <p class="panel-sub">Calves by age groups</p>
        </div>
        <div class="panel-body chart-panel" data-turbo-permanent>
          <canvas id="age-distribution-chart"></canvas>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <h3><i class="bi bi-bar-chart"></i>Growth Progress</h3>
          <p class="panel-sub">Weight gain and daily growth rates</p>
        </div>
        <div class="panel-body chart-panel" data-turbo-permanent>
          <canvas id="growth-progress-chart"></canvas>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <h3><i class="bi bi-heart-pulse"></i>Health Status</h3>
          <p class="panel-sub">Overall health distribution</p>
        </div>
        <div class="panel-body chart-panel" data-turbo-permanent>
          <canvas id="health-status-chart"></canvas>
        </div>
      </div>
    </section>
  <% end %>

  <% if @growth_stats[:best_performers].any? %>
    <section class="panel performers">
      <div class="panel-header">
        <h3>Best Growing Calves</h3>
        <p class="panel-sub">Top performers in daily weight gain</p>
      </div>
      <div class="panel-body">
        <div class="performer-grid">
          <% @growth_stats[:best_performers].each_with_index do |calf, index| %>
            <div class="performer-card">
              <div class="rank-badge <%= index == 0 ? 'rank-gold' : index == 1 ? 'rank-silver' : 'rank-bronze' %>">
                <%= index + 1 %>
              </div>
              <div class="performer-info">
                <div class="performer-name"><%= calf.name %></div>
                <div class="performer-sub">Tag: <%= calf.tag_number %></div>
              </div>
              <div class="performer-metric">
                <div class="metric-value"><%= number_with_precision(calf.avg_daily_gain, precision: 2) %>kg/day</div>
                <div class="metric-sub"><%= calf.age %> months old</div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </section>
  <% end %>

  <section class="panel filter-panel">
    <div class="panel-body">
      <%= form_with url: calves_path, method: :get, local: true, class: "filter-form" do |form| %>
        <div class="filter-item">
          <%= form.text_field :search, placeholder: "Search by name or tag...",
                             value: params[:search],
                             class: "form-control",
                             autocomplete: "off" %>
        </div>
        <div class="filter-item">
          <%= form.select :farm_id,
                         options_from_collection_for_select(
                           current_user.accessible_farms, :id, :name, params[:farm_id]
                         ),
                         { prompt: "All Farms" },
                         { class: "form-select" } %>
        </div>
        <div class="filter-item">
          <%= form.select :status,
                         options_for_select([
                           ['All Status', ''],
                           ['Active', 'active'],
                           ['Sick', 'sick'],
                           ['Inactive', 'inactive']
                         ], params[:status]),
                         {},
                         { class: "form-select" } %>
        </div>
        <div class="filter-actions">
          <%= form.submit "Filter", class: "btn btn-primary" %>
          <%= link_to "Clear", calves_path, class: "btn btn-outline-secondary" %>
        </div>
      <% end %>
    </div>
  </section>

  <section class="panel table-panel">
    <div class="panel-header">
      <h3>Calves List (<%= @calves.total_count %> total)</h3>
      <span class="panel-sub">Showing <%= @calves.count %> of <%= @calves.total_count %></span>
    </div>
    <div class="panel-body">
      <% if @calves.any? %>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>Calf Details</th>
                <th>Farm</th>
                <th>Mother</th>
                <th>Age</th>
                <th>Weight Info</th>
                <th>Growth Rate</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% @calves.each do |calf| %>
                <tr>
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="calf-avatar me-3">
                        <i class="bi bi-heart-fill text-primary"></i>
                      </div>
                      <div>
                        <h6 class="mb-1"><%= calf.name %></h6>
                        <small class="text-muted">Tag: <%= calf.tag_number %></small>
                        <br>
                        <small class="text-muted"><%= calf.breed %></small>
                      </div>
                    </div>
                  </td>
                  <td>
                    <span class="badge bg-info"><%= calf.farm.name %></span>
                  </td>
                  <td>
                    <% if calf.mother %>
                      <div>
                        <strong><%= calf.mother.name %></strong>
                        <br>
                        <small class="text-muted">Tag: <%= calf.mother.tag_number %></small>
                      </div>
                    <% else %>
                      <span class="text-muted">No mother assigned</span>
                    <% end %>
                  </td>
                  <td>
                    <span class="badge bg-secondary"><%= calf.age %> months</span>
                    <% if calf.birth_date %>
                      <br>
                      <small class="text-muted">Born: <%= calf.birth_date.strftime("%m/%d/%y") %></small>
                    <% end %>
                  </td>
                  <td>
                    <% if calf.current_weight %>
                      <div>
                        <strong><%= calf.current_weight %>kg</strong>
                        <% if calf.prev_weight && calf.weight_gain %>
                          <br>
                          <small class="text-<%= calf.weight_gain > 0 ? 'success' : 'warning' %>">
                            <%= calf.weight_gain > 0 ? '+' : '' %><%= calf.weight_gain %>kg
                          </small>
                        <% end %>
                      </div>
                    <% else %>
                      <span class="text-muted">Not recorded</span>
                    <% end %>
                  </td>
                  <td>
                    <% if calf.avg_daily_gain %>
                      <span class="badge bg-<%= calf.avg_daily_gain > 0.5 ? 'success' : calf.avg_daily_gain > 0.3 ? 'warning' : 'danger' %>">
                        <%= number_with_precision(calf.avg_daily_gain, precision: 2) %>kg/day
                      </span>
                    <% else %>
                      <span class="text-muted">Not calculated</span>
                    <% end %>
                  </td>
                  <td>
                    <span class="badge bg-<%= calf.status_badge_class %>">
                      <%= calf.status.capitalize %>
                    </span>
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm">
                      <%= link_to calf_path(calf), class: "btn btn-outline-primary", title: "View Details" do %>
                        <i class="bi bi-eye"></i>
                      <% end %>
                      <%= link_to edit_calf_path(calf), class: "btn btn-outline-warning", title: "Edit" do %>
                        <i class="bi bi-pencil"></i>
                      <% end %>
                      <%= link_to calf_path(calf), method: :delete,
                                 class: "btn btn-outline-danger",
                                 title: "Delete",
                                 confirm: "Are you sure you want to delete #{calf.name}?" do %>
                        <i class="bi bi-trash"></i>
                      <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <div class="table-footer">
          <small class="text-muted">
            Showing <%= @calves.offset_value + 1 %> to <%= [@calves.offset_value + @calves.count, @calves.total_count].min %>
            of <%= @calves.total_count %> calves
          </small>
          <%= paginate @calves if respond_to?(:paginate) %>
        </div>
      <% else %>
        <div class="empty-state">
          <div class="empty-icon"><i class="bi bi-heart"></i></div>
          <h4>No calves found</h4>
          <p>
            <% if params[:search].present? || params[:farm_id].present? || params[:status].present? %>
              Try adjusting your filters or
              <%= link_to "clear all filters", calves_path, class: "text-decoration-none" %>
            <% else %>
              Get started by adding your first calf to the system
            <% end %>
          </p>
          <%= link_to new_calf_path, class: "btn btn-cta" do %>
            <i class="bi bi-plus-circle"></i>Add First Calf
          <% end %>
        </div>
      <% end %>
    </div>
  </section>
</div>

<% if @calves.any? %>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const ageCtx = document.getElementById('age-distribution-chart');
  if (ageCtx && <%= @age_distribution.present? %>) {
    new Chart(ageCtx, {
      type: 'doughnut',
      data: {
        labels: <%= @age_distribution.keys.to_json.html_safe %>,
        datasets: [{
          data: <%= @age_distribution.values.to_json.html_safe %>,
          backgroundColor: [
            'rgba(255, 99, 132, 0.8)',
            'rgba(54, 162, 235, 0.8)',
            'rgba(255, 205, 86, 0.8)',
            'rgba(75, 192, 192, 0.8)'
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });
  }

  const growthCtx = document.getElementById('growth-progress-chart');
  if (growthCtx && <%= @growth_data.present? %>) {
    new Chart(growthCtx, {
      type: 'bar',
      data: {
        labels: <%= @growth_data.map { |d| d[:name] }.to_json.html_safe %>,
        datasets: [{
          label: 'Weight Gain (kg)',
          data: <%= @growth_data.map { |d| d[:weight_gain] }.to_json.html_safe %>,
          backgroundColor: 'rgba(75, 192, 192, 0.8)'
        }, {
          label: 'Daily Gain (kg)',
          data: <%= @growth_data.map { |d| d[:daily_gain] }.to_json.html_safe %>,
          backgroundColor: 'rgba(255, 159, 64, 0.8)'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }

  const healthCtx = document.getElementById('health-status-chart');
  if (healthCtx && <%= @health_status.present? %>) {
    new Chart(healthCtx, {
      type: 'pie',
      data: {
        labels: <%= @health_status.keys.map(&:capitalize).to_json.html_safe %>,
        datasets: [{
          data: <%= @health_status.values.to_json.html_safe %>,
          backgroundColor: [
            'rgba(75, 192, 192, 0.8)',
            'rgba(255, 99, 132, 0.8)',
            'rgba(255, 205, 86, 0.8)',
            'rgba(153, 102, 255, 0.8)'
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });
  }
});
</script>
<% end %>

<style>
@import url("https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Grotesk:wght@400;500;600;700&display=swap");

.calves-dashboard {
  --ink: #0f172a;
  --muted: #64748b;
  --edge: #e2e8f0;
  --panel: #ffffff;
  --panel-2: #f8fafc;
  --accent: #0ea5a4;
  --accent-dark: #0f766e;
  --accent-soft: rgba(14, 165, 164, 0.15);
  --shadow: 0 20px 60px rgba(15, 23, 42, 0.12);
  font-family: "Space Grotesk", "DM Sans", sans-serif;
  color: var(--ink);
  padding: 2.5rem 0 3rem;
  background: radial-gradient(circle at top right, rgba(14, 165, 164, 0.08), transparent 55%),
    linear-gradient(120deg, #f8fafc 0%, #f1f5f9 50%, #ffffff 100%);
}

.hero {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 2rem;
  padding: 2.5rem 2.75rem;
  border-radius: 24px;
  background: linear-gradient(135deg, #0f172a 0%, #0f766e 100%);
  color: #f8fafc;
  box-shadow: var(--shadow);
  position: relative;
  overflow: hidden;
}

.hero::after {
  content: "";
  position: absolute;
  width: 380px;
  height: 380px;
  right: -120px;
  top: -180px;
  background: radial-gradient(circle, rgba(255, 255, 255, 0.18), transparent 70%);
}

.hero-copy {
  max-width: 640px;
}

.hero-kicker {
  text-transform: uppercase;
  letter-spacing: 0.24em;
  font-size: 0.75rem;
  color: rgba(248, 250, 252, 0.7);
  margin-bottom: 0.75rem;
}

.hero-title {
  font-size: clamp(2rem, 3vw, 3rem);
  font-weight: 700;
  margin-bottom: 0.75rem;
}

.hero-subtitle {
  font-size: 1.05rem;
  color: rgba(248, 250, 252, 0.8);
  margin-bottom: 1.5rem;
}

.hero-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
}

.meta-pill {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.4rem 0.75rem;
  border-radius: 999px;
  background: rgba(15, 23, 42, 0.3);
  border: 1px solid rgba(248, 250, 252, 0.2);
  font-size: 0.85rem;
}

.hero-actions {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  z-index: 1;
}

.calves-dashboard .btn-cta {
  background: #f8fafc;
  color: #0f172a;
  border: none;
  padding: 0.7rem 1.3rem;
  border-radius: 12px;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  box-shadow: 0 12px 30px rgba(15, 118, 110, 0.35);
}

.calves-dashboard .btn-cta:hover {
  background: #e2e8f0;
  color: #0f172a;
}

.calves-dashboard .btn-ghost {
  border: 1px solid rgba(248, 250, 252, 0.4);
  color: #f8fafc;
  background: transparent;
}

.kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 1.25rem;
  margin: 2.5rem 0 2rem;
}

.kpi-card {
  background: var(--panel);
  border-radius: 18px;
  border: 1px solid var(--edge);
  padding: 1.5rem;
  display: grid;
  grid-template-columns: auto 1fr;
  gap: 1rem;
  align-items: center;
  box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
}

.kpi-icon {
  width: 46px;
  height: 46px;
  border-radius: 14px;
  display: grid;
  place-items: center;
  background: var(--accent-soft);
  color: var(--accent-dark);
  font-size: 1.2rem;
}

.kpi-value {
  font-size: 1.6rem;
  font-weight: 700;
}

.kpi-label {
  color: var(--muted);
  font-size: 0.9rem;
}

.kpi-sub {
  color: var(--muted);
  font-size: 0.8rem;
}

.split-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.panel {
  background: var(--panel);
  border-radius: 20px;
  border: 1px solid var(--edge);
  box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
}

.panel-header {
  padding: 1.2rem 1.5rem 0.75rem;
  display: flex;
  flex-direction: column;
  gap: 0.3rem;
}

.panel-header h3 {
  margin: 0;
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.panel-sub {
  color: var(--muted);
  font-size: 0.85rem;
}

.panel-body {
  padding: 0 1.5rem 1.5rem;
}

.chart-panel {
  height: 300px;
}

.performers .panel-body {
  padding-top: 0.5rem;
}

.performer-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 1rem;
}

.performer-card {
  display: grid;
  grid-template-columns: auto 1fr auto;
  gap: 0.75rem;
  align-items: center;
  padding: 1rem;
  border-radius: 16px;
  border: 1px solid var(--edge);
  background: var(--panel-2);
}

.performer-name {
  font-weight: 600;
}

.performer-sub,
.metric-sub {
  color: var(--muted);
  font-size: 0.85rem;
}

.rank-badge {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: grid;
  place-items: center;
  font-weight: 700;
  color: white;
  font-size: 0.9rem;
}

.rank-gold {
  background: linear-gradient(135deg, #ffd700, #f59e0b);
  box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);
}

.rank-silver {
  background: linear-gradient(135deg, #c0c0c0, #94a3b8);
  box-shadow: 0 2px 8px rgba(192, 192, 192, 0.4);
}

.rank-bronze {
  background: linear-gradient(135deg, #cd7f32, #a16207);
  box-shadow: 0 2px 8px rgba(205, 127, 50, 0.4);
}

.filter-panel {
  margin-bottom: 2rem;
}

.filter-form {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  align-items: end;
}

.filter-actions {
  display: flex;
  gap: 0.5rem;
}

.table-panel .panel-header {
  flex-direction: row;
  align-items: center;
  justify-content: space-between;
}

.table-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 1.5rem;
}

.calf-avatar {
  width: 40px;
  height: 40px;
  background: rgba(14, 165, 164, 0.1);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.1rem;
}

.empty-state {
  text-align: center;
  padding: 3rem 2rem;
  border-radius: 24px;
  background: var(--panel-2);
  border: 1px dashed var(--edge);
}

.empty-icon {
  font-size: 3rem;
  color: var(--accent);
  margin-bottom: 1rem;
}

@media (max-width: 992px) {
  .hero {
    flex-direction: column;
    align-items: flex-start;
  }
}

@media (max-width: 768px) {
  .table-footer {
    flex-direction: column;
    gap: 0.75rem;
    align-items: flex-start;
  }
}
</style>
