<!DOCTYPE html>
<html>
  <head>
    <title>üåå MilkyWay Farm Management System</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    
    <!-- Modern Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "charts", "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "sidebar", "data-turbo-track": "reload" %>
    
    <!-- Chart.js - Load before Stimulus -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <%= javascript_importmap_tags %>
    
    <!-- Custom Modern Design System -->
    <style>
      :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --dark-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        
        --sidebar-bg: linear-gradient(180deg, #1a1d29 0%, #2c3e50 100%);
        --sidebar-width: 320px;
        --header-height: 70px;
        
        --border-radius: 12px;
        --border-radius-sm: 8px;
        --border-radius-lg: 16px;
        
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.06);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.15);
        --shadow-xl: 0 16px 40px rgba(0, 0, 0, 0.2);
        
        --animation-fast: 0.15s ease-out;
        --animation-base: 0.3s ease-out;
        --animation-slow: 0.5s ease-out;
      }
      
      * {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      }
      
      body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
        font-family: 'Inter', sans-serif;
      }
      
      .wrapper {
        min-height: 100vh;
      }
      
      /* Modern Sidebar */
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: var(--sidebar-width);
        background: var(--sidebar-bg);
        backdrop-filter: blur(20px);
        border-right: 1px solid rgba(255, 255, 255, 0.1);
        z-index: 1000;
        transition: transform var(--animation-base);
        box-shadow: var(--shadow-lg);
      }
      
      .sidebar-header {
        height: var(--header-height);
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      .sidebar-brand {
        background: var(--primary-gradient);
        width: 45px;
        height: 45px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        transition: transform var(--animation-fast);
      }
      
      .sidebar-brand:hover {
        transform: scale(1.05);
      }
      
      .sidebar-menu {
        height: calc(100vh - var(--header-height));
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
      }
      
      .sidebar-menu::-webkit-scrollbar {
        width: 4px;
      }
      
      .sidebar-menu::-webkit-scrollbar-track {
        background: transparent;
      }
      
      .sidebar-menu::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 2px;
      }
      
      .nav-pills .nav-link {
        border-radius: var(--border-radius-sm);
        margin-bottom: 4px;
        padding: 12px 16px;
        transition: all var(--animation-fast);
        color: rgba(255, 255, 255, 0.8) !important;
        font-weight: 500;
        position: relative;
        overflow: hidden;
      }
      
      .nav-pills .nav-link::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--primary-gradient);
        opacity: 0;
        transition: opacity var(--animation-fast);
        z-index: -1;
      }
      
      .nav-pills .nav-link:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateX(4px);
        color: white !important;
      }
      
      .nav-pills .nav-link:hover::before {
        opacity: 0.2;
      }
      
      .nav-pills .nav-link.active {
        background: var(--primary-gradient);
        color: white !important;
        box-shadow: var(--shadow-md);
        transform: translateX(4px);
      }
      
      .nav-pills .nav-link i {
        width: 20px;
        text-align: center;
      }
      
      /* Enhanced Navigation Submenu Styles */
      .nav-link-sub {
        font-size: 0.9rem;
        padding: 0.5rem 0.75rem;
        margin-bottom: 0.125rem;
        background: rgba(255, 255, 255, 0.05);
        border-left: 3px solid transparent;
        color: rgba(255, 255, 255, 0.7) !important;
      }
      
      .nav-link-sub:hover {
        border-left-color: rgba(102, 126, 234, 0.8);
        background: rgba(102, 126, 234, 0.1);
        color: rgba(255, 255, 255, 0.9) !important;
        transform: translateX(2px);
      }
      
      .nav-link-sub.active {
        background: rgba(102, 126, 234, 0.2);
        border-left-color: #667eea;
        color: white !important;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
      }
      
      .animals-menu-toggle {
        position: relative;
        user-select: none;
        cursor: pointer;
      }
      
      .animals-menu-toggle:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white !important;
      }
      
      .submenu-arrow {
        transition: transform var(--animation-fast);
        font-size: 0.8rem;
        opacity: 0.7;
      }
      
      .submenu-arrow.rotated {
        transform: rotate(180deg);
      }
      
      /* Badge styles for navigation counters */
      .nav-link .badge {
        font-size: 0.7rem;
        border-radius: 10px;
        padding: 0.25rem 0.5rem;
      }
      
      /* Pulse animation for alert badges */
      .pulse-badge {
        animation: pulse-danger 2s infinite;
      }
      
      /* Notification pulse animation for alerts */
      .notification-pulse {
        animation: notification-pulse 2s infinite;
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
      }
      
      @keyframes notification-pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
          transform: scale(1);
        }
        50% {
          box-shadow: 0 0 0 6px rgba(220, 53, 69, 0.3);
          transform: scale(1.1);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
          transform: scale(1);
        }
      }
      
      @keyframes pulse-danger {
        0% {
          box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
        }
        70% {
          box-shadow: 0 0 0 8px rgba(220, 53, 69, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
        }
      }
      
      /* Main Content Area */
      .main-content {
        margin-left: var(--sidebar-width);
        min-height: 100vh;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(20px);
      }
      
      .top-header {
        height: var(--header-height);
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        box-shadow: var(--shadow-sm);
        position: sticky;
        top: 0;
        z-index: 100;
      }
      
      .page-title {
        font-family: 'Poppins', sans-serif;
        font-weight: 600;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      
      /* Enhanced Cards */
      .card {
        border: none;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        backdrop-filter: blur(20px);
        transition: all var(--animation-base);
        overflow: hidden;
      }
      
      .card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
      }
      
      .card-gradient-primary {
        background: var(--primary-gradient);
      }
      
      .card-gradient-success {
        background: var(--success-gradient);
      }
      
      .card-gradient-warning {
        background: var(--warning-gradient);
      }
      
      .card-gradient-info {
        background: var(--info-gradient);
      }
      
      .metric-card {
        position: relative;
        overflow: hidden;
      }
      
      .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 100px;
        height: 100px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        transform: translate(30px, -30px);
      }
      
      .metric-icon {
        font-size: 2.5rem;
        opacity: 0.7;
        transition: all var(--animation-fast);
      }
      
      .metric-card:hover .metric-icon {
        opacity: 1;
        transform: scale(1.1);
      }
      
      /* Enhanced Buttons */
      .btn {
        border-radius: var(--border-radius-sm);
        font-weight: 500;
        padding: 8px 16px;
        transition: all var(--animation-fast);
        border: none;
        position: relative;
        overflow: hidden;
      }
      
      .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left var(--animation-base);
      }
      
      .btn:hover::before {
        left: 100%;
      }
      
      .btn-primary {
        background: var(--primary-gradient);
        box-shadow: var(--shadow-sm);
      }
      
      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
      }
      
      .btn-success {
        background: var(--success-gradient);
      }
      
      .btn-info {
        background: var(--info-gradient);
      }
      
      .btn-warning {
        background: var(--warning-gradient);
      }
      
      /* Enhanced Form Controls */
      .form-control, .form-select {
        border-radius: var(--border-radius-sm);
        border: 2px solid rgba(0, 0, 0, 0.1);
        transition: all var(--animation-fast);
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
      }
      
      .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        background: white;
      }
      
      /* Enhanced Alerts */
      .alert {
        border: none;
        border-radius: var(--border-radius);
        backdrop-filter: blur(20px);
        box-shadow: var(--shadow-sm);
      }
      
      /* Responsive Design */
      @media (max-width: 768px) {
        .sidebar {
          transform: translateX(-100%);
        }
        
        .sidebar.show {
          transform: translateX(0);
        }
        
        .main-content {
          margin-left: 0;
        }
      }
      
      /* Loading Animation */
      @keyframes shimmer {
        0% { background-position: -1000px 0; }
        100% { background-position: 1000px 0; }
      }
      
      .loading-shimmer {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 1000px 100px;
        animation: shimmer 2s infinite;
      }

      /* Mobile Navigation Styles */
      .mobile-nav {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 60px;
        background: var(--dark-gradient);
        z-index: 1000;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        -webkit-backdrop-filter: blur(20px);
        backdrop-filter: blur(20px);
      }

      .mobile-nav-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: 100%;
        padding: 0 1rem;
      }

      .mobile-menu-toggle {
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        width: 30px;
        height: 24px;
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 0;
        -webkit-tap-highlight-color: transparent;
      }

      .hamburger-line {
        display: block;
        height: 3px;
        width: 100%;
        background: white;
        border-radius: 2px;
        transition: all 0.3s ease;
      }

      .mobile-menu-toggle.active .hamburger-line:nth-child(1) {
        transform: rotate(45deg) translate(7px, 7px);
      }

      .mobile-menu-toggle.active .hamburger-line:nth-child(2) {
        opacity: 0;
      }

      .mobile-menu-toggle.active .hamburger-line:nth-child(3) {
        transform: rotate(-45deg) translate(7px, -7px);
      }

      .mobile-brand {
        display: flex;
        align-items: center;
        color: white;
        font-weight: 600;
        font-size: 1.1rem;
      }

      .mobile-user-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        -webkit-tap-highlight-color: transparent;
      }

      .mobile-user-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        color: white;
      }

      .mobile-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 998;
        display: none;
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
      }

      .mobile-overlay.show {
        display: block;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      /* Mobile Responsive Adjustments */
      @media (max-width: 991.98px) {
        .mobile-nav {
          display: block;
        }

        .wrapper {
          padding-top: 60px;
        }

        .sidebar {
          position: fixed;
          top: 60px;
          left: -280px;
          height: calc(100vh - 60px);
          z-index: 999;
          transition: left 0.3s ease;
        }

        .sidebar.show {
          left: 0;
          box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
        }

        .content {
          width: 100% !important;
          margin-left: 0 !important;
          min-height: calc(100vh - 60px);
        }

        .main-content {
          padding: 1rem;
        }

        /* Adjust cards for mobile */
        .stat-card,
        .farm-card,
        .cow-card,
        .production-record-card {
          margin-bottom: 1rem;
        }

        /* Stack form elements on mobile */
        .form-grid {
          grid-template-columns: 1fr !important;
        }

        /* Adjust table for mobile */
        .table-responsive {
          font-size: 0.875rem;
        }

        /* Hide some columns on very small screens */
        .d-sm-none {
          display: none !important;
        }

        /* Ensure proper spacing in mobile cards */
        .farm-actions,
        .cow-actions,
        .record-actions {
          flex-direction: column;
          gap: 0.5rem;
        }

        .farm-actions .btn,
        .cow-actions .btn,
        .record-actions .btn {
          width: 100%;
        }

        /* Better mobile typography */
        .header-title {
          font-size: 1.75rem !important;
        }

        .header-subtitle {
          font-size: 0.9rem !important;
        }

        /* Compact stat cards on mobile */
        .stat-content {
          flex-direction: column;
          text-align: center;
          gap: 0.5rem;
        }

        .stat-icon {
          width: 50px;
          height: 50px;
          font-size: 1.25rem;
        }

        /* Adjust modal for mobile */
        .modal-dialog {
          margin: 0.5rem;
        }

        /* Better dropdown positioning on mobile */
        .dropdown-menu {
          font-size: 0.9rem;
        }

        /* Compact navigation items */
        .nav-link {
          padding: 0.75rem 1rem;
          font-size: 0.9rem;
          -webkit-tap-highlight-color: transparent;
        }

        /* Improve table on mobile */
        .production-table th,
        .production-table td {
          padding: 0.5rem 0.25rem;
          font-size: 0.8rem;
        }

        /* Stack filter controls vertically */
        .filter-card .row {
          flex-direction: column;
        }

        .filter-card .col-md-3,
        .filter-card .col-md-4,
        .filter-card .col-md-6 {
          margin-bottom: 1rem;
          width: 100%;
        }

        /* Touch-friendly buttons */
        .btn {
          min-height: 44px;
          -webkit-tap-highlight-color: transparent;
        }

        .btn-sm {
          min-height: 38px;
        }
      }

      /* Extra small devices adjustments */
      @media (max-width: 575.98px) {
        .mobile-nav-content {
          padding: 0 0.75rem;
        }

        .mobile-brand .brand-text {
          font-size: 1rem;
        }

        .main-content {
          padding: 0.75rem;
        }

        /* Even more compact cards */
        .card {
          border-radius: 0.5rem;
        }

        .card-body {
          padding: 1rem;
        }

        /* Smaller buttons */
        .btn {
          padding: 0.5rem 0.75rem;
          font-size: 0.875rem;
        }

        .btn-sm {
          padding: 0.375rem 0.5rem;
          font-size: 0.8rem;
        }

        /* Compact headers */
        .form-header,
        .reports-header,
        .farms-header {
          margin-bottom: 1.5rem;
        }

        .header-actions {
          flex-direction: column;
          gap: 0.5rem;
        }

        /* Simplify complex layouts */
        .reports-grid {
          grid-template-columns: 1fr !important;
        }

        .farms-filter-section .search-container,
        .farms-filter-section .view-options {
          margin-bottom: 1rem;
        }

        /* Better form experience */
        .modern-form-card {
          border-radius: 0.5rem;
          margin: 0 -0.75rem;
        }

        .form-card-body {
          padding: 1rem;
        }

        .form-step .step-navigation {
          flex-direction: column;
          gap: 1rem;
        }
      }

      /* ============================================= */
      /* COMPREHENSIVE MOBILE OPTIMIZATION STYLES     */
      /* ============================================= */
      
      /* Touch-friendly interactions */
      @media (hover: none) and (pointer: coarse) {
        .btn, .nav-link, .card, .table td {
          min-height: 44px; /* Apple's recommended minimum touch target */
        }
        
        .btn {
          padding: 12px 20px;
          font-size: 16px; /* Prevent zoom on iOS */
        }
        
        /* Larger touch targets for navigation */
        .nav-link {
          padding: 12px 15px;
          font-size: 15px;
        }
        
        /* Better form controls for mobile */
        .form-control, .form-select {
          padding: 12px 15px;
          font-size: 16px; /* Prevent zoom on iOS */
          border-radius: 8px;
        }
        
        /* Remove hover effects that don't work on touch */
        .card:hover, .btn:hover, .nav-link:hover {
          transform: none;
          box-shadow: none;
        }
        
        /* Add active/pressed states for touch feedback */
        .btn:active, .nav-link:active, .card:active {
          transform: scale(0.98);
          transition: transform 0.1s ease;
        }
        
        /* Make dropdowns easier to use */
        .dropdown-menu {
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
          border: none;
          border-radius: 12px;
          padding: 10px 0;
        }
        
        .dropdown-item {
          padding: 12px 20px;
          font-size: 15px;
        }
      }
      
      /* Enhanced mobile responsiveness */
      @media (max-width: 767.98px) {
        /* Optimize charts for mobile viewing */
        canvas {
          max-height: 250px !important;
        }
        
        /* Stack financial cards vertically on mobile */
        .financial-dashboard .row > .col-md-3,
        .cost-analysis-report .row > .col-md-3,
        .roi-report .row > .col-md-3 {
          margin-bottom: 15px;
        }
        
        /* Improve table readability on mobile */
        .table-responsive {
          border: none;
          -webkit-overflow-scrolling: touch;
          scrollbar-width: thin;
        }
        
        .table-responsive::-webkit-scrollbar {
          height: 4px;
        }
        
        .table-responsive::-webkit-scrollbar-track {
          background: #f1f1f1;
          border-radius: 10px;
        }
        
        .table-responsive::-webkit-scrollbar-thumb {
          background: #c1c1c1;
          border-radius: 10px;
        }
        
        /* Hide less important table columns on mobile */
        .table .d-none-mobile {
          display: none !important;
        }
        
        /* Better spacing for mobile forms */
        .form-group, .mb-3 {
          margin-bottom: 20px;
        }
        
        /* Improve modal experience on mobile */
        .modal-dialog {
          margin: 10px;
          max-width: calc(100vw - 20px);
        }
        
        .modal-header, .modal-footer {
          padding: 15px;
        }
        
        .modal-body {
          padding: 20px 15px;
        }
        
        /* Better breadcrumb navigation */
        .breadcrumb {
          font-size: 14px;
          padding: 8px 0;
          margin-bottom: 15px;
        }
        
        .breadcrumb-item {
          max-width: 120px;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
        }
        
        /* Optimize alerts and notifications */
        .alert {
          border-radius: 8px;
          padding: 12px 15px;
          margin-bottom: 15px;
          font-size: 14px;
        }
        
        /* Improve pagination on mobile */
        .pagination {
          justify-content: center;
        }
        
        .page-link {
          padding: 8px 12px;
          font-size: 14px;
        }
        
        /* Better search experience */
        .search-container .form-control {
          border-radius: 25px;
          padding-left: 20px;
          padding-right: 45px;
        }
        
        /* Optimize dashboard widgets */
        .stat-card {
          text-align: center;
          padding: 20px 15px;
        }
        
        .stat-icon {
          float: none;
          display: block;
          margin: 0 auto 10px;
          font-size: 2.5rem;
        }
        
        /* Better loading states */
        .loading-spinner {
          margin: 40px auto;
          text-align: center;
        }
        
        /* Improve action buttons */
        .header-actions .btn-group {
          width: 100%;
        }
        
        .header-actions .btn-group .btn {
          flex: 1;
          font-size: 13px;
          padding: 8px 12px;
        }
      }
      
      /* Extra small devices optimizations */
      @media (max-width: 575.98px) {
        /* Further optimize for very small screens */
        body {
          font-size: 14px;
        }
        
        .page-title {
          font-size: 1.5rem;
          margin-bottom: 8px;
        }
        
        .page-header p {
          font-size: 13px;
          margin-bottom: 15px;
        }
        
        /* Single column layout for extra small screens */
        .row > [class*="col-"] {
          margin-bottom: 20px;
        }
        
        /* Optimize financial dashboard for phones */
        .financial-dashboard .stat-content h3 {
          font-size: 1.3rem;
        }
        
        .financial-dashboard .stat-content p {
          font-size: 12px;
        }
        
        /* Compact table layout */
        .table td, .table th {
          padding: 8px 4px;
          font-size: 13px;
        }
        
        /* Hide table headers and use a more mobile-friendly layout */
        .mobile-table-view .table thead {
          display: none;
        }
        
        .mobile-table-view .table tbody tr {
          display: block;
          border: 1px solid #dee2e6;
          border-radius: 8px;
          margin-bottom: 15px;
          padding: 15px;
          background: white;
        }
        
        .mobile-table-view .table tbody td {
          display: block;
          text-align: left;
          border: none;
          padding: 5px 0;
        }
        
        .mobile-table-view .table tbody td:before {
          content: attr(data-label) ": ";
          font-weight: bold;
          color: #666;
        }
        
        /* Optimize charts further */
        canvas {
          max-height: 200px !important;
        }
        
        /* Better mobile navigation */
        .sidebar {
          font-size: 14px;
        }
        
        .nav-link {
          padding: 10px 12px;
        }
        
        .nav-link span {
          font-size: 14px;
        }
        
        /* Optimize badges and indicators */
        .badge {
          font-size: 10px;
          padding: 4px 8px;
        }
        
        /* Better form layout */
        .form-label {
          font-size: 14px;
          font-weight: 600;
          margin-bottom: 8px;
        }
        
        /* Optimize progress bars */
        .progress {
          height: 8px;
          border-radius: 4px;
        }
        
        /* Improve card layouts */
        .card-header {
          padding: 12px 15px;
        }
        
        .card-body {
          padding: 15px;
        }
        
        .card-title {
          font-size: 1.1rem;
          margin-bottom: 10px;
        }
      }
      
      /* Landscape phone orientation */
      @media (max-width: 767.98px) and (orientation: landscape) {
        .sidebar {
          transform: translateX(-100%);
        }
        
        .main-content {
          margin-left: 0;
          padding-left: 15px;
        }
        
        /* Optimize dashboard for landscape */
        .stat-card {
          padding: 15px;
          margin-bottom: 10px;
        }
        
        .stat-content h3 {
          font-size: 1.2rem;
        }
      }
      
      /* PWA and fullscreen optimizations */
      @media (display-mode: standalone) {
        body {
          padding-top: env(safe-area-inset-top);
          padding-bottom: env(safe-area-inset-bottom);
        }
        
        .mobile-nav {
          top: env(safe-area-inset-top);
        }
      }
      
      /* High DPI displays (Retina) optimizations */
      @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
        .stat-icon, .nav-link i, .btn i {
          -webkit-font-smoothing: antialiased;
          -moz-osx-font-smoothing: grayscale;
        }
        
        /* Crisper borders and shadows on high DPI */
        .card, .btn, .form-control {
          box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        }
      }
      
      /* Print styles for financial reports */
      @media print {
        .sidebar, .mobile-nav, .header-actions, .btn {
          display: none !important;
        }
        
        .main-content {
          margin-left: 0;
          width: 100%;
        }
        
        .card {
          border: 1px solid #000;
          break-inside: avoid;
        }
        
        .page-title {
          font-size: 18pt;
          font-weight: bold;
        }
        
        .table {
          font-size: 10pt;
        }
        
        .financial-statement, .cost-breakdown-table {
          page-break-inside: avoid;
        }
      }
    </style>
  </head>

  <body>
    <!-- Mobile Navigation Header -->
    <nav class="mobile-nav d-lg-none">
      <div class="mobile-nav-content">
        <button class="mobile-menu-toggle" id="mobileMenuToggle">
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
        </button>
        
        <div class="mobile-brand">
          <i class="bi bi-droplet-fill me-2"></i>
          <span class="brand-text">MilkyWay</span>
        </div>
        
        <div class="mobile-user-menu">
          <% if current_user %>
            <div class="dropdown">
              <button class="btn btn-sm mobile-user-btn" type="button" data-bs-toggle="dropdown">
                <i class="bi bi-person-circle"></i>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><span class="dropdown-header">üëã <%= current_user.first_name %></span></li>
                <li><hr class="dropdown-divider"></li>
                <li><%= link_to "üö™ Logout", logout_path, method: :delete, class: "dropdown-item" %></li>
              </ul>
            </div>
          <% end %>
        </div>
      </div>
    </nav>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobileOverlay"></div>

    <!-- Loading Screen -->
    <div id="loading-screen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary-gradient); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; color: white;">
      <div class="spinner-border text-light mb-3" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
      </div>
      <h4>üåå MilkyWay Farm Management</h4>
      <p class="text-light opacity-75">Loading your dashboard...</p>
    </div>

    <div class="wrapper d-flex">
      <!-- Enhanced Sidebar -->
      <nav class="sidebar" id="sidebar">
        <div class="sidebar-header d-flex align-items-center justify-content-between p-3">
          <div class="d-flex align-items-center">
            <div class="sidebar-brand d-flex align-items-center justify-content-center me-3">
              <i class="bi bi-droplet-fill text-white fs-4"></i>
            </div>
            <div>
              <h5 class="mb-0 text-white fw-bold" style="font-size: 1.1rem; line-height: 1.2;">
                üåå MilkyWay Farm
              </h5>
              <% if current_user %>
                <small class="text-light opacity-75" style="font-size: 0.8rem;">
                  <%= Time.current.strftime("%l:%M %p") %> ‚Ä¢ 
                  <span class="badge bg-light text-dark"><%= current_user.role.humanize %></span>
                </small>
              <% else %>
                <small class="text-light opacity-75" style="font-size: 0.8rem;">
                  <%= Time.current.strftime("%l:%M %p") %> ‚Ä¢ 
                  <span class="badge bg-light text-dark">Guest</span>
                </small>
              <% end %>
            </div>
          </div>
          <% if current_user %>
            <div class="dropdown">
              <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="bi bi-person-circle"></i>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><span class="dropdown-header">üëã <%= current_user.first_name %></span></li>
                <li><hr class="dropdown-divider"></li>
                <li><%= link_to "üö™ Logout", logout_path, method: :delete, class: "dropdown-item" %></li>
              </ul>
            </div>
          <% end %>
        </div>
        
        <div class="sidebar-menu p-3">
          <!-- Quick Search -->
          <div class="mb-4">
            <div class="position-relative">
              <input type="text" 
                     class="form-control form-control-sm bg-white bg-opacity-20 border-0 text-white" 
                     placeholder="üîç Quick Search..." 
                     id="quickSearch"
                     style="padding-left: 2.5rem;">
              <i class="bi bi-search position-absolute" 
                 style="left: 0.75rem; top: 50%; transform: translateY(-50%); color: rgba(255,255,255,0.7);"></i>
            </div>
            <div id="searchResults" class="mt-2 d-none">
              <!-- Search results will appear here -->
            </div>
          </div>
          
          <div class="mb-4">
            <h6 class="sidebar-heading">üè† MAIN</h6>
            <ul class="nav nav-pills flex-column">
              <li class="nav-item">
                <%= link_to root_path, class: "nav-link #{'active' if current_page?(root_path)}" do %>
                  <i class="bi bi-speedometer2 me-2"></i>
                  <span>Dashboard</span>
                <% end %>
              </li>
            </ul>
          </div>
          
          <div class="mb-4">
            <h6 class="sidebar-heading">üêÑ LIVESTOCK</h6>
            <ul class="nav nav-pills flex-column">
              <li class="nav-item">
                <%= link_to farms_path, class: "nav-link #{'active' if controller_name == 'farms'}" do %>
                  <i class="bi bi-house-door me-2"></i>
                  <span>Farms</span>
                <% end %>
              </li>
              
              <!-- Animals Section with Collapsible Submenu -->
              <li class="nav-item">
                <div class="nav-link animals-menu-toggle #{'active' if %w[cows calves animal_sales].include?(controller_name)}" 
                     data-bs-toggle="collapse" 
                     data-bs-target="#animalsSubmenu" 
                     aria-expanded="<%= %w[cows calves animal_sales].include?(controller_name) ? 'true' : 'false' %>"
                     style="cursor: pointer;">
                  <i class="bi bi-heart-fill me-2"></i>
                  <span>Animals</span>
                  <i class="bi bi-chevron-down ms-auto submenu-arrow <%= 'rotated' if %w[cows calves animal_sales].include?(controller_name) %>"></i>
                </div>
                
                <div class="collapse <%= 'show' if %w[cows calves animal_sales].include?(controller_name) %>" id="animalsSubmenu">
                  <ul class="nav nav-pills flex-column ms-3 mt-2">
                    <li class="nav-item">
                      <%= link_to cows_path, class: "nav-link nav-link-sub #{'active' if controller_name == 'cows'}" do %>
                        <i class="bi bi-circle-fill me-2" style="font-size: 0.5rem;"></i>
                        <span>üêÑ Adult Cows</span>
                        <% if current_user %>
                          <span class="badge bg-primary bg-opacity-75 ms-auto">
                            <%= Cow.adult_cows.where(farm: current_user.accessible_farms).count %>
                          </span>
                        <% end %>
                      <% end %>
                    </li>
                    <li class="nav-item">
                      <%= link_to calves_path, class: "nav-link nav-link-sub #{'active' if controller_name == 'calves'}" do %>
                        <i class="bi bi-circle-fill me-2" style="font-size: 0.5rem;"></i>
                        <span>üêÆ Calves</span>
                        <% if current_user %>
                          <span class="badge bg-success bg-opacity-75 ms-auto">
                            <%= Cow.calves.where(farm: current_user.accessible_farms).count %>
                          </span>
                        <% end %>
                      <% end %>
                    </li>
                  </ul>
                </div>
              </li>
              
              <!-- Animal Management Dashboard -->
              <li class="nav-item">
                <%= link_to animal_management_dashboard_path, class: "nav-link #{'active' if controller_name == 'animal_management' || %w[health_records breeding_records vaccination_records].include?(controller_name)}" do %>
                  <i class="bi bi-heart-pulse-fill me-2"></i>
                  <span>Animal Management</span>
                  <% 
                    health_alerts = begin
                      Cow.active.select { |c| c.requires_health_attention? }.count rescue 0
                    end
                    vaccination_alerts = begin
                      VaccinationRecord.overdue.count rescue 0
                    end
                    breeding_alerts = begin
                      BreedingRecord.overdue.count rescue 0
                    end
                    total_alerts = health_alerts + vaccination_alerts + breeding_alerts
                  %>
                  <% if total_alerts > 0 %>
                    <span class="badge bg-danger ms-auto pulse-badge"><%= total_alerts %></span>
                  <% else %>
                    <span class="badge bg-success ms-auto">‚úì</span>
                  <% end %>
                <% end %>
              </li>
              
              <!-- Real-time Alerts System -->
              <li class="nav-item">
                <%= link_to alerts_path, class: "nav-link #{'active' if controller_name == 'alerts'}" do %>
                  <i class="bi bi-bell-fill me-2"></i>
                  <span>System Alerts</span>
                  <% 
                    begin
                      # Quick count for navigation badge
                      critical_count = Cow.joins(:health_records)
                                         .where(health_records: { health_status: 'sick', recorded_at: 7.days.ago..Time.current })
                                         .distinct.count +
                                      HealthRecord.where('temperature > ? AND recorded_at > ?', 39.5, 24.hours.ago).count +
                                      VaccinationRecord.where('next_due_date < ?', Date.current).count
                      
                      warning_count = BreedingRecord.where(expected_due_date: Date.current..7.days.from_now).count +
                                     HealthRecord.joins(:cow)
                                               .where('weight < ? AND recorded_at > ?', 350, 7.days.ago)
                                               .where(cows: { status: 'active' }).count
                      
                      total_alert_count = critical_count + warning_count
                    rescue => e
                      total_alert_count = 0
                    end
                  %>
                  <% if total_alert_count > 0 %>
                    <span class="badge bg-danger ms-auto notification-pulse">
                      <%= total_alert_count > 99 ? '99+' : total_alert_count %>
                    </span>
                  <% else %>
                    <span class="badge bg-light text-success ms-auto">
                      <i class="bi bi-check-circle-fill"></i>
                    </span>
                  <% end %>
                <% end %>
              </li>
            </ul>
          </div>
          
          <div class="mb-4">
            <h6 class="sidebar-heading">üìä PRODUCTION</h6>
            <ul class="nav nav-pills flex-column">
              <li class="nav-item">
                <%= link_to production_records_path, class: "nav-link #{'active' if controller_name == 'production_records' && action_name == 'index'}" do %>
                  <i class="bi bi-clipboard-data me-2"></i>
                  <span>Production Records</span>
                  <span class="badge bg-info ms-auto">üêÑ Analytics</span>
                <% end %>
              </li>
              <li class="nav-item">
                <%= link_to enhanced_bulk_entry_production_records_path, class: "nav-link #{'active' if controller_name == 'production_records' && action_name == 'enhanced_bulk_entry'}" do %>
                  <i class="bi bi-grid-3x3 me-2"></i>
                  <span>Production Entry</span>
                  <span class="badge bg-primary ms-auto">Enhanced</span>
                <% end %>
              </li>
            </ul>
          </div>
          
          <!-- Quick Actions Section -->
          <div class="mb-4">
            <h6 class="sidebar-heading">‚ö° QUICK ACTIONS</h6>
            <div class="row g-2">
              <div class="col-6">
                <%= link_to new_health_record_path, class: "btn btn-outline-light btn-sm w-100", title: "Add Health Record" do %>
                  <i class="bi bi-plus-circle"></i>
                  <small class="d-block">Health</small>
                <% end %>
              </div>
              <div class="col-6">
                <%= link_to new_breeding_record_path, class: "btn btn-outline-light btn-sm w-100", title: "Add Breeding Record" do %>
                  <i class="bi bi-heart-fill"></i>
                  <small class="d-block">Breeding</small>
                <% end %>
              </div>
              <div class="col-6">
                <%= link_to new_vaccination_record_path, class: "btn btn-outline-light btn-sm w-100", title: "Add Vaccination" do %>
                  <i class="bi bi-shield-check"></i>
                  <small class="d-block">Vaccine</small>
                <% end %>
              </div>
              <div class="col-6">
                <%= link_to enhanced_bulk_entry_production_records_path, class: "btn btn-outline-light btn-sm w-100", title: "Production Entry" do %>
                  <i class="bi bi-speedometer"></i>
                  <small class="d-block">Milk</small>
                <% end %>
              </div>
            </div>
          </div>
          
          <div class="mb-4">
            <h6 class="sidebar-heading">üìà REPORTS</h6>
            <ul class="nav nav-pills flex-column">
              <li class="nav-item">
                <%= link_to financial_reports_path, class: "nav-link #{'active' if controller_name == 'financial_reports'}" do %>
                  <i class="bi bi-graph-up-arrow me-2"></i>
                  <span>Financial Dashboard</span>
                  <span class="badge bg-success ms-auto">New</span>
                <% end %>
              </li>
              <li class="nav-item">
                <%= link_to profit_loss_financial_reports_path, class: "nav-link #{'active' if controller_name == 'financial_reports' && action_name == 'profit_loss'}" do %>
                  <i class="bi bi-file-earmark-bar-graph me-2"></i>
                  <span>Profit & Loss</span>
                <% end %>
              </li>
              <li class="nav-item">
                <%= link_to cost_analysis_financial_reports_path, class: "nav-link #{'active' if controller_name == 'financial_reports' && action_name == 'cost_analysis'}" do %>
                  <i class="bi bi-pie-chart-fill me-2"></i>
                  <span>Cost Analysis</span>
                <% end %>
              </li>
              <li class="nav-item">
                <%= link_to roi_report_financial_reports_path, class: "nav-link #{'active' if controller_name == 'financial_reports' && action_name == 'roi_report'}" do %>
                  <i class="bi bi-graph-up-arrow me-2"></i>
                  <span>ROI Analytics</span>
                <% end %>
              </li>
              <li class="nav-item">
                <%= link_to sales_records_path, class: "nav-link #{'active' if controller_name == 'sales_records'}" do %>
                  <i class="bi bi-currency-dollar me-2"></i>
                  <span>Sales Records</span>
                <% end %>
              </li>
              <li class="nav-item">
                <%= link_to animal_sales_path, class: "nav-link #{'active' if controller_name == 'animal_sales'}" do %>
                  <i class="bi bi-bank2 me-2"></i>
                  <span>Animal Sales</span>
                <% end %>
              </li>
              <% if current_user&.can_view_reports? %>
                <li class="nav-item">
                  <%= link_to reports_path, class: "nav-link #{'active' if controller_name == 'reports'}" do %>
                    <i class="bi bi-bar-chart-line me-2"></i>
                    <span>Analytics</span>
                  <% end %>
                </li>
              <% end %>
            </ul>
          </div>
          
          <% if current_user&.can_manage_farm? %>
            <div class="mb-4">
              <h6 class="sidebar-heading">‚öôÔ∏è MANAGEMENT</h6>
              <ul class="nav nav-pills flex-column">
                <li class="nav-item">
                  <%= link_to users_path, class: "nav-link #{'active' if controller_name == 'users'}" do %>
                    <i class="bi bi-people-fill me-2"></i>
                    <span>Team</span>
                  <% end %>
                </li>
              </ul>
            </div>
          <% end %>
          
          <!-- Quick Stats in Sidebar -->
          <div class="mt-auto pt-4">
            <div class="bg-white bg-opacity-10 rounded p-3">
              <h6 class="text-white mb-2">
                <i class="bi bi-calendar3 me-1"></i>
                Today's Summary
              </h6>
              <div class="d-flex justify-content-between text-light mb-1">
                <small>Active Cows:</small>
                <small class="fw-bold"><%= Cow.active.count %></small>
              </div>
              <div class="d-flex justify-content-between text-light mb-2">
                <small>Today's Production:</small>
                <small class="fw-bold"><%= number_with_precision(ProductionRecord.where(production_date: Date.current).sum(:total_production), precision: 1) %>L</small>
              </div>
              
              <!-- Health Alerts Summary -->
              <% 
                health_alerts_count = begin
                  Cow.active.select { |c| c.requires_health_attention? }.count rescue 0
                end
                vaccination_due_count = begin
                  VaccinationRecord.due_soon.count rescue 0
                end
                breeding_due_count = begin
                  BreedingRecord.due_soon.count rescue 0
                end
              %>
              
              <div class="border-top border-light border-opacity-25 pt-2 mt-2">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <small><i class="bi bi-exclamation-triangle me-1"></i>Health Alerts:</small>
                  <% if health_alerts_count > 0 %>
                    <small class="badge bg-danger"><%= health_alerts_count %></small>
                  <% else %>
                    <small class="text-success"><i class="bi bi-check-circle"></i></small>
                  <% end %>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <small><i class="bi bi-calendar-check me-1"></i>Due Vaccines:</small>
                  <% if vaccination_due_count > 0 %>
                    <small class="badge bg-warning"><%= vaccination_due_count %></small>
                  <% else %>
                    <small class="text-success"><i class="bi bi-check-circle"></i></small>
                  <% end %>
                </div>
                
                <div class="d-flex justify-content-between align-items-center">
                  <small><i class="bi bi-heart me-1"></i>Expected Births:</small>
                  <% if breeding_due_count > 0 %>
                    <small class="badge bg-info"><%= breeding_due_count %></small>
                  <% else %>
                    <small class="text-light opacity-75">None</small>
                  <% end %>
                </div>
              </div>
              
              <!-- Keyboard Shortcuts Info -->
              <div class="border-top border-light border-opacity-25 pt-2 mt-2">
                <small class="text-light opacity-75">
                  <i class="bi bi-keyboard me-1"></i>
                  Press <kbd class="bg-white text-dark">Alt + M</kbd> for Animal Management
                </small>
              </div>
            </div>
          </div>
        </div>
      </nav>
      
      <!-- Enhanced Main Content -->
      <div class="main-content">
        <!-- Modern Top Header -->
        <div class="top-header">
          <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center h-100">
              <div class="d-flex align-items-center">
                <button class="btn btn-outline-secondary me-3 d-lg-none" id="sidebarToggle">
                  <i class="bi bi-list"></i>
                </button>
                <div>
                  <h4 class="mb-0 page-title">
                    <%= content_for?(:title) ? yield(:title) : controller_name.humanize %>
                  </h4>
                  <!-- Smart Breadcrumb Navigation -->
                  <nav aria-label="breadcrumb" class="mt-1">
                    <ol class="breadcrumb breadcrumb-sm mb-0" style="font-size: 0.8rem;">
                      <li class="breadcrumb-item">
                        <%= link_to root_path, class: "text-decoration-none text-muted" do %>
                          <i class="bi bi-house-door me-1"></i>Home
                        <% end %>
                      </li>
                      <% case controller_name %>
                      <% when 'animal_management' %>
                        <li class="breadcrumb-item">
                          <span class="text-muted">Livestock</span>
                        </li>
                        <li class="breadcrumb-item active text-primary" aria-current="page">
                          <i class="bi bi-heart-pulse-fill me-1"></i>Animal Management
                        </li>
                      <% when 'health_records' %>
                        <li class="breadcrumb-item">
                          <%= link_to animal_management_dashboard_path, class: "text-decoration-none text-muted" do %>
                            Animal Management
                          <% end %>
                        </li>
                        <li class="breadcrumb-item active text-primary" aria-current="page">
                          <i class="bi bi-heart-pulse me-1"></i>Health Records
                        </li>
                      <% when 'breeding_records' %>
                        <li class="breadcrumb-item">
                          <%= link_to animal_management_dashboard_path, class: "text-decoration-none text-muted" do %>
                            Animal Management
                          <% end %>
                        </li>
                        <li class="breadcrumb-item active text-primary" aria-current="page">
                          <i class="bi bi-heart-fill me-1"></i>Breeding Records
                        </li>
                      <% when 'vaccination_records' %>
                        <li class="breadcrumb-item">
                          <%= link_to animal_management_dashboard_path, class: "text-decoration-none text-muted" do %>
                            Animal Management
                          <% end %>
                        </li>
                        <li class="breadcrumb-item active text-primary" aria-current="page">
                          <i class="bi bi-shield-check me-1"></i>Vaccination Records
                        </li>
                      <% when 'cows' %>
                        <li class="breadcrumb-item">
                          <span class="text-muted">Livestock</span>
                        </li>
                        <li class="breadcrumb-item active text-primary" aria-current="page">
                          <i class="bi bi-heart-fill me-1"></i>Cows
                        </li>
                      <% when 'production_records' %>
                        <li class="breadcrumb-item">
                          <span class="text-muted">Production</span>
                        </li>
                        <li class="breadcrumb-item active text-primary" aria-current="page">
                          <i class="bi bi-clipboard-data me-1"></i>
                          <%= action_name == 'enhanced_bulk_entry' ? 'Production Entry' : 'Production Records' %>
                        </li>
                      <% else %>
                        <li class="breadcrumb-item active text-primary" aria-current="page">
                          <%= controller_name.humanize %>
                        </li>
                      <% end %>
                    </ol>
                  </nav>
                </div>
                <% if controller_name == 'production_records' && (action_name == 'bulk_entry' || action_name == 'enhanced_bulk_entry') %>
                  <span class="badge bg-primary ms-3">Smart Entry</span>
                <% end %>
              </div>
              <div class="d-flex align-items-center">
                <!-- Notification Center -->
                <div class="dropdown me-3">
                  <button class="btn btn-outline-primary btn-sm position-relative" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-bell-fill"></i>
                    <%
                      # Calculate total notifications
                      health_alerts_count = begin
                        Cow.active.select { |c| c.requires_health_attention? }.count rescue 0
                      end
                      vaccination_due_count = begin
                        VaccinationRecord.due_soon.count rescue 0
                      end
                      breeding_due_count = begin
                        BreedingRecord.due_soon.count rescue 0
                      end
                      total_notifications = health_alerts_count + vaccination_due_count + breeding_due_count
                    %>
                    <% if total_notifications > 0 %>
                      <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                        <%= total_notifications > 9 ? '9+' : total_notifications %>
                      </span>
                    <% end %>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end" style="min-width: 300px;">
                    <li><h6 class="dropdown-header">
                      <i class="bi bi-bell me-2"></i>Notifications
                      <% if total_notifications > 0 %>
                        <span class="badge bg-danger ms-2"><%= total_notifications %></span>
                      <% end %>
                    </h6></li>
                    <% if total_notifications > 0 %>
                      <% if health_alerts_count > 0 %>
                        <li>
                          <%= link_to health_records_path, class: "dropdown-item d-flex align-items-center" do %>
                            <i class="bi bi-heart-pulse text-danger me-2"></i>
                            <div>
                              <div class="fw-medium">Health Alerts</div>
                              <small class="text-muted"><%= health_alerts_count %> animals need attention</small>
                            </div>
                          <% end %>
                        </li>
                      <% end %>
                      <% if vaccination_due_count > 0 %>
                        <li>
                          <%= link_to vaccination_records_path, class: "dropdown-item d-flex align-items-center" do %>
                            <i class="bi bi-shield-exclamation text-warning me-2"></i>
                            <div>
                              <div class="fw-medium">Vaccinations Due</div>
                              <small class="text-muted"><%= vaccination_due_count %> vaccinations needed</small>
                            </div>
                          <% end %>
                        </li>
                      <% end %>
                      <% if breeding_due_count > 0 %>
                        <li>
                          <%= link_to breeding_records_path, class: "dropdown-item d-flex align-items-center" do %>
                            <i class="bi bi-calendar-heart text-info me-2"></i>
                            <div>
                              <div class="fw-medium">Expected Births</div>
                              <small class="text-muted"><%= breeding_due_count %> cows due soon</small>
                            </div>
                          <% end %>
                        </li>
                      <% end %>
                      <li><hr class="dropdown-divider"></li>
                      <li>
                        <%= link_to animal_management_dashboard_path, class: "dropdown-item text-center text-primary" do %>
                          <i class="bi bi-arrow-right-circle me-1"></i>View All in Animal Management
                        <% end %>
                      </li>
                    <% else %>
                      <li class="dropdown-item-text text-center py-3">
                        <i class="bi bi-check-circle text-success fs-2"></i>
                        <div class="mt-2">All systems normal</div>
                        <small class="text-muted">No alerts at this time</small>
                      </li>
                    <% end %>
                  </ul>
                </div>
                
                <% if current_user %>
                  <div class="me-3 text-end">
                    <small class="text-muted d-block">Welcome back,</small>
                    <strong class="text-primary"><%= current_user.first_name %> <%= current_user.last_name %></strong>
                  </div>
                  <div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                    <i class="bi bi-person-fill text-primary"></i>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Enhanced Flash Messages -->
        <div class="container-fluid px-4 pt-3">
          <% if notice %>
            <div class="alert alert-success alert-dismissible fade show" role="alert">
              <div class="d-flex align-items-center">
                <i class="bi bi-check-circle-fill me-2 fs-5"></i>
                <div>
                  <strong>Success!</strong>
                  <%= notice %>
                </div>
              </div>
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          <% end %>
          
          <% if alert %>
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              <div class="d-flex align-items-center">
                <i class="bi bi-exclamation-triangle-fill me-2 fs-5"></i>
                <div>
                  <strong>Alert!</strong>
                  <%= alert %>
                </div>
              </div>
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          <% end %>
        </div>

        <!-- Enhanced Page Content -->
        <main class="container-fluid p-4">
          <%= yield %>
        </main>
        
        <!-- Floating Action Button -->
        <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1000;">
          <div class="dropup">
            <button class="btn btn-primary rounded-circle shadow-lg" type="button" data-bs-toggle="dropdown" style="width: 56px; height: 56px;">
              <i class="bi bi-plus-lg fs-4"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end mb-2">
              <li><h6 class="dropdown-header">Quick Actions</h6></li>
              <li><%= link_to new_production_record_path, class: "dropdown-item" do %>
                <i class="bi bi-clipboard-plus me-2"></i>Add Production Record
              <% end %></li>
              <li><%= link_to enhanced_bulk_entry_production_records_path, class: "dropdown-item" do %>
                <i class="bi bi-grid-3x3 me-2"></i>Production Entry
              <% end %></li>
              <% if current_user&.can_manage_farm? %>
                <li><hr class="dropdown-divider"></li>
                <li><%= link_to new_cow_path, class: "dropdown-item" do %>
                  <i class="bi bi-heart-fill me-2"></i>Add New Cow
                <% end %></li>
              <% end %>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Keyboard Shortcuts Script -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Quick Search Functionality
        const quickSearch = document.getElementById('quickSearch');
        const searchResults = document.getElementById('searchResults');
        
        // Search data for navigation items
        const searchData = [
          { name: 'Dashboard', url: '<%= root_path %>', icon: 'speedometer2', category: 'Main' },
          { name: 'Animal Management', url: '<%= animal_management_dashboard_path %>', icon: 'heart-pulse-fill', category: 'Livestock' },
          { name: 'Farms', url: '<%= farms_path %>', icon: 'house-door', category: 'Livestock' },
          { name: 'Cows', url: '<%= cows_path %>', icon: 'heart-fill', category: 'Animals' },
          { name: 'Calves', url: '<%= calves_path %>', icon: 'heart-fill', category: 'Animals' },
          { name: 'Health Records', url: '<%= health_records_path %>', icon: 'heart-pulse', category: 'Health' },
          { name: 'Breeding Records', url: '<%= breeding_records_path %>', icon: 'heart-fill', category: 'Breeding' },
          { name: 'Vaccination Records', url: '<%= vaccination_records_path %>', icon: 'shield-check', category: 'Health' },
          { name: 'Production Records', url: '<%= production_records_path %>', icon: 'clipboard-data', category: 'Production' },
          { name: 'Production Entry', url: '<%= enhanced_bulk_entry_production_records_path %>', icon: 'grid-3x3', category: 'Production' },
          { name: 'Sales Records', url: '<%= sales_records_path %>', icon: 'currency-dollar', category: 'Reports' },
          { name: 'Animal Sales', url: '<%= animal_sales_path %>', icon: 'bank2', category: 'Reports' }
        ];
        
        if (quickSearch) {
          quickSearch.addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase().trim();
            
            if (query.length < 2) {
              searchResults.classList.add('d-none');
              return;
            }
            
            const matches = searchData.filter(item => 
              item.name.toLowerCase().includes(query) || 
              item.category.toLowerCase().includes(query)
            ).slice(0, 5);
            
            if (matches.length > 0) {
              searchResults.innerHTML = matches.map(item => `
                <div class="search-result-item" onclick="window.location.href='${item.url}'" style="cursor: pointer; padding: 0.5rem; border-radius: 0.375rem; margin-bottom: 0.25rem; background: rgba(255,255,255,0.1); transition: all 0.2s;">
                  <i class="bi bi-${item.icon} me-2"></i>
                  <span class="text-white">${item.name}</span>
                  <small class="text-light opacity-75 ms-auto d-block">${item.category}</small>
                </div>
              `).join('');
              
              searchResults.classList.remove('d-none');
              
              // Add hover effects
              searchResults.querySelectorAll('.search-result-item').forEach(item => {
                item.addEventListener('mouseenter', function() {
                  this.style.background = 'rgba(102, 126, 234, 0.3)';
                });
                item.addEventListener('mouseleave', function() {
                  this.style.background = 'rgba(255,255,255,0.1)';
                });
              });
            } else {
              searchResults.innerHTML = `
                <div class="text-center py-2">
                  <small class="text-light opacity-75">No results found</small>
                </div>
              `;
              searchResults.classList.remove('d-none');
            }
          });
          
          // Hide results when clicking outside
          document.addEventListener('click', function(e) {
            if (!quickSearch.contains(e.target) && !searchResults.contains(e.target)) {
              searchResults.classList.add('d-none');
            }
          });
          
          // Clear search on Escape
          quickSearch.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
              this.value = '';
              searchResults.classList.add('d-none');
            }
          });
        }
        
        // Keyboard shortcuts for efficient navigation
        document.addEventListener('keydown', function(e) {
          // Alt + M for Animal Management
          if (e.altKey && e.key === 'm') {
            e.preventDefault();
            window.location.href = '<%= animal_management_dashboard_path %>';
            return;
          }
          
          // Alt + D for Dashboard
          if (e.altKey && e.key === 'd') {
            e.preventDefault();
            window.location.href = '<%= root_path %>';
            return;
          }
          
          // Alt + P for Production Entry
          if (e.altKey && e.key === 'p') {
            e.preventDefault();
            window.location.href = '<%= enhanced_bulk_entry_production_records_path %>';
            return;
          }
          
          // Alt + C for Cows
          if (e.altKey && e.key === 'c') {
            e.preventDefault();
            window.location.href = '<%= cows_path %>';
            return;
          }
          
          // Alt + H for Health Records (when on animal management)
          if (e.altKey && e.key === 'h') {
            e.preventDefault();
            window.location.href = '<%= health_records_path %>';
            return;
          }
        });
        
        // Show keyboard shortcuts help on Alt + ?
        document.addEventListener('keydown', function(e) {
          if (e.altKey && e.key === '?') {
            e.preventDefault();
            showKeyboardShortcuts();
          }
        });
        
        function showKeyboardShortcuts() {
          const shortcutsModal = `
            <div class="modal fade" id="shortcutsModal" tabindex="-1">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-keyboard me-2"></i>Keyboard Shortcuts</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <div class="row g-3">
                      <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
                          <span><kbd class="bg-primary text-white">Alt + D</kbd></span>
                          <span>Dashboard</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
                          <span><kbd class="bg-primary text-white">Alt + M</kbd></span>
                          <span>Animal Management</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
                          <span><kbd class="bg-primary text-white">Alt + C</kbd></span>
                          <span>Cows</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
                          <span><kbd class="bg-primary text-white">Alt + P</kbd></span>
                          <span>Production Entry</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                          <span><kbd class="bg-primary text-white">Alt + H</kbd></span>
                          <span>Health Records</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
          
          // Remove existing modal if any
          const existingModal = document.getElementById('shortcutsModal');
          if (existingModal) {
            existingModal.remove();
          }
          
          // Add modal to DOM
          document.body.insertAdjacentHTML('beforeend', shortcutsModal);
          
          // Show modal
          const modal = new bootstrap.Modal(document.getElementById('shortcutsModal'));
          modal.show();
          
          // Remove modal from DOM when hidden
          document.getElementById('shortcutsModal').addEventListener('hidden.bs.modal', function() {
            this.remove();
          });
        }
      });
    </script>
    
    
    <!-- Enhanced Sidebar Toggle Script -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Hide loading screen
        const loadingScreen = document.getElementById('loading-screen');
        setTimeout(() => {
          loadingScreen.style.opacity = '0';
          setTimeout(() => {
            loadingScreen.style.display = 'none';
          }, 500);
        }, 1000);
        
        // Mobile Navigation
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const mobileOverlay = document.getElementById('mobileOverlay');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const mainContent = document.querySelector('.main-content');
        
        // Mobile menu toggle functionality
        if (mobileMenuToggle) {
          mobileMenuToggle.addEventListener('click', function(e) {
            e.preventDefault();
            try {
              mobileMenuToggle.classList.toggle('active');
              sidebar.classList.toggle('show');
              mobileOverlay.classList.toggle('show');
              document.body.style.overflow = sidebar.classList.contains('show') ? 'hidden' : '';
            } catch (error) {
              console.error('Mobile menu toggle error:', error);
            }
          });
        }
        
        // Close mobile menu when overlay is clicked
        if (mobileOverlay) {
          mobileOverlay.addEventListener('click', function() {
            try {
              closeMobileMenu();
            } catch (error) {
              console.error('Mobile overlay click error:', error);
            }
          });
        }
        
        // Close mobile menu when window is resized to desktop
        window.addEventListener('resize', function() {
          if (window.innerWidth > 991.98) {
            closeMobileMenu();
          }
        });
        
        function closeMobileMenu() {
          try {
            if (mobileMenuToggle) {
              mobileMenuToggle.classList.remove('active');
            }
            if (sidebar) {
              sidebar.classList.remove('show');
            }
            if (mobileOverlay) {
              mobileOverlay.classList.remove('show');
            }
            document.body.style.overflow = '';
          } catch (error) {
            console.error('Close mobile menu error:', error);
          }
        }
        
        // Close mobile menu when clicking sidebar links
        const sidebarLinks = sidebar.querySelectorAll('.nav-link');
        sidebarLinks.forEach(link => {
          link.addEventListener('click', function() {
            if (window.innerWidth <= 991.98) {
              setTimeout(closeMobileMenu, 150);
            }
          });
        });
        
        // Desktop sidebar toggle functionality
        if (sidebarToggle) {
          sidebarToggle.addEventListener('click', function() {
            if (window.innerWidth <= 992) {
              sidebar.classList.toggle('show');
            } else {
              sidebar.classList.toggle('collapsed');
              if (sidebar.classList.contains('collapsed')) {
                sidebar.style.transform = 'translateX(-100%)';
                mainContent.style.marginLeft = '0';
              } else {
                sidebar.style.transform = 'translateX(0)';
                mainContent.style.marginLeft = 'var(--sidebar-width)';
              }
            }
          });
        }
        
        // Auto-hide sidebar on mobile when clicking outside
        document.addEventListener('click', function(e) {
          if (window.innerWidth <= 992) {
            if (!sidebar.contains(e.target) && !sidebarToggle.contains(e.target)) {
              sidebar.classList.remove('show');
            }
          }
        });
        
        // Smooth animations for navigation
        const navLinks = document.querySelectorAll('.nav-link');
        navLinks.forEach(link => {
          link.addEventListener('click', function() {
            // Add loading state
            if (!this.classList.contains('active')) {
              this.style.opacity = '0.7';
              this.innerHTML += ' <span class="spinner-border spinner-border-sm ms-2"></span>';
            }
          });
        });
        
        // Enhanced tooltips for mobile
        if (window.innerWidth <= 768) {
          const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
          tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
          });
        }
      });
    </script>
    
    <!-- Debug Script -->
    <script>
      console.log('=== Chart.js Debug Info ===');
      console.log('Chart.js loaded:', typeof Chart !== 'undefined');
      console.log('Chart.js version:', typeof Chart !== 'undefined' ? Chart.version : 'Not available');
      console.log('Stimulus loaded:', typeof window.Stimulus !== 'undefined');
      console.log('DOM ready state:', document.readyState);        // Log when DOM is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
          console.log('DOM Content Loaded');
          console.log('Canvas elements found:', document.querySelectorAll('canvas[data-controller="chart"]').length);
          
          // Initialize mobile optimizations
          initializeMobileOptimizations();
        });
        
        // ============================================
        // MOBILE OPTIMIZATION JAVASCRIPT
        // ============================================
        
        function initializeMobileOptimizations() {
          // Detect if user is on mobile device
          const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
          const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
          
          if (isMobile || isTouch) {
            document.body.classList.add('mobile-device');
            
            // Initialize touch-friendly interactions
            initTouchOptimizations();
            
            // Initialize mobile table view
            initMobileTableView();
            
            // Initialize pull-to-refresh (if supported)
            initPullToRefresh();
            
            // Initialize mobile chart optimizations
            initMobileChartOptimizations();
            
            // Initialize mobile form enhancements
            initMobileFormEnhancements();
            
            // Initialize mobile navigation enhancements
            initMobileNavigationEnhancements();
          }
          
          // Initialize responsive optimizations for all devices
          initResponsiveOptimizations();
          
          // Initialize viewport meta tag management
          initViewportManagement();
        }
        
        function initTouchOptimizations() {
          // Add touch feedback to buttons and cards
          const touchElements = document.querySelectorAll('.btn, .card, .nav-link, .table-row-clickable');
          
          touchElements.forEach(element => {
            element.addEventListener('touchstart', function() {
              this.style.transform = 'scale(0.98)';
              this.style.transition = 'transform 0.1s ease';
            });
            
            element.addEventListener('touchend', function() {
              setTimeout(() => {
                this.style.transform = '';
                this.style.transition = '';
              }, 100);
            });
          });
          
          // Prevent double-tap zoom on specific elements
          const preventZoom = document.querySelectorAll('input, select, textarea, button');
          preventZoom.forEach(element => {
            element.addEventListener('touchend', function(e) {
              const now = Date.now();
              if (this.lastTouchEnd && (now - this.lastTouchEnd) <= 300) {
                e.preventDefault();
              }
              this.lastTouchEnd = now;
            });
          });
        }
        
        function initMobileTableView() {
          // Convert complex tables to mobile-friendly card layout
          const tables = document.querySelectorAll('.table-responsive .table');
          
          if (window.innerWidth <= 767) {
            tables.forEach(table => {
              const container = table.closest('.table-responsive');
              if (container) {
                container.classList.add('mobile-table-view');
                
                // Add data-label attributes for mobile view
                const headers = table.querySelectorAll('th');
                const rows = table.querySelectorAll('tbody tr');
                
                rows.forEach(row => {
                  const cells = row.querySelectorAll('td');
                  cells.forEach((cell, index) => {
                    if (headers[index]) {
                      cell.setAttribute('data-label', headers[index].textContent.trim());
                    }
                  });
                });
              }
            });
          }
        }
        
        function initPullToRefresh() {
          // Simple pull-to-refresh implementation
          let startY = 0;
          let currentY = 0;
          let isDragging = false;
          const pullThreshold = 100;
          
          document.addEventListener('touchstart', function(e) {
            if (window.scrollY === 0) {
              startY = e.touches[0].clientY;
              isDragging = true;
            }
          });
          
          document.addEventListener('touchmove', function(e) {
            if (!isDragging) return;
            
            currentY = e.touches[0].clientY;
            const pullDistance = currentY - startY;
            
            if (pullDistance > 0 && pullDistance < pullThreshold) {
              document.body.style.transform = `translateY(${pullDistance * 0.5}px)`;
              document.body.style.transition = 'none';
            }
          });
          
          document.addEventListener('touchend', function(e) {
            if (!isDragging) return;
            
            const pullDistance = currentY - startY;
            document.body.style.transform = '';
            document.body.style.transition = 'transform 0.3s ease';
            
            if (pullDistance > pullThreshold) {
              // Trigger refresh
              showToast('Refreshing data...', 'info');
              setTimeout(() => {
                window.location.reload();
              }, 500);
            }
            
            isDragging = false;
          });
        }
        
        function initMobileChartOptimizations() {
          // Optimize Chart.js for mobile
          if (typeof Chart !== 'undefined') {
            Chart.defaults.font.size = window.innerWidth < 768 ? 10 : 12;
            Chart.defaults.plugins.legend.labels.padding = window.innerWidth < 768 ? 10 : 15;
            Chart.defaults.plugins.legend.labels.boxWidth = window.innerWidth < 768 ? 12 : 16;
            
            // Add touch gesture support for chart interactions
            Chart.defaults.interaction.intersect = false;
            Chart.defaults.interaction.mode = 'index';
            
            // Optimize chart responsiveness
            Chart.defaults.responsive = true;
            Chart.defaults.maintainAspectRatio = false;
          }
        }
        
        function initMobileFormEnhancements() {
          // Auto-scroll to focused input to avoid keyboard overlay
          const inputs = document.querySelectorAll('input, select, textarea');
          
          inputs.forEach(input => {
            input.addEventListener('focus', function() {
              setTimeout(() => {
                this.scrollIntoView({
                  behavior: 'smooth',
                  block: 'center',
                  inline: 'center'
                });
              }, 300); // Delay to account for keyboard animation
            });
          });
          
          // Add input validation feedback for mobile
          inputs.forEach(input => {
            input.addEventListener('blur', function() {
              if (this.value && this.checkValidity && !this.checkValidity()) {
                this.classList.add('is-invalid');
                // Show gentle vibration feedback if available
                if (navigator.vibrate) {
                  navigator.vibrate(50);
                }
              } else {
                this.classList.remove('is-invalid');
              }
            });
          });
        }
        
        function initMobileNavigationEnhancements() {
          // Improve mobile navigation experience
          const navLinks = document.querySelectorAll('.nav-link');
          
          navLinks.forEach(link => {
            link.addEventListener('click', function(e) {
              // Add visual feedback
              this.style.backgroundColor = 'rgba(0,0,0,0.1)';
              setTimeout(() => {
                this.style.backgroundColor = '';
              }, 200);
              
              // Close mobile menu if open
              const mobileMenu = document.getElementById('mobileSidebar');
              if (mobileMenu && mobileMenu.classList.contains('show')) {
                const closeButton = mobileMenu.querySelector('.btn-close');
                if (closeButton) {
                  closeButton.click();
                }
              }
            });
          });
        }
        
        function initResponsiveOptimizations() {
          // Handle orientation changes
          window.addEventListener('orientationchange', function() {
            setTimeout(() => {
              // Refresh chart dimensions
              if (window.Chart && window.Chart.instances) {
                Object.values(window.Chart.instances).forEach(chart => {
                  chart.resize();
                });
              }
              
              // Recalculate table layouts
              initMobileTableView();
            }, 100);
          });
          
          // Handle window resize
          let resizeTimeout;
          window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
              // Optimize layout for new screen size
              if (window.innerWidth <= 767) {
                document.body.classList.add('mobile-view');
                initMobileTableView();
              } else {
                document.body.classList.remove('mobile-view');
                // Remove mobile table view classes
                document.querySelectorAll('.mobile-table-view').forEach(table => {
                  table.classList.remove('mobile-table-view');
                });
              }
            }, 250);
          });
        }
        
        function initViewportManagement() {
          // Manage viewport meta tag for optimal mobile experience
          let viewportMeta = document.querySelector('meta[name="viewport"]');
          
          if (!viewportMeta) {
            viewportMeta = document.createElement('meta');
            viewportMeta.name = 'viewport';
            document.head.appendChild(viewportMeta);
          }
          
          // Set optimal viewport configuration
          viewportMeta.content = 'width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes';
          
          // Handle iOS Safari viewport issues
          if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
            document.addEventListener('DOMContentLoaded', function() {
              setTimeout(() => {
                window.scrollTo(0, 1);
              }, 500);
            });
          }
        }
        
        // Mobile-specific utility functions
        function showToast(message, type = 'info') {
          // Create mobile-optimized toast notification
          const toast = document.createElement('div');
          toast.className = `alert alert-${type} mobile-toast`;
          toast.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            min-width: 280px;
            max-width: 90vw;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideInDown 0.3s ease;
          `;
          toast.textContent = message;
          
          document.body.appendChild(toast);
          
          setTimeout(() => {
            toast.style.animation = 'slideOutUp 0.3s ease';
            setTimeout(() => {
              if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
              }
            }, 300);
          }, 3000);
        }
        
        // Add CSS animations for mobile toasts
        if (!document.getElementById('mobile-animations')) {
          const style = document.createElement('style');
          style.id = 'mobile-animations';
          style.textContent = `
            @keyframes slideInDown {
              from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
              to { transform: translateX(-50%) translateY(0); opacity: 1; }
            }
            @keyframes slideOutUp {
              from { transform: translateX(-50%) translateY(0); opacity: 1; }
              to { transform: translateX(-50%) translateY(-100%); opacity: 0; }
            }
            .mobile-toast {
              animation: slideInDown 0.3s ease;
            }
          `;
          document.head.appendChild(style);
        }
        
        // Enhanced mobile-specific error handling
        window.addEventListener('error', function(e) {
          if (/Mobile|Android|iPhone|iPad/.test(navigator.userAgent)) {
            console.log('Mobile error detected:', e.message);
            // Show user-friendly error message for mobile users
            if (e.message.includes('Network') || e.message.includes('fetch')) {
              showToast('Connection issue detected. Please check your internet connection.', 'warning');
            }
          }
        });
        
        // Mobile performance optimizations
        if ('serviceWorker' in navigator && /Mobile|Android|iPhone|iPad/.test(navigator.userAgent)) {
          // Register service worker for mobile PWA capabilities
          window.addEventListener('load', function() {
            navigator.serviceWorker.register('/sw.js').then(function(registration) {
              console.log('SW registered: ', registration);
            }).catch(function(registrationError) {
              console.log('SW registration failed: ', registrationError);
            });
          });
        }
    </script>
  </body>
</html>
