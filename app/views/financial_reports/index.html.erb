<div class="financial-dashboard">
  <!-- Page Header -->
  <div class="page-header mb-4">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h2 class="page-title">
          <i class="bi bi-graph-up-arrow text-success"></i>
          Financial Dashboard
        </h2>
        <p class="text-muted">Comprehensive financial analysis and reporting</p>
      </div>
      <div class="header-actions">
        <div class="btn-group" role="group">
          <%= link_to "Week", financial_reports_path(period: 'week'), 
              class: "btn btn-outline-primary #{'active' if params[:period] == 'week'}" %>
          <%= link_to "Month", financial_reports_path(period: 'month'), 
              class: "btn btn-outline-primary #{'active' if params[:period] == 'month' || params[:period].blank?}" %>
          <%= link_to "Quarter", financial_reports_path(period: 'quarter'), 
              class: "btn btn-outline-primary #{'active' if params[:period] == 'quarter'}" %>
          <%= link_to "Year", financial_reports_path(period: 'year'), 
              class: "btn btn-outline-primary #{'active' if params[:period] == 'year'}" %>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Stats Overview -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="stat-card bg-success text-white">
        <div class="stat-icon">
          <i class="bi bi-currency-exchange"></i>
        </div>
        <div class="stat-content">
          <h3>KES <%= number_with_delimiter(@financial_overview[:total_revenue]) %></h3>
          <p>Total Revenue</p>
          <small class="opacity-75">
            <% revenue_change = @financial_overview[:total_revenue] - (@monthly_trend.values.last[:revenue] rescue 0) %>
            <% if revenue_change >= 0 %>
              <i class="bi bi-arrow-up"></i> +<%= number_with_delimiter(revenue_change) %>
            <% else %>
              <i class="bi bi-arrow-down"></i> <%= number_with_delimiter(revenue_change) %>
            <% end %>
          </small>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="stat-card bg-warning text-white">
        <div class="stat-icon">
          <i class="bi bi-wallet2"></i>
        </div>
        <div class="stat-content">
          <h3>KES <%= number_with_delimiter(@financial_overview[:total_expenses]) %></h3>
          <p>Total Expenses</p>
          <small class="opacity-75">Operating costs</small>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="stat-card <%= @financial_overview[:net_profit] >= 0 ? 'bg-primary' : 'bg-danger' %> text-white">
        <div class="stat-icon">
          <i class="bi bi-<%= @financial_overview[:net_profit] >= 0 ? 'graph-up' : 'graph-down' %>"></i>
        </div>
        <div class="stat-content">
          <h3>KES <%= number_with_delimiter(@financial_overview[:net_profit]) %></h3>
          <p>Net Profit</p>
          <small class="opacity-75"><%= @financial_overview[:profit_margin] %>% margin</small>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="stat-card bg-info text-white">
        <div class="stat-icon">
          <i class="bi bi-droplet"></i>
        </div>
        <div class="stat-content">
          <h3><%= @quick_stats[:production_volume] %>L</h3>
          <p>Milk Produced</p>
          <small class="opacity-75"><%= @quick_stats[:active_cows] %> active cows</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Row -->
  <div class="row mb-4">
    <!-- Financial Trend Chart -->
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-graph-up"></i>
            Financial Trend (6 Months)
          </h5>
        </div>
        <div class="card-body">
          <canvas id="financialTrendChart" height="300"></canvas>
        </div>
      </div>
    </div>

    <!-- Profit Margin Chart -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-pie-chart"></i>
            Profit Breakdown
          </h5>
        </div>
        <div class="card-body text-center">
          <canvas id="profitBreakdownChart" height="200"></canvas>
          <div class="mt-3">
            <div class="d-flex justify-content-between">
              <span>Revenue:</span>
              <strong>KES <%= number_with_delimiter(@financial_overview[:total_revenue]) %></strong>
            </div>
            <div class="d-flex justify-content-between">
              <span>Expenses:</span>
              <strong>KES <%= number_with_delimiter(@financial_overview[:total_expenses]) %></strong>
            </div>
            <hr>
            <div class="d-flex justify-content-between">
              <span>Profit Margin:</span>
              <strong class="<%= @financial_overview[:profit_margin] >= 0 ? 'text-success' : 'text-danger' %>">
                <%= @financial_overview[:profit_margin] %>%
              </strong>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="row mb-4">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-lightning"></i>
            Quick Financial Actions
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3">
              <%= link_to profit_loss_financial_reports_path, class: "btn btn-outline-success w-100 mb-2" do %>
                <i class="bi bi-file-earmark-bar-graph"></i>
                <br>Profit & Loss Statement
              <% end %>
            </div>
            <div class="col-md-3">
              <%= link_to cost_analysis_financial_reports_path, class: "btn btn-outline-warning w-100 mb-2" do %>
                <i class="bi bi-pie-chart-fill"></i>
                <br>Cost Analysis
              <% end %>
            </div>
            <div class="col-md-3">
              <%= link_to roi_report_financial_reports_path, class: "btn btn-outline-info w-100 mb-2" do %>
                <i class="bi bi-graph-up-arrow"></i>
                <br>ROI Analytics
              <% end %>
            </div>
            <div class="col-md-3">
              <a href="#" class="btn btn-outline-primary w-100 mb-2" onclick="downloadReport()">
                <i class="bi bi-download"></i>
                <br>Export Report
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Performance Indicators -->
  <div class="row">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-speedometer2"></i>
            Key Performance Indicators
          </h5>
        </div>
        <div class="card-body">
          <div class="progress-item mb-3">
            <div class="d-flex justify-content-between mb-1">
              <span>Profit Margin</span>
              <span><%= @financial_overview[:profit_margin] %>%</span>
            </div>
            <div class="progress">
              <div class="progress-bar <%= @financial_overview[:profit_margin] >= 15 ? 'bg-success' : @financial_overview[:profit_margin] >= 5 ? 'bg-warning' : 'bg-danger' %>" 
                   style="width: <%= [@financial_overview[:profit_margin], 100].min.abs %>%"></div>
            </div>
          </div>

          <div class="progress-item mb-3">
            <div class="d-flex justify-content-between mb-1">
              <span>Sales Efficiency</span>
              <span><%= ((@quick_stats[:sales_volume] / @quick_stats[:production_volume]) * 100).round(1) rescue 0 %>%</span>
            </div>
            <div class="progress">
              <div class="progress-bar bg-info" 
                   style="width: <%= [((@quick_stats[:sales_volume] / @quick_stats[:production_volume]) * 100).round(1), 100].min rescue 0 %>%"></div>
            </div>
          </div>

          <div class="progress-item mb-3">
            <div class="d-flex justify-content-between mb-1">
              <span>Daily Production Target</span>
              <span><%= @quick_stats[:avg_daily_production].round(1) %>L</span>
            </div>
            <div class="progress">
              <div class="progress-bar bg-primary" 
                   style="width: <%= [(@quick_stats[:avg_daily_production] / (@quick_stats[:active_cows] * 20)) * 100, 100].min %>%"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-exclamation-triangle"></i>
            Financial Alerts
          </h5>
        </div>
        <div class="card-body">
          <% if @financial_overview[:profit_margin] < 5 %>
            <div class="alert alert-warning">
              <i class="bi bi-exclamation-triangle"></i>
              Low profit margin detected (<%= @financial_overview[:profit_margin] %>%). Consider cost optimization.
            </div>
          <% end %>

          <% if @financial_overview[:net_profit] < 0 %>
            <div class="alert alert-danger">
              <i class="bi bi-exclamation-octagon"></i>
              Operating at a loss. Immediate action required to reduce expenses or increase revenue.
            </div>
          <% end %>

          <% if @quick_stats[:avg_daily_production] < (@quick_stats[:active_cows] * 15) %>
            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i>
              Production below expected levels. Consider reviewing animal health and nutrition.
            </div>
          <% end %>

          <% unless @financial_overview[:profit_margin] < 5 || @financial_overview[:net_profit] < 0 || @quick_stats[:avg_daily_production] < (@quick_stats[:active_cows] * 15) %>
            <div class="alert alert-success">
              <i class="bi bi-check-circle"></i>
              All financial indicators are healthy. Continue current operations.
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Charts JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Financial Trend Chart
const trendData = <%= @monthly_trend.to_json.html_safe %>;
const trendLabels = Object.keys(trendData).reverse();
const revenueData = trendLabels.map(label => trendData[label].revenue);
const expenseData = trendLabels.map(label => trendData[label].expenses);
const profitData = trendLabels.map(label => trendData[label].profit);

const ctx1 = document.getElementById('financialTrendChart').getContext('2d');
new Chart(ctx1, {
  type: 'line',
  data: {
    labels: trendLabels,
    datasets: [
      {
        label: 'Revenue',
        data: revenueData,
        borderColor: 'rgb(40, 167, 69)',
        backgroundColor: 'rgba(40, 167, 69, 0.1)',
        tension: 0.4,
        fill: false
      },
      {
        label: 'Expenses',
        data: expenseData,
        borderColor: 'rgb(255, 193, 7)',
        backgroundColor: 'rgba(255, 193, 7, 0.1)',
        tension: 0.4,
        fill: false
      },
      {
        label: 'Profit',
        data: profitData,
        borderColor: 'rgb(0, 123, 255)',
        backgroundColor: 'rgba(0, 123, 255, 0.1)',
        tension: 0.4,
        fill: true
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'top'
      }
    },
    scales: {
      y: {
        beginAtZero: true,
        ticks: {
          callback: function(value) {
            return 'KES ' + value.toLocaleString();
          }
        }
      }
    }
  }
});

// Profit Breakdown Doughnut Chart
const ctx2 = document.getElementById('profitBreakdownChart').getContext('2d');
new Chart(ctx2, {
  type: 'doughnut',
  data: {
    labels: ['Revenue', 'Expenses'],
    datasets: [{
      data: [<%= @financial_overview[:total_revenue] %>, <%= @financial_overview[:total_expenses] %>],
      backgroundColor: ['#28a745', '#ffc107'],
      borderWidth: 0
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'bottom'
      }
    }
  }
});

// Export functionality
function downloadReport() {
  // This would be implemented to generate PDF or Excel reports
  alert('Export functionality would be implemented here');
}

// Mobile optimization
if (window.innerWidth < 768) {
  // Optimize charts for mobile
  Chart.defaults.font.size = 10;
  Chart.defaults.plugins.legend.labels.padding = 10;
}
</script>

<style>
.financial-dashboard .stat-card {
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  transition: transform 0.2s;
}

.financial-dashboard .stat-card:hover {
  transform: translateY(-2px);
}

.stat-icon {
  float: right;
  font-size: 2.5rem;
  opacity: 0.8;
}

.stat-content h3 {
  margin: 0;
  font-size: 1.8rem;
  font-weight: bold;
}

.progress-item .progress {
  height: 8px;
  border-radius: 4px;
}

/* Mobile Optimizations */
@media (max-width: 768px) {
  .financial-dashboard .stat-card {
    padding: 15px;
    margin-bottom: 15px;
  }
  
  .stat-content h3 {
    font-size: 1.4rem;
  }
  
  .stat-icon {
    font-size: 2rem;
  }
  
  .header-actions .btn-group {
    flex-wrap: wrap;
  }
  
  .header-actions .btn-group .btn {
    font-size: 0.875rem;
    padding: 0.375rem 0.75rem;
  }
  
  canvas {
    max-height: 250px !important;
  }
}

@media (max-width: 576px) {
  .page-header {
    text-align: center;
  }
  
  .header-actions {
    margin-top: 15px;
    width: 100%;
  }
  
  .header-actions .btn-group {
    width: 100%;
  }
  
  .header-actions .btn {
    flex: 1;
  }
}
</style>
